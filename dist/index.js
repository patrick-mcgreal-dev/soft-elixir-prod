(()=>{var Fr=Object.defineProperty;var B=(t,e)=>{for(var n in e)Fr(t,n,{get:e[n],enumerable:!0})};function On(){let t="black",e="#f5f5f5",n="#3d3d3d",r="#929292";return{def:{appFontFamily:"monospace",headerFontFamily:"Times New Roman, serif",fontSize:"10px",color:e,backgroundColor:n,borderColor:e,borderRadius:"5px",borderThickness:"1px"},window:{bColOuterBorder:n,bColHead:n,colHead:e,bColBody:n,bColSelected:n,colSelected:e,bColToast:e,colToast:t,colPrompt:e},region:{bColBorderInActive:r,bColBorderActive:e},grid:{colGrid:e,bColGrid:n,bColBeatMarkers:r,bColActiveRow:e,colActiveRow:t,bColActiveCell:"lightgreen",colActiveCell:t,bColStepNumbers:n,bColStepNumbersDivider:e,colStepNumbers:e,bColGrab:"rgba(255, 191, 203, 0.5)",bColMute:"rgba(255, 255, 255, 0.5)",bColPlayhead:"rgba(255, 255, 255, 0.5)",bColLoopMarker:"rgba(255, 191, 203, 0.5)",bColReadOnly:"rgba(0, 0, 0, 0.3)"},meter:{colBackground:n,colBorder:e,colSafe:e,colClip:"yellow"}}}function Wr(){let t="#fdfbfb",e="rgb(240, 240, 240)",n="#00cfff",r="hotpink",a="#3d3d3d",i="lightgrey",o="rgb(221, 225, 252)";return{def:{appFontFamily:"monospace",headerFontFamily:"Times New Roman, serif",fontSize:"10px",color:a,backgroundColor:t,borderColor:a,borderRadius:"5px",borderThickness:"1px"},window:{bColOuterBorder:e,bColHead:t,colHead:a,bColBody:e,bColSelected:e,colSelected:a,bColToast:a,colToast:t,colPrompt:r},region:{bColBorderInActive:i,bColBorderActive:a},grid:{colGrid:a,bColGrid:e,bColBeatMarkers:t,bColActiveRow:a,colActiveRow:t,bColActiveCell:r,colActiveCell:t,bColStepNumbers:e,bColStepNumbersDivider:a,colStepNumbers:a,bColGrab:"rgba(163, 255, 186, .5)",bColMute:"rgba(255, 255, 255, .5)",bColPlayhead:"rgba(255, 255, 255, .5)",bColLoopMarker:"rgba(255, 252, 58, .5)",bColReadOnly:"rgba(0, 0, 0, .05)"},meter:{colBackground:e,colBorder:a,colSafe:a,colClip:"yellow"}}}function $r(){let t="white",e="#fcf5eb",n="#6879ff",r="#b8c0fe";return{def:{appFontFamily:"monospace",headerFontFamily:"Times New Roman, serif",fontSize:"10px",color:n,backgroundColor:e,borderColor:n,borderRadius:"5px",borderThickness:"1px"},window:{bColOuterBorder:e,bColHead:e,colHead:n,bColBody:e,bColSelected:e,colSelected:n,bColToast:n,colToast:t,colPrompt:n},region:{bColBorderInActive:r,bColBorderActive:n},grid:{colGrid:n,bColGrid:e,bColBeatMarkers:r,bColActiveRow:n,colActiveRow:t,bColActiveCell:"lightgreen",colActiveCell:t,bColStepNumbers:e,bColStepNumbersDivider:n,colStepNumbers:n,bColGrab:"rgba(255, 191, 203, 0.5)",bColMute:"rgba(255, 255, 255, 0.5)",bColPlayhead:"rgba(255, 255, 255, 0.5)",bColLoopMarker:"rgba(169, 215, 229, 0.5)",bColReadOnly:"rgb(221, 225, 252, 0.4)"},meter:{colBackground:e,colBorder:n,colSafe:n,colClip:"yellow"}}}function Or(){let t="white",e="#fcf5eb",n="red",r="pink";return{def:{appFontFamily:"monospace",headerFontFamily:"Times New Roman, serif",fontSize:"10px",color:n,backgroundColor:e,borderColor:n,borderRadius:"5px",borderThickness:"1px"},window:{bColOuterBorder:e,bColHead:e,colHead:n,bColBody:e,bColSelected:e,colSelected:n,bColToast:n,colToast:t,colPrompt:n},region:{bColBorderInActive:r,bColBorderActive:n},grid:{colGrid:n,bColGrid:e,bColBeatMarkers:r,bColActiveRow:n,colActiveRow:t,bColActiveCell:"#8e8aff",colActiveCell:t,bColStepNumbers:e,bColStepNumbersDivider:n,colStepNumbers:n,bColGrab:"rgba(255, 191, 203, 0.5)",bColMute:"rgba(255, 255, 255, 0.5)",bColPlayhead:"rgba(255, 255, 255, 0.5)",bColLoopMarker:"rgba(169, 215, 229, 0.5)",bColReadOnly:"rgb(221, 225, 252, 0.4)"},meter:{colBackground:e,colBorder:n,colSafe:n,colClip:"yellow"}}}function Vn(t,e){let n;switch(t){case"dark":n=On();break;case"light":n=Wr();break;case"solar":n=$r();break;case"lava":n=Or();break;default:n=On();break}for(let[r,a]of Object.entries(n.def))e[r]=a;return n}var gn={};B(gn,{jungle2:()=>Kn});var Kn={demo:!0,bpm:153,samples:[{id:"288cc0c6-e1cc-4728-9c4f-abb393658b8c",name:"hot pants",data:[0,null,null,null]},{id:"d1cf0a20-cf09-48ee-93de-65cfc88eeeb4",name:"god chord - blue mar ten",data:[1,null,null,null]},{id:"f5104c33-5051-43c0-8d71-a99b02fed9f9",name:"physical - blue mar ten",data:[2,null,null,null]},{id:"2c830293-2ea9-4fdb-bfd6-a96e86393996",name:"bnw",data:[3,null,null,null]},{id:"e148d176-c7d3-416c-84d6-423b8b93b3e1",name:"wibble - legowelt k4",data:[4,null,null,null]},{id:"8542a85b-792d-4cf1-bfa9-4b57a4fa96a2",name:"beauty - legowelt k4",data:[5,null,null,null]},{id:"d5e0e38f-e867-49f1-b055-72bb27e4071d",name:"dimensional - legowelt k4",data:[6,null,null,null]},{id:"",name:"",data:[7,null,null,null]},{id:"",name:"",data:[8,null,null,null]},{id:"",name:"",data:[9,null,null,null]},{id:"",name:"",data:[10,null,null,null]},{id:"",name:"",data:[11,null,null,null]},{id:"",name:"",data:[12,null,null,null]},{id:"",name:"",data:[13,null,null,null]},{id:"",name:"",data:[14,null,null,null]},{id:"",name:"",data:[15,null,null,null]},{id:"",name:"",data:[16,null,null,null]},{id:"",name:"",data:[17,null,null,null]},{id:"",name:"",data:[18,null,null,null]},{id:"",name:"",data:[19,null,null,null]},{id:"",name:"",data:[20,null,null,null]},{id:"",name:"",data:[21,null,null,null]},{id:"",name:"",data:[22,null,null,null]},{id:"",name:"",data:[23,null,null,null]},{id:"",name:"",data:[24,null,null,null]},{id:"",name:"",data:[25,null,null,null]},{id:"",name:"",data:[26,null,null,null]},{id:"",name:"",data:[27,null,null,null]},{id:"",name:"",data:[28,null,null,null]},{id:"",name:"",data:[29,null,null,null]},{id:"",name:"",data:[30,null,null,null]},{id:"",name:"",data:[31,null,null,null]},{id:"",name:"",data:[32,null,null,null]},{id:"",name:"",data:[33,null,null,null]},{id:"",name:"",data:[34,null,null,null]},{id:"",name:"",data:[35,null,null,null]},{id:"",name:"",data:[36,null,null,null]},{id:"",name:"",data:[37,null,null,null]},{id:"",name:"",data:[38,null,null,null]},{id:"",name:"",data:[39,null,null,null]},{id:"",name:"",data:[40,null,null,null]},{id:"",name:"",data:[41,null,null,null]},{id:"",name:"",data:[42,null,null,null]},{id:"",name:"",data:[43,null,null,null]},{id:"",name:"",data:[44,null,null,null]},{id:"",name:"",data:[45,null,null,null]},{id:"",name:"",data:[46,null,null,null]},{id:"",name:"",data:[47,null,null,null]},{id:"",name:"",data:[48,null,null,null]},{id:"",name:"",data:[49,null,null,null]}],instruments:{sample:{fn:"sample"}},patterns:[{id:0,dur:32,events:[{time:[1,1],data:[1,55,55,2]}],data:{}},{id:1,dur:32,events:[{time:[1,3],data:[1,55,10,9]}],data:{}},{id:2,dur:32,events:[{time:[1,1],data:[3,45,40,5]}],data:{}},{id:3,dur:32,events:[{time:[1,1],data:[1,55,55,2]},{time:[2,3],data:[1,58,55,2]}],data:{}},{id:4,dur:32,events:[{time:[1,3],data:[1,55,10,9]},{time:[3,1],data:[1,58,10,9]}],data:{}},{id:5,dur:32,events:[{time:[1,1],data:[1,55,55,2]},{time:[2,3],data:[1,58,55,2]},{time:[4,1],data:[1,60,55,2]}],data:{}},{id:6,dur:32,events:[{time:[1,3],data:[1,55,10,9]},{time:[3,1],data:[1,58,10,9]},{time:[4,3],data:[1,60,10,9]}],data:{}},{id:7,dur:32,events:[{time:[1,1],data:[2,50,40,5]},{time:[2,2],data:[666,666,666,666]},{time:[2,3],data:[2,42,50,5]},{time:[4,3],data:[666,666,666,666]},{time:[5,3],data:[2,43,50,5]},{time:[6,1],data:[2,43,50,5]},{time:[6,3],data:[2,43,50,5]},{time:[8,1],data:[666,666,666,666]},{time:[8,3],data:[2,54,50,5]}],data:{}},{id:8,dur:32,events:[{time:[1,1],data:[4,60,20,2]},{time:[1,3],data:[4,60,19,8]},{time:[2,1],data:[4,60,17,2]},{time:[2,3],data:[4,60,16,8]},{time:[3,1],data:[4,60,15,2]},{time:[3,3],data:[4,60,14,8]},{time:[4,1],data:[4,60,12,2]},{time:[4,3],data:[4,60,11,8]},{time:[5,1],data:[4,60,10,2]},{time:[5,3],data:[4,60,8,8]},{time:[6,1],data:[4,60,7,2]},{time:[6,3],data:[4,60,6,8]},{time:[7,1],data:[4,60,5,2]},{time:[7,3],data:[4,60,3,8]},{time:[8,1],data:[4,60,2,2]},{time:[8,3],data:[4,60,1,8]}],data:{}},{id:9,dur:32,events:[{time:[1,1],data:[1,55,55,2]},{time:[2,3],data:[1,58,55,2]},{time:[4,1],data:[1,60,55,2]},{time:[8,1],data:[666,666,666,666]}],data:{}},{id:10,dur:32,events:[{time:[1,3],data:[1,55,10,9]},{time:[3,1],data:[1,58,10,9]},{time:[4,3],data:[1,60,10,9]},{time:[8,1],data:[666,666,666,666]}],data:{}},{id:11,dur:32,events:[{time:[1,1],data:[2,50,40,5]},{time:[2,2],data:[666,666,666,666]},{time:[2,3],data:[2,42,50,5]},{time:[4,1],data:[2,42,50,5]},{time:[4,3],data:[666,666,666,666]}],data:{}},{id:12,dur:32,events:[{time:[1,1],data:[0,48,0,5]},{time:[1,2],data:[0,48,1,5]},{time:[1,3],data:[0,48,3,5]},{time:[1,4],data:[0,48,4,5]},{time:[2,1],data:[0,48,5,5]},{time:[2,2],data:[0,48,7,5]},{time:[2,3],data:[0,48,8,5]},{time:[2,4],data:[0,48,9,5]},{time:[3,1],data:[0,48,11,5]},{time:[3,2],data:[0,48,12,5]},{time:[3,3],data:[0,48,13,5]},{time:[3,4],data:[0,48,15,5]},{time:[4,1],data:[0,48,16,5]},{time:[4,2],data:[0,48,17,5]},{time:[4,3],data:[0,48,19,5]},{time:[4,4],data:[0,48,20,5]},{time:[5,1],data:[0,48,21,5]},{time:[5,2],data:[0,48,25,5]},{time:[5,3],data:[0,48,28,5]},{time:[5,4],data:[0,48,32,5]},{time:[6,1],data:[0,48,35,5]},{time:[6,2],data:[0,48,39,5]},{time:[6,3],data:[0,48,43,5]},{time:[6,4],data:[0,48,46,5]},{time:[7,1],data:[0,48,50,5]},{time:[7,2],data:[0,48,53,5]},{time:[7,3],data:[0,48,57,5]},{time:[7,4],data:[0,48,61,5]},{time:[8,1],data:[0,48,64,5]},{time:[8,2],data:[0,52,68,5]},{time:[8,3],data:[0,56,71,5]},{time:[8,4],data:[0,60,75,5]}],data:{}},{id:13,dur:32,events:[{time:[1,1],data:[0,47,78,5]},{time:[4,4],data:[0,47,69,5]},{time:[5,1],data:[0,47,78,5]},{time:[6,3],data:[0,47,78,5]}],data:{}},{id:14,dur:32,events:[{time:[1,1],data:[6,45,25,7]}],data:{}},{id:15,dur:32,events:[{time:[1,1],data:[1,55,55,2]},{time:[2,3],data:[1,58,55,2]},{time:[4,1],data:[1,60,55,2]},{time:[8,1],data:[1,55,35,2]},{time:[8,2],data:[1,55,35,2]},{time:[8,3],data:[1,55,35,2]},{time:[8,4],data:[1,55,35,2]}],data:{}},{id:16,dur:32,events:[{time:[1,1],data:[0,47,78,5]},{time:[4,4],data:[0,47,69,5]},{time:[5,1],data:[0,47,78,5]},{time:[5,3],data:[666,666,666,666]}],data:{}},{id:17,dur:32,events:[{time:[1,1],data:[5,61,35,5]},{time:[1,3],data:[5,61,35,5]},{time:[2,2],data:[666,666,666,666]},{time:[2,3],data:[5,61,35,5]},{time:[3,1],data:[5,61,35,5]},{time:[3,4],data:[666,666,666,666]},{time:[4,1],data:[5,61,35,5]},{time:[4,3],data:[5,61,35,5]},{time:[5,2],data:[666,666,666,666]},{time:[5,3],data:[5,61,35,5]},{time:[6,1],data:[5,61,35,5]},{time:[6,3],data:[5,61,35,5]},{time:[7,2],data:[666,666,666,666]},{time:[7,3],data:[5,61,35,5]},{time:[8,2],data:[666,666,666,666]},{time:[8,3],data:[5,61,35,5]}],data:{}},{id:18,dur:32,events:[{time:[1,1],data:[5,61,46,5]},{time:[1,3],data:[5,61,46,5]},{time:[2,2],data:[666,666,666,666]},{time:[2,3],data:[5,61,46,5]},{time:[3,1],data:[5,61,46,5]},{time:[3,4],data:[666,666,666,666]},{time:[4,1],data:[5,61,46,5]},{time:[4,3],data:[5,61,46,5]},{time:[5,2],data:[666,666,666,666]},{time:[5,3],data:[5,66,46,5]},{time:[6,1],data:[5,61,46,5]},{time:[6,3],data:[5,64,46,5]},{time:[8,2],data:[666,666,666,666]}],data:{}},{id:19,dur:32,events:[{time:[1,1],data:[3,45,40,5]},{time:[8,1],data:[666,666,666,666]}],data:{}},{id:20,dur:32,events:[{time:[1,1],data:[666,666,666,666]},{time:[8,1],data:[0,47,68,3]},{time:[8,2],data:[0,45,71,7]},{time:[8,3],data:[0,43,75,3]},{time:[8,4],data:[0,41,78,7]}],data:{}},{id:21,dur:32,events:[{time:[1,1],data:[5,61,35,5]},{time:[1,3],data:[5,61,35,5]},{time:[2,2],data:[666,666,666,666]},{time:[2,3],data:[5,61,35,5]},{time:[3,1],data:[5,61,35,5]},{time:[3,4],data:[666,666,666,666]},{time:[4,1],data:[5,61,35,5]},{time:[4,3],data:[5,61,35,5]},{time:[5,2],data:[666,666,666,666]},{time:[5,3],data:[5,66,35,5]},{time:[6,1],data:[5,61,35,5]},{time:[6,3],data:[5,64,35,5]},{time:[8,1],data:[5,64,35,5]},{time:[8,2],data:[5,68,35,5]},{time:[8,3],data:[5,72,35,5]},{time:[8,4],data:[5,76,35,5]}],data:{}},{id:22,dur:32,events:[{time:[1,1],data:[5,75,25,6]},{time:[1,2],data:[5,77,25,6]},{time:[1,4],data:[5,75,25,6]},{time:[2,2],data:[666,666,666,666]},{time:[2,3],data:[5,72,25,6]},{time:[3,1],data:[666,666,666,666]},{time:[3,3],data:[5,70,25,6]},{time:[4,1],data:[5,72,25,6]},{time:[4,3],data:[5,68,25,6]},{time:[5,3],data:[5,65,25,6]},{time:[6,1],data:[5,68,25,6]},{time:[6,4],data:[5,70,25,6]},{time:[7,1],data:[5,72,25,6]},{time:[7,3],data:[5,68,25,6]},{time:[7,4],data:[5,70,25,6]},{time:[8,1],data:[5,65,25,6]},{time:[8,2],data:[5,63,25,6]},{time:[8,3],data:[5,64,25,6]},{time:[8,4],data:[5,65,25,6]}],data:{}},{id:23,dur:32,events:[{time:[1,1],data:[1,48,75,5]}],data:{}},{id:24,dur:32,events:[{time:[1,1],data:[1,49,75,5]}],data:{}},{id:25,dur:32,events:[{time:[1,1],data:[1,55,75,5]},{time:[1,3],data:[1,52,75,5]}],data:{}},{id:26,dur:32,events:[{time:[1,1],data:[1,55,75,5]},{time:[1,3],data:[1,52,75,5]},{time:[4,1],data:[1,54,75,5]}],data:{}},{id:27,dur:32,events:[{time:[1,2],data:[666,666,666,666]}],data:{}},{id:28,dur:32,events:[],data:{}},{id:29,dur:32,events:[],data:{}},{id:30,dur:32,events:[],data:{}},{id:31,dur:32,events:[],data:{}},{id:32,dur:32,events:[],data:{}},{id:33,dur:32,events:[],data:{}},{id:34,dur:32,events:[],data:{}},{id:35,dur:32,events:[],data:{}},{id:36,dur:32,events:[],data:{}},{id:37,dur:32,events:[],data:{}},{id:38,dur:32,events:[],data:{}},{id:39,dur:32,events:[],data:{}},{id:40,dur:32,events:[],data:{}},{id:41,dur:32,events:[],data:{}},{id:42,dur:32,events:[],data:{}},{id:43,dur:32,events:[],data:{}},{id:44,dur:32,events:[],data:{}},{id:45,dur:32,events:[],data:{}},{id:46,dur:32,events:[],data:{}},{id:47,dur:32,events:[],data:{}},{id:48,dur:32,events:[],data:{}},{id:49,dur:32,events:[],data:{}},{id:50,dur:32,events:[],data:{}},{id:51,dur:32,events:[],data:{}},{id:52,dur:32,events:[],data:{}},{id:53,dur:32,events:[],data:{}},{id:54,dur:32,events:[],data:{}},{id:55,dur:32,events:[],data:{}},{id:56,dur:32,events:[],data:{}},{id:57,dur:32,events:[],data:{}},{id:58,dur:32,events:[],data:{}},{id:59,dur:32,events:[],data:{}},{id:60,dur:32,events:[],data:{}},{id:61,dur:32,events:[],data:{}},{id:62,dur:32,events:[],data:{}},{id:63,dur:32,events:[],data:{}},{id:64,dur:32,events:[],data:{}},{id:65,dur:32,events:[],data:{}},{id:66,dur:32,events:[],data:{}},{id:67,dur:32,events:[],data:{}},{id:68,dur:32,events:[],data:{}},{id:69,dur:32,events:[],data:{}},{id:70,dur:32,events:[],data:{}},{id:71,dur:32,events:[],data:{}},{id:72,dur:32,events:[],data:{}},{id:73,dur:32,events:[],data:{}},{id:74,dur:32,events:[],data:{}},{id:75,dur:32,events:[],data:{}},{id:76,dur:32,events:[],data:{}},{id:77,dur:32,events:[],data:{}},{id:78,dur:32,events:[],data:{}},{id:79,dur:32,events:[],data:{}},{id:80,dur:32,events:[],data:{}},{id:81,dur:32,events:[],data:{}},{id:82,dur:32,events:[],data:{}},{id:83,dur:32,events:[],data:{}},{id:84,dur:32,events:[],data:{}},{id:85,dur:32,events:[],data:{}},{id:86,dur:32,events:[],data:{}},{id:87,dur:32,events:[],data:{}},{id:88,dur:32,events:[],data:{}},{id:89,dur:32,events:[],data:{}},{id:90,dur:32,events:[],data:{}},{id:91,dur:32,events:[],data:{}},{id:92,dur:32,events:[],data:{}},{id:93,dur:32,events:[],data:{}},{id:94,dur:32,events:[],data:{}},{id:95,dur:32,events:[],data:{}},{id:96,dur:32,events:[],data:{}},{id:97,dur:32,events:[],data:{}},{id:98,dur:32,events:[],data:{}},{id:99,dur:32,events:[],data:{}}],sequences:[{id:0,steps:[{ticks:32,patterns:[0,1,null,null,null,2]},{ticks:32,patterns:[3,4,null,null]},{ticks:32,patterns:[0,1,null,null]},{ticks:32,patterns:[5,6,null,null]},{ticks:32,patterns:[0,1,7,null,null,8]},{ticks:32,patterns:[3,4,7,null]},{ticks:32,patterns:[0,1,7,null]},{ticks:32,patterns:[9,10,11,12]},{ticks:32,patterns:[0,1,7,13,null,14]},{ticks:32,patterns:[3,4,7,13,null]},{ticks:32,patterns:[0,1,7,13,null]},{ticks:32,patterns:[15,6,7,16,null]},{ticks:32,patterns:[0,1,7,13,17,8]},{ticks:32,patterns:[3,4,7,13,18,null]},{ticks:32,patterns:[0,1,7,13,null,19]},{ticks:32,patterns:[15,6,7,20,18,null]},{ticks:32,patterns:[0,1,7,13,null,14]},{ticks:32,patterns:[3,4,7,13,null]},{ticks:32,patterns:[0,1,7,13,null]},{ticks:32,patterns:[5,1,7,16,null]},{ticks:32,patterns:[0,1,7,13,17,null]},{ticks:32,patterns:[3,4,7,13,21]},{ticks:32,patterns:[0,1,7,13,22]},{ticks:32,patterns:[5,6,7,16,18]},{ticks:32,patterns:[0,1,7,13,null,14]},{ticks:32,patterns:[3,4,7,13,null]},{ticks:32,patterns:[0,1,7,13,17]},{ticks:32,patterns:[15,6,7,16,21]},{ticks:32,patterns:[null,null,null,null,null,null]},{ticks:32,patterns:[null,null,null,null]},{ticks:32,patterns:[null,null,null,null,null]},{ticks:32,patterns:[null,null,null,null,null]},{ticks:32,patterns:[null,null]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]},{ticks:32,patterns:[]}]}]};var He="[SE] ERROR ->",Hn=async()=>{async function t(){return new Promise((r,a)=>{let i=window.indexedDB.open("db",1);i.onupgradeneeded=async()=>{i.result.createObjectStore("tracks",{keyPath:"id",autoIncrement:!1}).createIndex("created","created",{unique:!1}),i.result.createObjectStore("samples",{keyPath:"id",autoIncrement:!1})},i.onsuccess=()=>{r(i.result)},i.onerror=()=>{a("Can't open a connection to IndexedDB")}})}let e=await t(),n={getAll:async r=>await new Promise((a,i)=>{let s=e.transaction(r,"readonly").objectStore(r).getAll();s.onerror=()=>i(s.error),s.onsuccess=()=>a(s.result)}).catch(a=>{throw console.error(`${He} "Can't get values from table [${r}]"`),a}),getAllQuery:async(r,a)=>await new Promise((i,o)=>{let l=e.transaction(r,"readonly").objectStore(r).openCursor(),f=new Array;l.onerror=()=>o(l.error),l.onsuccess=c=>{let u=c.target.result;u?(a.find(b=>b==u.value.id)&&f.push(u.value),u.continue()):i(f)}}).catch(i=>{throw console.error(`${He} "Can't get values from table [${r}]"`),i}),putValue:async(r,a)=>await new Promise((i,o)=>{let l=e.transaction(r,"readwrite").objectStore(r).put(a);l.onerror=()=>o(l.error),l.onsuccess=()=>i()}).catch(i=>{throw console.error(`${He} Can't add value to table [${r}] :: ${i}`),i}),putTrack:async(r,a)=>await new Promise((i,o)=>{let s=e.transaction(["tracks","samples"],"readwrite"),l=s.objectStore("samples");for(let c of a)l.put(c);s.objectStore("tracks").put(r),s.oncomplete=()=>i(),s.onerror=c=>o(c)}).catch(i=>{throw console.error(`${He} Can't save song [id] :: ${i}`),i}),deleteTrack:async r=>await new Promise(async(a,i)=>{let o=(await n.getAll("tracks")).find(c=>c.id==r),s=e.transaction(["tracks","samples"],"readwrite"),l=s.objectStore("samples");for(let c of o.data.samples)l.delete(c.id);s.objectStore("tracks").delete(r),s.oncomplete=()=>a(!0),s.onerror=c=>i(c)}).catch(a=>{throw console.error(`${He} Can't save song [id] :: ${a}`),a}),delete:async(r,a)=>await new Promise((i,o)=>{let l=e.transaction(r,"readwrite").objectStore(r).delete(a);l.onerror=()=>o(l.error),l.onsuccess=()=>i(!0)}).catch(i=>{throw console.error(`${He} Can't delete key [${a}] from table [${r}]`),i})};return{tracks_getAllDemo:async()=>{let r=new Array;for(let[a,i]of Object.entries(gn))r.push({id:a,created:new Date,data:i});return r},tracks_getAllUser:async()=>(await n.getAll("tracks")).sort((a,i)=>a.created.getTime()-i.created.getTime()),tracks_getEmpty:async r=>{let i={id:r,created:new Date,data:{demo:!1,bpm:120,samples:[],instruments:{sample:{fn:"sample"}},patterns:[],sequences:[{id:0,steps:[]}]}};return await n.putValue("tracks",i),i},tracks_put:async(r,a,i,o)=>await n.putTrack({id:r,created:o,data:a},i),tracks_delete:async r=>await n.deleteTrack(r),samples_getByIds:async r=>await n.getAllQuery("samples",r),samples_delete:async r=>await n.delete("samples",r)}};var Xt={};B(Xt,{Element:()=>Pn});var A=class extends HTMLElement{_name;_data;_markup;shadow;constructor(e){super(),this._data=e,this.attachShadow({mode:"open"}),this.shadow=this.shadowRoot}_applyMarkup(){this.shadow.innerHTML=`<style>${this._css(this._data.theme)}</style>`+this._markup}element(e){return this.shadow.querySelector(e)}elements(e){return this.shadow.querySelectorAll(e)}appendElement(e){this.shadow.appendChild(e)}prependElement(e){this.shadow.prepend(e)}removeElement(e){let n=this.element(e);n&&this.shadow.removeChild(n)}};var bt={};B(bt,{Element:()=>vt,get:()=>zr});function zr(t){let e=new vt(t);return{data:t,element:e,fn:{update:r=>{t.actions=r,e.setActions()}}}}var vt=class extends A{_name="actions";_markup=`
  `;_cssVars={};_css(e){return`
      :host {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
    `}constructor(e){super(e),super._applyMarkup()}connectedCallback(){this.setActions()}setActions(){this.shadow.innerHTML="";let e=this._data.actions;if(e.length==0){let n=document.createElement("div");n.innerText="No available actions for the current region",this.shadow.appendChild(n),e=[{keycode:";",text:"...hide available actions"}]}for(let n of e){let r=document.createElement("div");r.innerText=`[${n.keycode}] -> ${n.text}`,this.shadow.appendChild(r)}}};var _e={};B(_e,{Element:()=>Ct,get:()=>jr,playTypes:()=>kt,states:()=>p});var zn,vn,Un,lt,Xn,Yn,jn,Qn,bn,dt,yn,Jn,Zn,wn,yt,Dn,er,tr,nr,rr,_,d,M,xn,wt,be,Dt,ze,Ue,ue,_n,Be,N,xt,_t,St,ar=t=>{switch(zn=e=>{ze={inactive:-1,default:0,select:1,playFollow:2,playStatic:3,playStaticSelect:4},xn={...e.colours},wt={...e.colours,bColActiveCell:e.colours.bColActiveRow,colActiveCell:e.colours.colActiveCell},M={...wt},be="\u2025",Dt=new Array(e.size.w/e.sectionColumns).fill(null);function n(m,I){let O=m.getContext("2d",{alpha:I});if(O)return O=O,O.scale(e.dpr,e.dpr),O;throw new Error("[CnvWorker] ERROR -> canvas is not supported")}_={grid:n(e.canvases.grid,!1),select:n(e.canvases.select,!0),playhead:n(e.canvases.playhead,!0),readonly:n(e.canvases.readonly,!0)},_.grid.font=`${e.fontSize}px ${e.fontFamily}`,_.grid.textBaseline="middle";let r=e.cellPadding.v*2,a=e.cellPadding.h*2,i=Math.ceil(_.grid.measureText("0").width),o=e.fontSize/16,s=Math.ceil(_.grid.measureText("0").actualBoundingBoxAscent*2+r),l=i*3+a,f={x:0,y:0,w:l,h:e.canvases.grid.height},c=Math.ceil(e.canvases.grid.height/(s*e.dpr)),u=new Array;for(let m=0;m<e.size.w;m++)u.push(e.columnWidths[m]*i+a);let b=new Array,S=Math.floor(Math.abs(e.height-s*c)/2);for(let m=-S;m<e.height+S;m+=s)b.push(m);let g=0,q=0,C=e.dividersWidth*i,X=e.width-l,P=0;for(let m=0;m<e.size.w;m++){P+=u[m];let I=e.size.w>e.sectionColumns&&!((m+1)%e.sectionColumns);if(I&&(P+=C),P>X&&!I){g=m,q=m-1;break}g=q=m}let Y=new Array(e.size.w);Y.fill(Number.NaN),Object.seal(Y),Y[0]=0;for(let m=1;m<=g;m++)Y[m]=Y[m-1]+u[m-1],m%e.sectionColumns||(Y[m]+=C);let $=Math.floor(c/3),ce={x:l,y:0,w:e.width-l,h:e.canvases.grid.height,xOffset:0,cols:e.size.w,colWidths:u,colPositions:Y,colDividersWidth:C,colSections:e.sectionColumns,rows:e.size.h,rowHeight:s,rowPositions:b,rowsVisible:c,rowsVisibleAboveActive:c-(c-$),rowsVisibleBelowActive:c-$,visible:{top:0,left:0,right:g,bottom:Math.min(c-$,e.size.h)},navigable:{left:0,right:q}},Ge={x:0,w:e.width,h:s},k={x:ce.x,y:b[$],w:e.width,h:s,index:$};d={x:0,y:0,w:e.width,h:e.height,textY:Math.ceil(s/2+o),cellPadding:e.cellPadding,beatMarkers:Ge,stepNumbers:f,grid:ce,activeRow:k,activeCell:{x:l,y:k.y}},N={x:0,y:0},xt=ce.rows-1,_t=!1,St=!1,Be={start:e.loop.start-1,end:e.loop.end-1},Ue=ze.inactive},lt=()=>{_.grid.fillStyle=M.bColGrid,_.grid.fillRect(0,0,d.w,d.h);let e=Math.max(0,d.activeRow.index-N.y),n=e;_.grid.fillStyle=M.bColBeatMarkers;for(let o=d.grid.visible.top;o<d.grid.visible.bottom;o++)o%4||_.grid.fillRect(d.beatMarkers.x,d.grid.rowPositions[n],d.beatMarkers.w,d.beatMarkers.h),n++;_.grid.fillStyle=M.bColActiveRow,_.grid.fillRect(d.activeRow.x,d.activeRow.y,d.activeRow.w,d.activeRow.h),_.grid.fillStyle=M.bColActiveCell,_.grid.fillRect(d.activeCell.x,d.activeCell.y,d.grid.colWidths[N.x],d.grid.rowHeight),_.grid.fillStyle=M.colText;let r=d.grid.x+d.grid.xOffset+d.cellPadding.h;for(let o=d.grid.visible.left;o<=d.grid.visible.right;o++){let s=r+d.grid.colPositions[o],l=e;for(let f=d.grid.visible.top;f<d.grid.visible.bottom;f++){let c=d.grid.y+d.grid.rowPositions[l]+d.textY;_.grid.fillText(ue[o][f]||be,s,c),l++}}_.grid.fillStyle=M.colActiveRow;let a=d.activeCell.y+d.textY;for(let o=d.grid.visible.left;o<=d.grid.visible.right;o++){let s=r+d.grid.colPositions[o];_.grid.fillText(ue[o][N.y]||be,s,a)}_.grid.fillStyle=M.colActiveCell,_.grid.fillText(ue[N.x][N.y]||be,d.activeCell.x+d.cellPadding.h,a),_.grid.fillStyle=M.bColStepNumbers,_.grid.fillRect(d.stepNumbers.x,d.stepNumbers.y,d.stepNumbers.w,d.stepNumbers.h),_.grid.fillStyle=M.colStepNumbers,n=e;let i=0;for(let o=d.grid.visible.top;o<d.grid.visible.bottom;o++)_.grid.fillText((o+1).toString().padStart(3,"0"),d.cellPadding.h,d.grid.rowPositions[n]+d.textY),i=d.grid.rowPositions[n],n++;_.grid.strokeStyle=M.bColStepNumbersDivider,_.grid.beginPath(),_.grid.moveTo(d.stepNumbers.w-1,d.grid.rowPositions[e]),_.grid.lineTo(d.stepNumbers.w-1,i+d.grid.rowHeight),_.grid.stroke(),St&&Dn(Be.start,Be.end),dt()},Xn=()=>{_.grid.fillStyle=M.bColGrid,_.grid.fillRect(0,0,d.w,d.h)},dt=()=>{_.readonly.clearRect(0,0,d.w,d.h),yn(_.readonly,Dt,M.bColMute),yn(_.readonly,_n,M.bColReadonly)},yn=(e,n,r)=>{e.fillStyle=r;let a=d.activeRow.index-N.y;for(let i of n){if(i==null||i.x>d.grid.visible.right||i.x+i.w<d.grid.visible.left)continue;let o=d.grid.x;i.x>=d.grid.navigable.left&&(o+=d.grid.colPositions[i.x]);let s=d.grid.rowPositions[Math.max(a+i.y,0)],l=0;for(let c=Math.max(i.x,d.grid.navigable.left);c<i.x+i.w;c++)l+=d.grid.colWidths[c];let f=(d.grid.rowPositions[a+i.y+i.h]||d.grid.h)-s;e.fillRect(o,s,l,f)}},vn=(e,n)=>{let r=e!=N.x,a=n!=N.y,i=!1;if(r)if(e<d.grid.navigable.left){d.grid.navigable.left=d.grid.visible.left=e;let o=0;for(let s=d.grid.visible.left;s<=d.grid.cols;s++){if(s>d.grid.visible.left&&!(s%d.grid.colSections)&&(o+=d.grid.colDividersWidth),d.grid.colPositions[s]=o,o+=d.grid.colWidths[s],o==d.grid.w){d.grid.visible.right=d.grid.navigable.right=s;break}if(o>d.grid.w){d.grid.visible.right=s,d.grid.navigable.right=s>0?s-1:0,i=!0;break}}d.grid.xOffset=0,d.activeCell.x=d.grid.x,N.x=e,N.y=n}else if(e>d.grid.navigable.right){d.grid.navigable.right=d.grid.visible.right=e;let o=d.grid.w;for(let s=d.grid.visible.right;s>=0;s--){if(o-=d.grid.colWidths[s],d.grid.colPositions[s]=o,o==0){d.grid.visible.left=d.grid.navigable.left=s;break}if(o<0){d.grid.visible.left=s,d.grid.navigable.left=s+1;break}s%d.grid.colSections||(o-=d.grid.colDividersWidth)}i=!0,d.grid.xOffset=0,d.activeCell.x=d.grid.x+d.grid.w-d.grid.colWidths[d.grid.navigable.right],N.x=e,N.y=n}else d.activeCell.x=d.grid.x+d.grid.colPositions[e],Un(N,{x:e,y:n}),N.x=e,N.y=n;a&&(d.grid.visible.top=Math.max(n-d.grid.rowsVisibleAboveActive,0),d.grid.visible.bottom=Math.min(n+d.grid.rowsVisibleBelowActive,d.grid.rows),N.x=e,N.y=n,i=!0,(Ue==ze.playStatic||Ue==ze.playStaticSelect)&&wn(xt,!0)),i&&lt()},Un=(e,n)=>{let r=d.grid.x+d.grid.colPositions[n.x],a=d.activeRow.y,i=d.grid.x+d.grid.colPositions[e.x],o=d.activeRow.y;_.grid.fillStyle=M.bColActiveRow,_.grid.fillRect(i,o,d.grid.colWidths[e.x],d.grid.rowHeight),_.grid.fillStyle=M.colActiveRow,_.grid.fillText(ue[e.x][e.y]||be,i+d.cellPadding.h,o+d.textY),_.grid.fillStyle=M.bColActiveCell,_.grid.fillRect(r,a,d.grid.colWidths[n.x],d.grid.rowHeight),_.grid.fillStyle=M.colActiveCell,_.grid.fillText(ue[n.x][n.y]||be,r+d.cellPadding.h,a+d.textY)},Yn=(e,n,r)=>{if(ue[e][n]=r,n<d.grid.visible.top||n>d.grid.visible.bottom)return;let a=d.grid.x+d.grid.colPositions[e],i=d.grid.rowPositions[Math.max(0,d.activeRow.index-(N.y-n))];n==N.y?(_.grid.fillStyle=M.bColActiveRow,_.grid.fillRect(a,i,d.grid.colWidths[e],d.grid.rowHeight),_.grid.fillStyle=M.colActiveRow,_.grid.fillText(r||be,a+d.cellPadding.h,i+d.textY)):(_.grid.fillStyle=n%4?M.bColGrid:M.bColBeatMarkers,_.grid.fillRect(a,i,d.grid.colWidths[e],d.grid.rowHeight),_.grid.fillStyle=M.colText,_.grid.fillText(r||be,a+d.cellPadding.h,i+d.textY))},jn=e=>{ue[N.x][N.y]=e.toString();let n=d.grid.x+d.grid.colPositions[N.x],r=d.activeRow.y;_.grid.fillStyle=M.bColActiveCell,_.grid.fillRect(n,r,d.grid.colWidths[N.x],d.grid.rowHeight),_.grid.fillStyle=M.colActiveCell,_.grid.fillText(ue[N.x][N.y]||be,n+d.cellPadding.h,r+d.textY)},Qn=e=>{bn();let n,r;if(e.w<0)e.x>=d.grid.visible.right?n=d.grid.x+d.grid.colPositions[d.grid.visible.right]+d.grid.colWidths[d.grid.visible.right]:n=d.grid.x+d.grid.colPositions[e.x]+d.grid.colWidths[e.x],r=d.grid.x+d.grid.colPositions[e.x+e.w];else{e.x<=d.grid.visible.left?n=d.grid.x:n=d.grid.x+d.grid.colPositions[e.x];let l=e.x+e.w;r=d.grid.x+d.grid.colPositions[l]+d.grid.colWidths[l]}let a=r-n,i,o;e.h<0?(e.y>=d.grid.visible.bottom?i=d.grid.y+d.grid.h:i=d.grid.rowPositions[d.activeRow.index+(e.y-N.y)]+d.grid.rowHeight,o=d.grid.y+d.grid.rowPositions[d.activeRow.index]):(e.y<d.grid.visible.top?i=d.grid.y:i=d.grid.rowPositions[d.activeRow.index-(N.y-e.y)],o=d.grid.y+d.grid.rowPositions[d.activeRow.index]+d.grid.rowHeight);let s=o-i;_.select.fillStyle=M.bColGrab,_.select.fillRect(n,i,a,s)},bn=()=>{_.select.clearRect(d.grid.x,d.grid.y,d.grid.w,d.grid.h)},Jn=e=>{let n=e*d.grid.colSections;Dt[e]={x:n,y:0,w:d.grid.colSections,h:d.grid.rows},!(n>d.grid.visible.right)&&(n+d.grid.colSections<d.grid.visible.left||dt())},Zn=e=>{Dt[e]=null,dt()},wn=(e,n=!1)=>{if(e<d.grid.visible.top||e>d.grid.visible.bottom){_t&&(yt(),_t=!1);return}_t=!0;let r=d.activeRow.index-N.y,a=r+e,i=r+xt;!n&&a==i||(_.playhead.clearRect(d.grid.x,d.grid.y,d.grid.w,d.grid.h),_.playhead.fillStyle=M.bColPlayhead,_.playhead.fillRect(d.activeRow.x,d.grid.rowPositions[a],d.activeRow.w,d.activeRow.h),xt=e)},yt=()=>{_.playhead.clearRect(d.grid.x,d.grid.y,d.grid.w,d.grid.h)},Dn=(e,n)=>{Be.start=e,Be.end=n;let r=d.activeRow.index-N.y,a,i=r+Be.start;i<0?a=d.stepNumbers.y:a=d.grid.rowPositions[i];let o,s=r+Be.end+1;s<0?d.stepNumbers.y+d.stepNumbers.h:s>=d.grid.rowsVisible?o=d.grid.rowPositions[d.grid.rowsVisible-1]:o=d.grid.rowPositions[s]-a,_.grid.fillStyle=M.bColLoopMarker,_.grid.fillRect(d.stepNumbers.x,a,d.stepNumbers.w,o),St||(St=!0)},er=(e,n)=>{ue=e,_n=n,d.grid.rows=ue[0].length,d.grid.visible.bottom=Math.min(d.grid.rowsVisible-d.activeRow.index,ue[0].length)},nr=()=>{Ue=ze.default,M.bColActiveCell=xn.bColActiveCell,M.colActiveCell=xn.colActiveCell;let e=d.grid.x+d.grid.colPositions[N.x],n=d.activeRow.y;_.grid.fillStyle=M.bColActiveCell,_.grid.fillRect(e,n,d.grid.colWidths[N.x],d.grid.rowHeight),_.grid.fillStyle=M.colActiveCell,_.grid.fillText(ue[N.x][N.y]||be,e+d.cellPadding.h,n+d.textY)},rr=()=>{Ue=ze.inactive,M.bColActiveCell=wt.bColActiveCell,M.colActiveCell=wt.colActiveCell;let e=d.grid.x+d.grid.colPositions[N.x],n=d.activeRow.y;_.grid.fillStyle=M.bColActiveRow,_.grid.fillRect(e,n,d.grid.colWidths[N.x],d.grid.rowHeight),_.grid.fillStyle=M.colActiveCell,_.grid.fillText(ue[N.x][N.y]||be,e+d.cellPadding.h,n+d.textY),yt()},tr=e=>{if(e==d.w)return;d.w=e,d.beatMarkers.w=e,d.activeRow.w=e,d.grid.w=e-d.grid.x,vn(0,N.y);let n=0,r=0,a=0;for(let o=d.grid.visible.left;o<d.grid.cols;o++){n+=d.grid.colWidths[o];let s=d.grid.cols>d.grid.colSections&&!((o+1)%d.grid.colSections);if(s&&(n+=d.grid.colDividersWidth),n>d.grid.w&&!s){r=o,a=o-1;break}r=a=o}d.grid.visible.right=r,d.grid.navigable.right=a;let i=0;d.grid.colPositions[d.grid.visible.left]=i;for(let o=d.grid.visible.left+1;o<=r;o++)i+=d.grid.colWidths[o-1],o>0&&!(o%d.grid.colSections)&&(i+=d.grid.colDividersWidth),d.grid.colPositions[o]=i;lt()},t.data.msg){case"move":{vn(t.data.x,t.data.y);break}case"draw":{lt();break}case"clear":{Xn();break}case"updateCell":{Yn(t.data.x,t.data.y,t.data.value);break}case"updateActiveCell":{jn(t.data.value);break}case"drawSelection":{Qn(t.data.selection);break}case"clearSelection":{bn();break}case"mute":{Jn(t.data.trackIndex);break}case"unmute":{Zn(t.data.trackIndex);break}case"drawPlayhead":{wn(t.data.row);break}case"clearPlayhead":{yt();break}case"drawLoopMarker":{Dn(t.data.startRow,t.data.endRow);break}case"updateReadOnly":{_n=t.data.ror,dt();break}case"deactivate":{rr();break}case"activate":{nr();break}case"setState":{Ue=t.data.state;break}case"setData":{er(t.data.gridData,t.data.readOnlyRegions),lt();break}case"resize":{tr(t.data.width);break}case"init":{zn(t.data);break}}};var ir,or,sr,Z,ee,Sn,lr=t=>{switch(ir=e=>{let n=e.offscreenCanvas.getContext("2d",{alpha:!1});if(n)Z=n,Z.scale(e.dpr,e.dpr);else throw new Error("[CnvWorker] ERROR -> canvas is not supported");ee={colours:e.colours,w:e.width,h:e.height},Sn=e.bufferLength},or=e=>{Z.beginPath();let n=ee.w*1/Sn,r=0,a=!1;for(let i=0;i<Sn;i++){e[i]==255&&(a=!0);let s=e[i]/128*ee.h/2;i===0?Z.moveTo(r,s):Z.lineTo(r,s),r+=n}Z.fillStyle=a?ee.colours.colClip:ee.colours.colScope,Z.fillRect(0,0,ee.w,ee.h),Z.strokeStyle=ee.colours.colLine,Z.lineTo(ee.w,ee.h/2),Z.stroke(),postMessage(e,[e.buffer])},sr=()=>{Z.fillStyle=ee.colours.colScope,Z.fillRect(0,0,ee.w,ee.h),Z.strokeStyle=ee.colours.colLine,Z.beginPath(),Z.moveTo(0,ee.h/2),Z.lineTo(ee.w,ee.h/2),Z.stroke()},t.data.msg){case"draw":or(t.data.scopeData);break;case"clear":sr();break;case"init":ir(t.data);break}};var dr,Cn,cr,ur,Ur,mr,K,L,Xr,pr=t=>{switch(dr=e=>{let n=e.offscreenCanvas.getContext("2d",{alpha:!1});if(n)K=n,K.scale(e.dpr,e.dpr);else throw new Error("[CnvWorker] ERROR -> canvas is not supported");if(e.orientation=="vertical"){let a=e.width-2;L={colours:e.colours,w:e.width,h:e.height,meterWidth:a,meterLineWidth:a-1,meterBorderWidth:1,meterLinePos:{x:a/2,y:e.height-1}},Cn=cr}else{let a=e.width-2;L={colours:e.colours,w:e.width,h:e.height,meterWidth:a,meterLineWidth:a-1,meterBorderWidth:1,meterLinePos:{x:0,y:e.height-a/2}},Cn=ur}K.fillStyle=L.colours.colBackground,Xr=e.bufferLength},cr=e=>{let n=e*L.h;K.fillRect(0,0,L.w,L.h),K.strokeStyle=e>1?L.colours.colClip:L.colours.colSafe,K.lineWidth=L.meterLineWidth,K.beginPath(),K.moveTo(L.meterLinePos.x,L.meterLinePos.y),K.lineTo(L.meterLinePos.x,L.meterLinePos.y-n),K.stroke()},ur=e=>{let n=e*L.w;K.fillRect(0,0,L.w,L.h),K.strokeStyle=e>1?L.colours.colClip:L.colours.colSafe,K.lineWidth=L.meterLineWidth,K.beginPath(),K.moveTo(L.meterLinePos.x,L.meterLinePos.y),K.lineTo(L.meterLinePos.x+n,L.meterLinePos.y),K.stroke()},Ur=()=>{K.strokeStyle=L.colours.colBorder,K.lineWidth=L.meterBorderWidth,K.setLineDash([]),K.strokeRect(0,0,L.meterWidth,L.h-K.lineWidth)},mr=()=>{K.fillRect(0,0,L.w,L.h)},t.data.msg){case"draw":Cn(t.data.meterData);break;case"clear":mr();break;case"init":dr(t.data);break}};var Yr={grid:ar,scope:lr,meter:pr};function Fe(t){let e=new Blob(["self.onmessage = ",Yr[t].toString()],{type:"text/javascript"}),n=URL.createObjectURL(e);return new Worker(n)}var kt={static:0,follow:1};function jr(t){let e=new Ct(t);console.log(" ");let n=t.initialData,r=t.initialReadOnlyRegions,a={data:t,element:e,fn:{setData:(m,I)=>{n=m,r=I,e.setData(n,r,t.gridCols)},activate:()=>{e.activate(),t.setStatus()},deactivate:()=>{e.deactivate()},setState:c,currentValue:()=>n[t.cellCoords.x][t.cellCoords.y].v,navMoveRow:m=>{u(t.cellCoords.x,m)},navUp:()=>{[p.default,p.playStatic].includes(t.state)?u(t.cellCoords.x,t.cellCoords.y==0?n[0].length-1:t.cellCoords.y-1):[p.select,p.playStaticSelect].includes(t.state)&&t.cellCoords.y>0&&(u(t.cellCoords.x,t.cellCoords.y-1),C())},navDown:()=>{[p.default,p.playStatic].includes(t.state)?u(t.cellCoords.x,t.cellCoords.y==n[0].length-1?0:t.cellCoords.y+1):[p.select,p.playStaticSelect].includes(t.state)&&t.cellCoords.y<n[0].length-1&&(u(t.cellCoords.x,t.cellCoords.y+1),X())},navLeft:()=>{[p.select,p.playStaticSelect].includes(t.state)?t.cellCoords.x>0&&(u(t.cellCoords.x-1,t.cellCoords.y),P()):u(t.cellCoords.x==0?t.gridSize.w-1:t.cellCoords.x-1,t.cellCoords.y),l=[],i=t.gridCols[t.cellCoords.x%t.gridCols.length]},navRight:()=>{[p.select,p.playStaticSelect].includes(t.state)?t.cellCoords.x<t.gridSize.w-1&&(u(t.cellCoords.x+1,t.cellCoords.y),Y()):u(t.cellCoords.x==t.gridSize.w-1?0:t.cellCoords.x+1,t.cellCoords.y),l=[],i=t.gridCols[t.cellCoords.x%t.gridCols.length]},navUpEnd:()=>{if(t.state==p.playFollow||t.cellCoords.y==0)return!0;u(t.cellCoords.x,0),[p.select,p.playStaticSelect].includes(t.state)&&$()},navDownEnd:()=>{if(t.state==p.playFollow||t.cellCoords.y==n[0].length)return!0;u(t.cellCoords.x,n[0].length-1),[p.select,p.playStaticSelect].includes(t.state)&&ce()},navLeftEnd:()=>{if(t.cellCoords.x==0)return!0;u(0,t.cellCoords.y),[p.select,p.playStaticSelect].includes(t.state)&&Ge(),l=[],i=t.gridCols[t.cellCoords.x%t.gridCols.length]},navRightEnd:()=>{if(t.cellCoords.x==t.gridSize.w-1)return!0;u(t.gridSize.w-1,t.cellCoords.y),[p.select,p.playStaticSelect].includes(t.state)&&k(),l=[],i=t.gridCols[t.cellCoords.x%t.gridCols.length]},navLeftTrack:()=>{if([p.select,p.playStaticSelect].includes(t.state))return;let m=t.cellCoords.x%t.gridCols.length;m==0&&(m=t.gridCols.length),t.cellCoords.x==0&&(m=-(t.gridSize.w-t.gridCols.length)),u(t.cellCoords.x-m,t.cellCoords.y),[p.select,p.playStaticSelect].includes(t.state)&&(t.gridSelection.w-=m,e.drawSelection(t.gridSelection)),l=[],i=t.gridCols[t.cellCoords.x%t.gridCols.length]},navRightTrack:()=>{if([p.select,p.playStaticSelect].includes(t.state))return;let m=t.gridCols.length-t.cellCoords.x%t.gridCols.length;t.cellCoords.x+m>=t.gridSize.w&&(m=-t.cellCoords.x),u(t.cellCoords.x+m,t.cellCoords.y),[p.select,p.playStaticSelect].includes(t.state)&&(t.gridSelection.w+=m,e.drawSelection(t.gridSelection)),l=[],i=t.gridCols[t.cellCoords.x%t.gridCols.length]},navUpEvent:()=>{let m=t.cellCoords.y;for(let I=0;I<n[0].length;I++)if(m=m-1<0?n[0].length-1:m-1,!Number.isNaN(n[t.cellCoords.x][m].v)){u(t.cellCoords.x,m);break}if([p.select,p.playStaticSelect].includes(t.state)){let I=t.cellCoords.y-t.gridSelection.y;t.gridSelection.h!=I&&(t.gridSelection.h=t.cellCoords.y-t.gridSelection.y,e.drawSelection(t.gridSelection))}},navDownEvent:()=>{let m=t.cellCoords.y;for(let I=0;I<n[0].length;I++)if(m=m+1>=n[0].length?0:m+1,!Number.isNaN(n[t.cellCoords.x][m].v)){u(t.cellCoords.x,m);break}if([p.select,p.playStaticSelect].includes(t.state)){let I=t.cellCoords.y-t.gridSelection.y;t.gridSelection.h!=I&&(t.gridSelection.h=t.cellCoords.y-t.gridSelection.y,e.drawSelection(t.gridSelection))}},selectToggle:()=>{t.state!=p.playFollow&&([p.select,p.playStaticSelect].includes(t.state)?S():b())},selectSectionLeft:()=>{if([p.select,p.playStaticSelect].includes(t.state)){if(o){if(t.gridSelection.x+t.gridSelection.w==0)return;t.cellCoords.x-=t.gridCols.length,t.gridSelection.w-=t.gridCols.length}else{let m=t.cellCoords.x-t.cellCoords.x%t.gridCols.length;t.cellCoords.x=m,t.gridSelection.w=-(t.gridCols.length-1),t.gridSelection.x=m-t.gridSelection.w}u(t.cellCoords.x,t.cellCoords.y),e.drawSelection(t.gridSelection),l=[],i=t.gridCols[t.cellCoords.x%t.gridCols.length],o=!0}},selectSectionRight:()=>{if([p.select,p.playStaticSelect].includes(t.state)){if(o){if(t.gridSelection.x==t.gridSize.w-1)return;t.gridSelection.x+=t.gridCols.length,t.gridSelection.w-=t.gridCols.length}else{let m=t.cellCoords.x-t.cellCoords.x%t.gridCols.length;u(m,t.cellCoords.y),t.gridSelection.w=-(t.gridCols.length-1),t.gridSelection.x=m-t.gridSelection.w}e.drawSelection(t.gridSelection),o=!0}},inputFill:()=>{if([p.select,p.playStaticSelect].includes(t.state)){if(!s)return s=!0,setTimeout(()=>{s=!1},500),!1;let m=t.gridEditor.fillRange(t.gridSelection);return g(m),!!m.length}else{let m=t.gridEditor.fill(t.cellCoords.x,t.cellCoords.y,t.state==p.default);return g(m),!!m.length}},inputValue:m=>{[p.select,p.playStaticSelect].includes(t.state)||g(t.gridEditor.amend(t.cellCoords.x,t.cellCoords.y,m,t.state==p.default))},inputDigit:m=>{let I=[...l];I.length==i.digits&&I.shift(),I.push(m.toString());let O=parseInt(I.join("")),fe=[p.select,p.playStaticSelect].includes(t.state)?t.gridEditor.amendRange(t.gridSelection,O):t.gridEditor.amend(t.cellCoords.x,t.cellCoords.y,O,t.state==p.default);fe.length&&(g(fe),l=I)},inputInc:()=>{[p.select,p.playStaticSelect].includes(t.state)?g(t.gridEditor.addRange(t.gridSelection,1)):g(t.gridEditor.add(t.cellCoords.x,t.cellCoords.y,1,t.state==p.default))},inputDec:()=>{[p.select,p.playStaticSelect].includes(t.state)?g(t.gridEditor.addRange(t.gridSelection,-1)):g(t.gridEditor.add(t.cellCoords.x,t.cellCoords.y,-1,t.state==p.default))},inputIncStep:()=>{[p.select,p.playStaticSelect].includes(t.state)?g(t.gridEditor.addStepRange(t.gridSelection,1)):g(t.gridEditor.addStep(t.cellCoords.x,t.cellCoords.y,1,t.state==p.default))},inputDecStep:()=>{[p.select,p.playStaticSelect].includes(t.state)?g(t.gridEditor.addStepRange(t.gridSelection,-1)):g(t.gridEditor.addStep(t.cellCoords.x,t.cellCoords.y,-1,t.state==p.default))},inputKill:()=>{g(t.gridEditor.kill(t.cellCoords.x,t.cellCoords.y))},inputInterpolate:()=>{[p.select,p.playStaticSelect].includes(t.state)&&t.gridSelection.h!=0&&t.gridSelection.w==0&&g(t.gridEditor.interpolateRange(t.gridSelection))},inputLength:()=>{[p.select,p.playStaticSelect].includes(t.state)||Number.isNaN(t.loop.start)&&(g(t.gridEditor.length(t.cellCoords.x,t.cellCoords.y)),e.updateReadonlyRegions())},editCut:()=>{[p.select,p.playStaticSelect].includes(t.state)?g(t.gridEditor.cutRange(t.gridSelection)):g(t.gridEditor.cutRange({...t.cellCoords,w:0,h:0})),S()},editCopy:()=>{[p.select,p.playStaticSelect].includes(t.state)?t.gridEditor.copyRange(t.gridSelection):t.gridEditor.copyRange({...t.cellCoords,w:0,h:0}),S()},editPaste:()=>{[p.select,p.playStaticSelect].includes(t.state)||g(t.gridEditor.paste(t.cellCoords.x,t.cellCoords.y))},editMerge:()=>{[p.select,p.playStaticSelect].includes(t.state)||g(t.gridEditor.paste(t.cellCoords.x,t.cellCoords.y,!0))},editDelete:()=>{f=0,[p.select,p.playStaticSelect].includes(t.state)?(g(t.gridEditor.destroyRange(t.gridSelection)),S()):(g(t.gridEditor.destroy(t.cellCoords.x,t.cellCoords.y,0)),l=[])},editDeleteMore:()=>{[p.select,p.playStaticSelect].includes(t.state)||(f++,g(t.gridEditor.destroy(t.cellCoords.x,t.cellCoords.y,f)),l=[])},editDeleteFix:()=>{t.gridEditor.destroyEnd()},editUndo:()=>{let m=t.gridEditor.undo();m.data.length&&(g(m.data),m.length&&e.updateReadonlyRegions(),t.state!=p.playFollow&&u(m.returnX,m.returnY),[p.select,p.playStaticSelect].includes(t.state)&&c(p.default))},editRedo:()=>{let m=t.gridEditor.redo();m.data.length&&(g(m.data),m.length&&e.updateReadonlyRegions(),t.state!=p.playFollow&&u(m.returnX,m.returnY))},miscMuteTrack:(m,I)=>{I?e.muteTrack(m):e.unmuteTrack(m)},miscDrawPlayhead:m=>{e.drawPlayhead(m)},miscDrawLoopMarker:()=>{e.drawLoopMarker(t.loop.start,t.loop.end)},miscClearLoop:()=>{t.loop={start:Number.NaN,end:Number.NaN},e.drawLoopMarker(t.loop.start,t.loop.end),S()},getPlayAnimation:m=>{switch(m){case kt.follow:return c(p.playFollow),a.fn.navMoveRow;default:return c(p.playStatic),a.fn.miscDrawPlayhead}}}},i=t.gridCols[0],o=!1,s=!1,l=[],f=0;function c(m){switch(m){case p.default:{[p.playStatic,p.select].includes(t.state)?(t.currentPlayRow=0,e.clearPlayhead(),e.clearSelection()):t.state==p.playStaticSelect&&(e.clearPlayhead(),m=p.select);break}case p.playFollow:{[p.select,p.playStaticSelect].includes(t.state)&&S();break}case p.playStatic:{t.state==p.select&&(S(),m=p.playStaticSelect);break}case p.select:break;case p.playStaticSelect:break}t.state=m,e.setState(m)}function u(m,I){t.cellCoords.x=m,t.cellCoords.y=I,e.move(t.cellCoords.x,t.cellCoords.y),l=[],t.setStatus()}function b(){t.state==p.playStatic?c(p.playStaticSelect):c(p.select),t.gridSelection.x=t.cellCoords.x,t.gridSelection.y=t.cellCoords.y,e.drawSelection(t.gridSelection)}function S(){c(t.state==p.playStaticSelect?p.playStatic:p.default),t.gridSelection.w=0,t.gridSelection.h=0,e.clearSelection(),o=!1}function g(m){for(let I of m)for(let O=0;O<I.d.length;O++)q(I.x+O,I.y,I.d[O])}function q(m,I,O){let fe="";Number.isNaN(O)||(O==666?fe="*":fe=t.gridCols[m%t.gridCols.length].displayMask(O)),fe!=n[m][I].s&&(n[m][I].s=fe,n[m][I].v=O,m==t.cellCoords.x&&I==t.cellCoords.y?e.updateActiveCell(fe):e.updateCell(m,I,fe))}function C(){t.gridSelection.y+t.gridSelection.h!=0&&(t.gridSelection.h--,e.drawSelection(t.gridSelection))}function X(){t.gridSelection.y+t.gridSelection.h!=n[0].length-1&&(t.gridSelection.h++,e.drawSelection(t.gridSelection))}function P(){t.gridSelection.x+t.gridSelection.w!=0&&(t.gridSelection.w--,e.drawSelection(t.gridSelection),l=[],i=t.gridCols[t.cellCoords.x%t.gridCols.length])}function Y(){t.gridSelection.x+t.gridSelection.w!=t.gridSize.w-1&&(t.gridSelection.w++,e.drawSelection(t.gridSelection))}function $(){t.gridSelection.h=-t.gridSelection.y,e.drawSelection(t.gridSelection)}function ce(){t.gridSelection.h!=n[0].length-t.gridSelection.y-1&&(t.gridSelection.h=n[0].length-t.gridSelection.y-1,e.drawSelection(t.gridSelection))}function Ge(){t.gridSelection.w=-t.gridSelection.x,e.drawSelection(t.gridSelection),l=[],i=t.gridCols[t.cellCoords.x%t.gridCols.length]}function k(){t.gridSelection.w=t.gridSize.w-t.gridSelection.x-1,e.drawSelection(t.gridSelection)}return a}var p={default:0,select:1,playFollow:2,playStatic:3,playStaticSelect:4},Ct=class extends A{_name="comp-canvas-grid";_markup=`
    <div id="container">
      <canvas id="cnv-grid"></canvas>
      <canvas id="cnv-select"></canvas>
      <canvas id="cnv-playhead"></canvas>
      <canvas id="cnv-readonly"></canvas>
    </div>
  `;cssVars={padding:0,width:"100%",height:"100%"};_css(e){return`
      :host {
        // width: 100%;
        // height: 100%;
        flex-grow: 1;
      }
      #container {
        display: block;
        position: relative;
        padding: ${this.cssVars.padding}px;
        width: ${this.cssVars.width};
        height: ${this.cssVars.height};
        overflow: hidden;
      }
      canvas {
        position: absolute;
      }
      #cnv-grid {
        z-index: 0;
      }
      #cnv-select {
        z-index: 1;
      }
      #cnv-playhead {
        z-index: 2;
      }
      #cnv-readonly {
        z-index: 3;
      }
    `}_typedData;_canvasElements;_offscreenCanvases;_gridWorker;_container;constructor(e){super(e),super._applyMarkup(),this._data=e}connectedCallback(){this._applyMarkup(),this._typedData=this._data,this._container=this.element("#container"),this.initCanvases(),this.initCanvasWorker({theme:this._typedData.theme,size:this._typedData.gridSize,cols:this._typedData.gridCols,fontSize:this._typedData.gridFontSize,cellPadding:this._typedData.gridCellPadding,dividerWidth:this._typedData.gridDividerWidth,loop:this._typedData.loop,initialData:this._typedData.initialData,intialReadOnlyRegions:this._typedData.initialReadOnlyRegions})}initCanvases(){this._canvasElements={grid:this.element("#cnv-grid"),select:this.element("#cnv-select"),playhead:this.element("#cnv-playhead"),readonly:this.element("#cnv-readonly")};let e={width:800,height:this._container.getBoundingClientRect().height};function n(r){return r.width=e.width*window.devicePixelRatio,r.height=e.height*window.devicePixelRatio,r.style.width=`${e.width}px`,r.style.height=`${e.height}px`,r.transferControlToOffscreen()}this._offscreenCanvases={grid:n(this._canvasElements.grid),select:n(this._canvasElements.select),playhead:n(this._canvasElements.playhead),readonly:n(this._canvasElements.readonly)}}initCanvasWorker(e){this._gridWorker=Fe("grid");let n=new Array;for(let a=0;a<e.size.w;a++)n.push(e.cols[a%e.cols.length].chars);let r={canvases:this._offscreenCanvases,width:this._container.getBoundingClientRect().width,height:this._canvasElements.grid.offsetHeight,dpr:window.devicePixelRatio,fontFamily:e.theme.def.appFontFamily,fontSize:parseInt(e.fontSize.slice(0,-2)),cellPadding:e.cellPadding,size:e.size,colours:{bColGrid:e.theme.grid.bColGrid,bColBeatMarkers:e.theme.grid.bColBeatMarkers,colText:e.theme.grid.colGrid,bColActiveRow:e.theme.grid.bColActiveRow,colActiveRow:e.theme.grid.colActiveRow,bColActiveCell:e.theme.grid.bColActiveCell,colActiveCell:e.theme.grid.colActiveCell,bColStepNumbers:e.theme.grid.bColStepNumbers,colStepNumbers:e.theme.grid.colStepNumbers,bColStepNumbersDivider:e.theme.grid.bColStepNumbersDivider,bColGrab:e.theme.grid.bColGrab,bColMute:e.theme.grid.bColMute,bColPlayhead:e.theme.grid.bColPlayhead,bColLoopMarker:e.theme.grid.bColLoopMarker,bColReadonly:e.theme.grid.bColReadOnly},columnWidths:n,sectionColumns:e.cols.length,dividersWidth:e.dividerWidth,gridData:e.initialData.map(a=>a.map(i=>i.s)),loop:e.loop};this._gridWorker.postMessage({msg:"init",...r},[this._offscreenCanvases.grid,this._offscreenCanvases.select,this._offscreenCanvases.playhead,this._offscreenCanvases.readonly]),window.addEventListener("resize",a=>{this._gridWorker.postMessage({msg:"resize",width:this._container.getBoundingClientRect().width}),this._typedData.cellCoords.x=0}),this.setData(e.initialData,e.intialReadOnlyRegions,e.cols)}setData(e,n,r){if(!e.length){this._gridWorker.postMessage({msg:"clear"});return}let a=new Array(e.length);for(let i=0;i<e.length;i++){a[i]=new Array(e[i].length);let o=r[i%r.length].displayMask;for(let s=0;s<e[i].length;s++){let l=e[i][s];l.s=Number.isNaN(l.v)?"":o(l.v),a[i][s]=l.s}}this._gridWorker.postMessage({msg:"setData",gridData:a,readOnlyRegions:n}),this._typedData.initialReadOnlyRegions=n}setState(e){this._gridWorker.postMessage({msg:"setState",state:e})}move(e,n){this._gridWorker.postMessage({msg:"move",x:e,y:n})}drawSelection(e){this._gridWorker.postMessage({msg:"drawSelection",selection:e})}clearSelection(){this._gridWorker.postMessage({msg:"clearSelection"})}updateActiveCell(e){this._gridWorker.postMessage({msg:"updateActiveCell",value:e})}updateCell(e,n,r){this._gridWorker.postMessage({msg:"updateCell",x:e,y:n,value:r})}muteTrack(e){this._gridWorker.postMessage({msg:"mute",trackIndex:e})}unmuteTrack(e){this._gridWorker.postMessage({msg:"unmute",trackIndex:e})}drawPlayhead(e){this._gridWorker.postMessage({msg:"drawPlayhead",row:e})}clearPlayhead(){this._gridWorker.postMessage({msg:"clearPlayhead"})}drawLoopMarker(e,n){this._gridWorker.postMessage({msg:"drawLoopMarker",startRow:e,endRow:n}),this._gridWorker.postMessage({msg:"draw"})}activate(){this._gridWorker.postMessage({msg:"activate"})}deactivate(){this._gridWorker.postMessage({msg:"deactivate"})}updateReadonlyRegions(){this._gridWorker.postMessage({msg:"updateReadOnly",ror:this._typedData.initialReadOnlyRegions})}};var Se={};B(Se,{Element:()=>At,get:()=>Qr});function Qr(t){let e=new At(t);return{data:t,element:e,fn:{get value(){return t.value},set value(r){t.value=r,e.setValue(t.value)},incValue:()=>{t.value!=t.max&&(t.value++,e.setValue(t.value))},decValue:()=>{t.value!=t.min&&(t.value--,e.setValue(t.value))},incStepValue:()=>{t.value!=t.max&&(t.value+t.step>t.max?t.value=t.max:t.value+=t.step,e.setValue(t.value))},decStepValue:()=>{t.value!=t.min&&(t.value-t.step<t.min?t.value=t.min:t.value-=t.step,e.setValue(t.value))}}}}var At=class extends A{_name="";_markup="";_cssVars={};_css(e){return`
      :host {}
    `}_typedData;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this._typedData=this._data,this.setValue(this._typedData.value)}setValue(e){this.shadow.innerHTML=e.toString().padStart(this._typedData.digits,"0")}};var Xe={};B(Xe,{Element:()=>Pt,get:()=>Jr});function Jr(t){let e=new Pt(t),n={data:t,element:e,fn:{input:async()=>new Promise((r,a)=>{e.input.addEventListener("change",async()=>{e.style.display="none",e.input.files[0]||a(),r(e.input.files[0])},{once:!0}),e.input.addEventListener("cancel",()=>{e.style.display="none"},{once:!0}),e.input.click()})}};return document.body.appendChild(e),n}var Pt=class extends A{_name="";_markup=`
    <input
      type="file"
      accept="audio/wav" />
  `;_cssVars={};_css(e){return`
      :host {
        display: none;
      }
    `}input;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this.input=this.element("input");let e=this._data,n=Q.get({theme:e.theme,content:"",overlay:!0});this.shadow.appendChild(n.element)}};var Te={};B(Te,{Element:()=>It,get:()=>Zr});var kn=!1;function Zr(t){let e=new It(t);return{data:t,element:e,fn:{activate:()=>{kn=!0,e.setSelectedColumn(t.selectedColumnIndex),t.setStatus()},deactivate:()=>{kn=!1,e.clearSelectedColumn()},navUp:()=>{t.selectedRowIndex=t.selectedRowIndex==0?t.items.length-1:t.selectedRowIndex-1,e.setSelectedItem(t.selectedRowIndex),t.setStatus()},navDown:()=>{t.selectedRowIndex=t.selectedRowIndex==t.items.length-1?0:t.selectedRowIndex+1,e.setSelectedItem(t.selectedRowIndex),t.setStatus()},navTop:()=>{t.selectedRowIndex=0,e.setSelectedItem(t.selectedRowIndex),t.setStatus()},navBottom:()=>{t.selectedRowIndex=t.items.length-1,e.setSelectedItem(t.selectedRowIndex),t.setStatus()},navLeft:()=>{t.selectedColumnIndex=t.selectedColumnIndex==0?t.columns.length-1:t.selectedColumnIndex-1,e.setSelectedColumn(t.selectedColumnIndex),t.setStatus()},navRight:()=>{t.selectedColumnIndex=t.selectedColumnIndex==t.columns.length-1?0:t.selectedColumnIndex+1,e.setSelectedColumn(t.selectedColumnIndex),t.setStatus()},navRow:r=>{r<0||r>t.items.length-1||(t.selectedRowIndex=r,e.setSelectedItem(r))},inputFill:()=>{if(!t.columnEditable[t.selectedColumnIndex](t.items[t.selectedRowIndex]))return;let r=t.editor.fill(t.selectedColumnIndex,t.selectedRowIndex,!0);Number.isNaN(r)||e.setSelectedValue(t.columnDisplayMasks[t.selectedColumnIndex](r))},inputInc:()=>{if(!t.columnEditable[t.selectedColumnIndex](t.items[t.selectedRowIndex]))return;let r=t.editor.add(t.selectedColumnIndex,t.selectedRowIndex,1,!0);Number.isNaN(r)||e.setSelectedValue(t.columnDisplayMasks[t.selectedColumnIndex](r))},inputDec:()=>{if(!t.columnEditable[t.selectedColumnIndex](t.items[t.selectedRowIndex]))return;let r=t.editor.add(t.selectedColumnIndex,t.selectedRowIndex,-1,!0);Number.isNaN(r)||e.setSelectedValue(t.columnDisplayMasks[t.selectedColumnIndex](r))},inputIncStep:()=>{if(!t.columnEditable[t.selectedColumnIndex](t.items[t.selectedRowIndex]))return;let r=t.editor.addStep(t.selectedColumnIndex,t.selectedRowIndex,1,!0);Number.isNaN(r)||e.setSelectedValue(t.columnDisplayMasks[t.selectedColumnIndex](r))},inputDecStep:()=>{if(!t.columnEditable[t.selectedColumnIndex](t.items[t.selectedRowIndex]))return;let r=t.editor.addStep(t.selectedColumnIndex,t.selectedRowIndex,-1,!0);Number.isNaN(r)||e.setSelectedValue(t.columnDisplayMasks[t.selectedColumnIndex](r))},editDelete:()=>{t.items[t.selectedRowIndex][t.selectedColumnIndex]=Number.NaN;let r=".".padEnd(t.columns[t.selectedColumnIndex].chars,"\xA0");e.setSelectedValue(r)},updateValue:(r,a,i)=>{t.items[r][a]=i;let o=t.columnDisplayMasks[a](t.items[r][a]);e.setItemValue(r,a,o)},addItem:r=>{t.items.push(r),e.addItem(t.items.length-1,r)},getSelected:()=>t.items[t.selectedRowIndex][t.selectedColumnIndex]}}}var It=class extends A{_typedData;_name="grid-selector";_markup=`
    <div id="items"></div>
    <div id="overlay"></div>
  `;_cssVars={};_css(e){return`
      :host {
        box-sizing: border-box;
        height: 100%;
        overflow-y: hidden;
        display: flex;
        flex-direction: column;
      }
      #items {
        flex-grow: 1;
        margin: 0;
        padding: 0;
        overflow-y: hidden;
      }
      .item {
        display: flex;
        gap: .2em;
      }
      .item *:not(.data) {
        padding: 1px 4px;
      }
      .item.selected {
        background-color: ${e.grid.bColActiveRow};
        color: ${e.grid.colActiveRow};
      }
      .data {
        flex-grow: 1;
        display: flex;
        gap: 1em;
        overflow-x: hidden;
        white-space: nowrap;
      }
      .data div {
        flex-grow: 1;
      }
      .data > div.selected {
        background-color: ${e.grid.bColActiveCell};
        color: ${e.grid.colActiveCell};
      }
      .data > div:first-child {
        // flex-grow: 1;
        overflow-x: hidden;
        width: 50px;
        text-overflow: ellipsis;
      }
    `}_divItems;_divItemsRect;_divItemHeight;_lastSelectedItem;get lastSelectedItem(){return this._lastSelectedItem}_selectedColumnIndex;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this._typedData=this._data,this._divItems=this.element("#items"),this.setItems(this._typedData.items),this._divItemsRect=this._divItems.getBoundingClientRect();let e=this.element(".item");this._divItemHeight=Math.ceil(e.getBoundingClientRect().height),this.setSelectedItem(this._typedData.selectedRowIndex),this.clearSelectedColumn()}setItems(e){for(let n=0;n<e.length;n++)this.addItem(n,e[n]);this._lastSelectedItem=this.element(".item"),this._selectedColumnIndex=0}addItem(e,n){let r=document.createElement("div");r.classList.add("item");let a=document.createElement("div");a.innerText=`${e.toString().padStart(2,"0")}:`,r.appendChild(a);let i=document.createElement("div");i.classList.add("data");for(let o=0;o<this._typedData.columns.length;o++){let s=n[o],l=this._typedData.columns[o],f=Number.isNaN(s)?".".padEnd(l.chars,"\xA0"):this._typedData.columnDisplayMasks[o](s),c=document.createElement("div");c.innerText=f,i.appendChild(c)}r.appendChild(i),this._divItems.appendChild(r)}setItemValue(e,n,r){this._divItems.querySelectorAll(".item")[e].children[1].children[n].innerHTML=r}setSelectedItem(e){this._lastSelectedItem.classList.remove("selected");let n=this.elements(".item")[e];n.classList.add("selected"),n.offsetTop+this._divItemHeight-this._divItems.scrollTop>this._divItems.offsetTop+this._divItemsRect.height?this._divItems.scrollTop=n.offsetTop+this._divItemHeight-(this._divItems.offsetTop+this._divItemsRect.height):this._divItems.offsetTop+this._divItems.scrollTop>n.offsetTop&&(this._divItems.scrollTop=n.offsetTop-this._divItems.offsetTop),this.clearSelectedColumn(),this._lastSelectedItem=n,kn&&this.setSelectedColumn(this._selectedColumnIndex)}setSelectedColumn(e){this.clearSelectedColumn(),this._lastSelectedItem.children[1].children[e]?.classList.add("selected"),this._selectedColumnIndex=e}clearSelectedColumn(){this._lastSelectedItem.children[1].children[this._selectedColumnIndex]?.classList.remove("selected")}setSelectedValue(e){this._lastSelectedItem.children[1].children[this._selectedColumnIndex].innerHTML=e}};var Ce={};B(Ce,{Element:()=>Rt,get:()=>ea});function ea(t){let e=new Rt(t);return{data:t,element:e,fn:{navUp:()=>{t.selectedIndex=t.selectedIndex==0?t.items.length-1:t.selectedIndex-1,e.setSelectedItem(t.selectedIndex)},navDown:()=>{t.selectedIndex=t.selectedIndex==t.items.length-1?0:t.selectedIndex+1,e.setSelectedItem(t.selectedIndex)},navTop:()=>{t.selectedIndex=0,e.setSelectedItem(t.selectedIndex)},navBottom:()=>{t.selectedIndex=t.items.length-1,e.setSelectedItem(t.selectedIndex)},pushItem:r=>{t.items.push(r),e.pushItem(r),t.selectedIndex=t.items.length-1,e.setSelectedItem(t.selectedIndex)},removeItem:r=>{t.items.splice(r,1),e.removeItem(r)},setSelectedItem:r=>{t.items.length&&(r>t.items.length-1||r<0||(t.selectedIndex=r,e.setSelectedItem(t.selectedIndex)))}}}}var Rt=class extends A{_name="list-selector";_markup=`
    <div id="items"></div>
  `;_cssVars={};_css(e){return`
      :host {
        overflow-y: hidden;
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
      }
      #items {
        flex-grow: 1;
        overflow-y: hidden;
        display: flex;
        flex-direction: column;
        gap: .3rem;
      }
      .item {
        padding: .2rem;
      }
      .item.selected {
        background-color: ${e.grid.bColActiveRow};
        color: ${e.grid.colActiveRow};
      }
    `}_typedData;_divItems;_divItemHeight;_lastSelectedItem;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this._typedData=this._data,this._divItems=this.element("#items"),this._typedData.items.length&&(this.setItems(this._typedData.items),this._divItemHeight=Math.ceil(this.element(".item").getBoundingClientRect().height),this.setSelectedItem(this._typedData.selectedIndex))}setItems(e){for(let n=0;n<e.length;n++){let r=document.createElement("div");r.classList.add("item"),r.innerText=this._typedData.showIndex?`${n}: ${e[n]}`:`${e[n]}`,this._divItems.appendChild(r)}this._lastSelectedItem=this.element(".item")}pushItem(e){let n=document.createElement("div");n.classList.add("item"),n.innerText=this._typedData.showIndex?`${this._typedData.items.length-1}: ${e}`:`${e}`,this._divItems.appendChild(n),this._typedData.items.length==1&&(this._divItemHeight=Math.ceil(this.element(".item").getBoundingClientRect().height))}removeItem(e){this.elements(".item")[e].remove()}setSelectedItem(e){this._lastSelectedItem?.classList.remove("selected");let n=this.elements(".item")[e];n.classList.add("selected");let r=this._divItems.getBoundingClientRect().height;e==0?this._divItems.scrollTop=0:n.offsetTop+this._divItemHeight-this._divItems.scrollTop>r?this._divItems.scrollTop=n.offsetTop+this._divItemHeight-r:n.offsetTop<this._divItems.scrollTop&&(this._divItems.scrollTop=n.offsetTop-6),this._lastSelectedItem=n}};var Ie={};B(Ie,{Element:()=>Et,get:()=>ta});function ta(t){let e=new Et(t);return{data:t,element:e,fn:{}}}var Et=class extends A{_name="scope";_markup=`
    <canvas width="0" height="0"></canvas>
  `;_cssVars={};_css(e){return`
      :host {
        // flex-grow: 1;
      }
    `}_typedData;_canvas;_offscreenCanvas;_scopeWorker;_analyser;_scopeData;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this._typedData=this._data,this.initScope(),this._canvas=this.element("canvas"),this.initCanvas(),this._scopeWorker=Fe("scope"),this._scopeWorker.onmessage=n=>{this._scopeData=n.data};let e={offscreenCanvas:this._offscreenCanvas,dpr:window.devicePixelRatio,width:this._canvas.offsetWidth,height:this._canvas.offsetHeight,colours:{colScope:this._typedData.theme.meter.colBackground,colLine:this._typedData.theme.meter.colSafe,colClip:this._typedData.theme.meter.colClip},bufferLength:this._analyser.frequencyBinCount};this._scopeWorker.postMessage({msg:"init",...e},[this._offscreenCanvas]),this.draw()}initScope(){this._analyser=this._typedData.ac.createAnalyser(),this._analyser.fftSize=2048,this._typedData.source.connect(this._analyser),this._scopeData=new Uint8Array(this._analyser.frequencyBinCount)}initCanvas(){let e=this._typedData.size?this._typedData.size:this.getBoundingClientRect();this._canvas.width=e.width*window.devicePixelRatio,this._canvas.height=e.height*window.devicePixelRatio,this._canvas.style.width=`${e.width}px`,this._canvas.style.height=`${e.height}px`,this._offscreenCanvas=this._canvas.transferControlToOffscreen()}draw(){this._scopeData.length&&(this._analyser.getByteTimeDomainData(this._scopeData),this._scopeWorker.postMessage({msg:"draw",scopeData:this._scopeData},[this._scopeData.buffer]))}clear(){this._scopeWorker.postMessage({msg:"clear"})}};var Ye={};B(Ye,{Element:()=>Tt,get:()=>na});function na(t){let e=new Tt(t);return{data:t,element:e,fn:{}}}var Tt=class extends A{_name="meter";_markup=`
    <canvas class="left" width="0" height="0"></canvas>
    <canvas class="right" width="0" height="0"></canvas>
  `;_cssVars={};_css(e){return`
      :host {
        // flex-grow: 1;
        display: flex;
        flex-direction: column;
        border: ${e.def.borderThickness} solid ${e.region.bColBorderInActive};
      }
    `}_typedData;_canvasL;_canvasR;_offscreenCanvasL;_offscreenCanvasR;_meterWorkerL;_meterWorkerR;_analyserL;_analyserR;_peakDataL;_peakDataR;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this._typedData=this._data,this.initMeter(),this._canvasL=this.element(".left"),this._canvasR=this.element(".right"),this._offscreenCanvasL=this.initCanvas(this._canvasL),this._offscreenCanvasR=this.initCanvas(this._canvasR),this._meterWorkerL=Fe("meter"),this._meterWorkerR=Fe("meter");let e={dpr:window.devicePixelRatio,orientation:this._typedData.orientation,width:this._canvasL.offsetWidth,height:this._canvasL.offsetHeight,colours:{colBackground:this._typedData.theme.meter.colBackground,colBorder:this._typedData.theme.meter.colBorder,colSafe:this._typedData.theme.meter.colSafe,colClip:this._typedData.theme.meter.colClip},bufferLength:this._analyserL.frequencyBinCount};this._meterWorkerL.postMessage({msg:"init",...e,offscreenCanvas:this._offscreenCanvasL},[this._offscreenCanvasL]),this._meterWorkerR.postMessage({msg:"init",...e,offscreenCanvas:this._offscreenCanvasR},[this._offscreenCanvasR]),this.draw()}initMeter(){this._analyserL=this._typedData.ac.createAnalyser(),this._analyserL.fftSize=2048,this._peakDataL=new Float32Array(this._analyserL.fftSize),this._analyserR=this._typedData.ac.createAnalyser(),this._analyserR.fftSize=2048,this._peakDataR=new Float32Array(this._analyserR.fftSize);let e=this._typedData.ac.createChannelSplitter(2);this._typedData.source.connect(e),e.connect(this._analyserL,0),e.connect(this._analyserR,1)}initCanvas(e){let n=this._typedData.canvasSize?this._typedData.canvasSize:this.getBoundingClientRect();return e.width=n.width*window.devicePixelRatio,e.height=n.height*window.devicePixelRatio/2,e.style.width=`${n.width}px`,e.style.height=`${n.height/2}px`,e.transferControlToOffscreen()}setMeterData(e,n){let r=0;for(let a of e)r+=a*a;n.postMessage({msg:"draw",meterData:Math.sqrt(r/e.length)*2})}draw(){this._analyserL.getFloatTimeDomainData(this._peakDataL),this._analyserR.getFloatTimeDomainData(this._peakDataR),this.setMeterData(this._peakDataL,this._meterWorkerL),this.setMeterData(this._peakDataR,this._meterWorkerR)}clear(){this._meterWorkerL.postMessage({msg:"clear"}),this._meterWorkerR.postMessage({msg:"clear"})}};var Q={};B(Q,{Element:()=>Nt,get:()=>ra});function ra(t){let e=new Nt(t);return{data:t,element:e,fn:{}}}var Nt=class extends A{_name="modal";_markup=`
    <div id="content"></div>
  `;_cssVars={};_css(e){return`
      :host {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }
      #overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        opacity: .4;
      }
    `}constructor(e){super(e)}connectedCallback(){this._applyMarkup();let e=this._data;if(e.overlay){let n=document.createElement("div");n.id="overlay",this.prependElement(n)}typeof e.content=="object"?this.element("#content").appendChild(e.content):this.element("#content").innerHTML=e.content}};var J={};B(J,{Element:()=>qt,get:()=>aa});function aa(t){let e=document.querySelector("#app"),n=e.querySelectorAll(".modal").length,r={...t,overlay:!n},a=new qt(r);a.classList.add("modal");let i=t.controlRouter.activeRegion,o=`modal_${n}`,s={data:t,element:a,fn:{confirm:async()=>new Promise((l,f)=>{t.controlRouter.add(o,{Enter:()=>{e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),l(!0)},Escape:()=>{e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),l(!1)}}),t.controlRouter.set(o,!0)}),addToast:a.addToast}};return e.appendChild(a),s}var qt=class extends A{_name="modal-confirm";_markup=`
  `;_cssVars={};_css(e){return""}constructor(e){super(e)}_window;connectedCallback(){this._applyMarkup();let e=this._data,n=document.createElement("div");n.style.padding="6px",n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="center",n.style.textAlign="center",n.style.fontSize="1.2em",n.innerHTML=e.message;let r=[{keycode:"Enter",text:e.confirm}];e.cancel.length&&r.push({keycode:"Esc",text:e.cancel});let a=V.get({theme:e.theme,size:{w:300,h:null},header:e.header,content:[n],actions:r}),i=Q.get({theme:e.theme,content:a.element,overlay:e.overlay});this.shadow.appendChild(i.element),this._window=a.element}addToast(e){this._window.addToast(e)}};var ye={};B(ye,{Element:()=>Mt,get:()=>ia});function ia(t){let e=document.querySelector("#app"),n=e.querySelectorAll(".modal").length,r={...t,overlay:!n},a=new Mt(r);a.classList.add("modal");let i=t.controlRouter.activeRegion,o=`modal_${n}`,s={data:t,element:a,fn:{load:()=>new Promise((l,f)=>{t.cancel?t.controlRouter.add(o,{Escape:()=>{e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),f("cancel")}}):t.controlRouter.add(o,{}),t.controlRouter.set(o,!0);let c=window.setInterval(()=>{a.setProgress(t.fnProgress(500))},500);t.fnLoad().then(()=>{a.setProgress(100),window.clearInterval(c),e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),l()}).catch(u=>{e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),f(u)})})}};return e.appendChild(a),s}var Mt=class extends A{_name="modal-loading";_markup=`
  `;_cssVars={};_css(e){return""}constructor(e){super(e)}_divProgressBar;connectedCallback(){this._applyMarkup();let e=this._data,n=document.createElement("div");n.style.textAlign="center",n.style.fontSize="1.2em",n.innerHTML=e.message;let r=document.createElement("div");r.style.width="80%",r.style.height="12px",r.style.border=`1px solid ${e.theme.def.borderColor}`,this._divProgressBar=document.createElement("div"),this._divProgressBar.style.height="100%",this._divProgressBar.style.width="0",this._divProgressBar.style.backgroundColor=e.theme.def.color,r.appendChild(this._divProgressBar);let a=new Array;e.cancel&&a.push({keycode:"Esc",text:"Cancel"});let i=V.get({theme:e.theme,size:{w:300,h:150},header:e.header,content:[n,r],actions:a}),o=Q.get({theme:e.theme,content:i.element,overlay:e.overlay});this.shadow.appendChild(o.element)}setProgress(e){this._divProgressBar.style.width=`${e}%`}};var Ne={};B(Ne,{Element:()=>Lt,get:()=>oa});function oa(t){let e=document.querySelector("#app"),n=e.querySelectorAll(".modal").length,r={...t,overlay:!n},a=new Lt(r);a.classList.add("modal");let i=t.controlRouter.activeRegion,o=`modal_${n}`,s={data:t,element:a,fn:{activate:()=>{t.controlRouter.add(o,{Enter:async()=>{await t.items[a.menu.data.selectedIndex].fn()},Escape:()=>{e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i)},ArrowUp:a.menu.fn.navUp,ArrowDown:a.menu.fn.navDown}),t.controlRouter.set(o,!0)},deactivate:()=>{e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set("",!0)}}};return e.appendChild(a),s}var Lt=class extends A{_name="modal-menu";_markup="";_cssVars={};_css(e){return`
      :host {}
    `}_typedData;menu;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this._typedData=this._data,this.menu=Ce.get({theme:this._typedData.theme,items:this._typedData.items.map(r=>r.text),selectedIndex:0,showIndex:!1});let e=V.get({theme:this._typedData.theme,size:this._typedData.size?this._typedData.size:{w:400,h:280},header:this._typedData.header,content:[this.menu.element],actions:[]}),n=Q.get({theme:this._typedData.theme,content:e.element,overlay:this._typedData.overlay});this.shadow.appendChild(n.element)}};var ke={};B(ke,{Element:()=>Gt,get:()=>sa});function sa(t){let e=document.querySelector("#app"),n=e.querySelectorAll(".modal").length,r={...t,overlay:!n},a=new Gt(r);a.classList.add("modal");let i=t.controlRouter.activeRegion,o=`modal_${n}`,s={data:t,element:a,fn:{alert:async()=>new Promise((l,f)=>{t.controlRouter.add(o,{Escape:()=>{e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),l()},KeyC:()=>{console.log(t.error),navigator.clipboard.writeText(`${t.error}
${t.error.stack}`)}}),t.controlRouter.set(o,!0)})}};return e.appendChild(a),s}var Gt=class extends A{_name="modal-error";_markup=`
  `;_cssVars={};_css(e){return""}constructor(e){super(e)}_window;connectedCallback(){this._applyMarkup();let e=this._data,n=document.createElement("div");n.style.height="100%",n.style.display="flex",n.style.flexDirection="column",n.style.justifyContent="center",n.style.textAlign="center",n.style.fontSize="1.2em",n.innerHTML=e.message;let r=V.get({theme:e.theme,size:{w:300,h:150},header:e.header,content:[n],actions:[{keycode:"C",text:"Copy error to clipboard"},{keycode:"Esc",text:"Close"}]}),a=Q.get({theme:e.theme,content:r.element,overlay:e.overlay});this.shadow.appendChild(a.element),this._window=r.element}};var Re={};B(Re,{Element:()=>Bt,get:()=>la});function la(t){let e=document.querySelector("#app"),n=e.querySelectorAll(".modal").length,r={...t,overlay:!n},a=new Bt(r);a.classList.add("modal");let i=t.controlRouter.activeRegion,o=`modal_${n}`,s={data:t,element:a,fn:{prompt:()=>new Promise((l,f)=>{t.controlRouter.add(o,{Enter:async()=>{let c=a.getValue();for(let u of t.validation)if(!await u.func(c)){a.addToast(u.message);return}e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),l(a.getValue())},Escape:()=>{e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),l("")}}),t.controlRouter.set(o,!0)}),addToast:a.addToast}};return e.appendChild(a),s}var Bt=class extends A{_name="modal-prompt";_markup=`
  `;_cssVars={};_css(e){return""}constructor(e){super(e)}_window;_prompt;connectedCallback(){this._applyMarkup();let e=this._data,n=je.get(e);n.element.style.height="100%";let r=V.get({theme:e.theme,size:{w:300,h:150},header:e.header,content:[n.element],actions:[{keycode:"Enter",text:e.confirm},{keycode:"Esc",text:e.cancel}]}),a=Q.get({theme:e.theme,content:r.element,overlay:e.overlay});this.shadow.appendChild(a.element),this._prompt=n.element,this._window=r.element}getValue(){return this._prompt.getValue()}addToast(e){this._window.addToast(e)}};var Qe={};B(Qe,{Element:()=>Ft,get:()=>da});function da(t){t.startStep=0,t.endStep=0;let e=document.querySelector("#app"),n=e.querySelectorAll(".modal").length,r={...t,overlay:!n},a=new Ft(r);a.classList.add("modal");let i=t.controlRouter.activeRegion,o=`modal_${n}`,s=0;function l(){a.controls[1].data.value<a.controls[0].data.value&&(s?a.controls[0].fn.value=a.controls[1].data.value:a.controls[1].fn.value=a.controls[0].data.value)}let f={data:t,element:a,fn:{confirm:async()=>new Promise((c,u)=>{t.controlRouter.add(o,{ArrowUp:()=>{let b=s;s=s?0:1,a.nav(b,s)},ArrowDown:()=>{let b=s;s=s?0:1,a.nav(b,s)},"*KeyF ArrowRight":()=>{a.controls[s].fn.incValue(),l()},"*KeyF ArrowLeft":()=>{a.controls[s].fn.decValue(),l()},"*KeyF ArrowUp":()=>{a.controls[s].fn.incStepValue(),l()},"*KeyF ArrowDown":()=>{a.controls[s].fn.decStepValue(),l()},Enter:()=>{t.startStep=a.controls[0].data.value,t.endStep=a.controls[1].data.value,e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),c(!0)},Escape:()=>{e.removeChild(a),t.controlRouter.remove(o),t.controlRouter.set(i),c(!1)}}),t.controlRouter.set(o,!0)}),addToast:a.addToast}};return e.appendChild(a),a.nav(1,0),f}var Ft=class extends A{_name="modal-render";_markup=`
  `;_cssVars={};_css(e){return""}constructor(e){super(e)}_typedData;_window;controls;connectedCallback(){this._applyMarkup(),this._typedData=this._data;let e=document.createElement("div");e.style.padding="6px",e.style.width="150px",e.style.height="100%",e.style.display="flex",e.style.flexDirection="column",e.style.justifyContent="center",e.style.fontSize="1.2em",this.controls=new Array,this.controls.push(Se.get({theme:this._typedData.theme,digits:3,min:1,max:100,step:10,value:1})),this.controls.push(Se.get({theme:this._typedData.theme,digits:3,min:1,max:100,step:10,value:1})),e.appendChild(this._getNumberDiv(this.controls[0].element,"Start step")),e.appendChild(this._getNumberDiv(this.controls[1].element,"End step"));let n=[{keycode:"Enter",text:"Export track"},{keycode:"Esc",text:"Cancel"}],r=V.get({theme:this._typedData.theme,size:{w:300,h:null},header:"Export track audio",content:[e],actions:n}),a=Q.get({theme:this._typedData.theme,content:r.element,overlay:this._typedData.overlay});this.shadow.appendChild(a.element),this._window=r.element}_getNumberDiv(e,n){let r=document.createElement("div");r.style.display="flex";let a=document.createElement("div");return a.innerText=`${n}:`,a.style.flexGrow="1",a.style.padding="3px 4px",e.style.padding="3px 4px",r.appendChild(a),r.appendChild(e),r}addToast(e){this._window.addToast(e)}nav(e,n){this.controls[e].element.style.backgroundColor=this._typedData.theme.window.bColBody,this.controls[e].element.style.color=this._typedData.theme.def.color,this.controls[n].element.style.backgroundColor=this._typedData.theme.grid.bColActiveRow,this.controls[n].element.style.color=this._typedData.theme.grid.colActiveRow}};var Je={};B(Je,{Element:()=>Wt,get:()=>ca});function ca(t){let e=new Wt(t);return{data:t,element:e,fn:{activate:()=>{e.selectControl(t.selectedControlIndex)},deactivate:()=>{e.deselectControl()},drawMeter:()=>{e.meter.element.draw()},clearMeter:()=>{e.meter.element.clear()},navUp:()=>{e.selectControl(t.selectedControlIndex-1)&&t.selectedControlIndex--},navDown:()=>{e.selectControl(t.selectedControlIndex+1)&&t.selectedControlIndex++},inputInc:()=>{e.controlValueSetters[t.selectedControlIndex].incValue(),t.selectedControlIndex==1?t.seqs.Transport.setBpm(e.controlValueSetters[t.selectedControlIndex].value):t.masterGain.gain.setValueAtTime(e.controlValueSetters[t.selectedControlIndex].value/100,t.ac.currentTime)},inputDec:()=>{e.controlValueSetters[t.selectedControlIndex].decValue(),t.selectedControlIndex==1?t.seqs.Transport.setBpm(e.controlValueSetters[t.selectedControlIndex].value):t.masterGain.gain.setValueAtTime(e.controlValueSetters[t.selectedControlIndex].value/100,t.ac.currentTime)},inputIncStep:()=>{e.controlValueSetters[t.selectedControlIndex].incStepValue(),t.selectedControlIndex==1?t.seqs.Transport.setBpm(e.controlValueSetters[t.selectedControlIndex].value):t.masterGain.gain.setValueAtTime(e.controlValueSetters[t.selectedControlIndex].value/100,t.ac.currentTime)},inputDecStep:()=>{e.controlValueSetters[t.selectedControlIndex].decStepValue(),t.selectedControlIndex==1?t.seqs.Transport.setBpm(e.controlValueSetters[t.selectedControlIndex].value):t.masterGain.gain.setValueAtTime(e.controlValueSetters[t.selectedControlIndex].value/100,t.ac.currentTime)}}}}var Wt=class extends A{_name="master-info";_markup=`
    <div class="container">
      <div class="controls"></div>
    </div>
  `;_cssVars={};_css(e){return`
      :host {
        flex-grow: 1;
        display: flex;
      }
      .container {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .control {
        display: flex;
        align-items: center;
      }
      .control > * {
        padding: 1px 4px;
      }
      .control > *:first-child {
        flex-grow: 1;
      }
      .control.selected {
        background-color: ${e.grid.bColActiveRow};
        color: ${e.grid.colActiveRow};
      }
      .control.selected > *:last-child {
        background-color: ${e.grid.bColActiveCell};
        color: ${e.grid.colActiveCell};
      }
    `}_typedData;controlValueSetters;meter;constructor(e){super(e)}connectedCallback(){this._typedData=this._data,this._applyMarkup();let e=this.element(".container");this.meter=Ye.get({theme:this._typedData.theme,canvasSize:{width:e.offsetWidth,height:20},ac:this._typedData.ac,source:this._typedData.masterGain,orientation:"horizontal"}),e.prepend(this.meter.element),this.controlValueSetters=[];let n=this.element(".controls"),r=Se.get({theme:this._typedData.theme,digits:3,min:0,max:100,step:10,value:this._typedData.gain});this.controlValueSetters.push(r.fn),n.appendChild(this._getControlElement("gain",r.element));let a=Se.get({theme:this._typedData.theme,digits:3,min:1,max:300,step:10,value:this._typedData.bpm});this.controlValueSetters.push(a.fn),n.appendChild(this._getControlElement("bpm",a.element)),this.meter.element.draw()}_getControlElement(e,n){let r=document.createElement("div");r.classList.add("control");let a=document.createElement("label");return a.innerText=`${e}:`,r.appendChild(a),r.appendChild(n),r}selectControl(e){let n=this.element(".controls").children[e];return n?(this.element(".selected")?.classList.remove("selected"),n.classList.add("selected"),!0):!1}deselectControl(){this.element(".selected")?.classList.remove("selected")}};var Ze={};B(Ze,{Element:()=>$t,get:()=>ua});function ua(t){let e=new $t(t),n="";return{data:t,element:e,fn:{activate:()=>{t.setStatus()},deactivate:()=>{},drawMeters:()=>{for(let a of e.scopes)a.element.draw()},clearMeters:()=>{for(let a of e.scopes)a.element.clear()}}}}var $t=class extends A{_name="pattern-info";_markup="";_cssVars={};_css(e){return`
      :host {
        flex-grow: 1;
        display: flex;
        gap: 10px;
      }
      .scope {
        flex-grow: 1;
        border: ${e.def.borderThickness} solid ${e.region.bColBorderInActive};
      }
    `}_typedData;scopes;constructor(e){super(e)}connectedCallback(){this._typedData=this._data,this._applyMarkup();let e=new Array;for(let a=0;a<this._typedData.patternCount;a++){let i=document.createElement("div");i.classList.add("scope"),e.push(i),this.shadow.appendChild(i)}this.scopes=new Array;let n={width:e[0].clientWidth,height:e[0].clientHeight-3};for(let a=0;a<this._typedData.patternCount;a++){let i=e[a],o=Ie.get({theme:this._typedData.theme,size:n,ac:this._typedData.ac,source:this._typedData.gainNodes[a]});this.scopes.push(o),i.appendChild(o.element)}let r=!1;window.addEventListener("resize",a=>{this.scopes=new Array;for(let i=0;i<this._typedData.patternCount;i++){let o=e[i];o.innerHTML=""}r||(r=!0,setTimeout(()=>{let i={width:e[0].clientWidth,height:e[0].clientHeight-3};for(let o=0;o<this._typedData.patternCount;o++){let s=e[o],l=Ie.get({theme:this._typedData.theme,size:i,ac:this._typedData.ac,source:this._typedData.gainNodes[o]});this.scopes.push(l),s.appendChild(l.element)}r=!1},500))})}clear(){for(let e of this.scopes)e.element.clear()}};var je={};B(je,{Element:()=>Ot,get:()=>ma});function ma(t){let e=new Ot(t);return{data:t,element:e,fn:{}}}var Ot=class extends A{_name="prompt";_markup=`
    <input type="text" value=""/>
  `;_cssVars={};_css(e){return`
      :host {
        width: 100%;
        align-items: center;
        display: flex;
      }
      input {
        flex-grow: 1;
        height: 1.2rem;
        font-family: ${e.def.appFontFamily};
        border: 0;
        border-bottom: 1px dotted ${e.def.color};
        padding: 2px 0;
        background-color: ${e.window.bColBody};
        color: ${e.window.colPrompt};
        caret-color: ${e.def.color};
      }
      input:focus {
        outline: none;
      }
      input::selection {
        background-color: black;
        color: white;
      }
      input::placeholder {
        color: ${e.def.color};
      }
    `}_input;constructor(e){super(e)}connectedCallback(){this._applyMarkup();let e=this._data;this._input=this.element("input"),this._input.maxLength=e.maxLength,this._input.placeholder=e.placeholder,this._input.value=e.value.substring(0,e.maxLength),this._input.select(),this._input.focus()}getValue(){return this._input.value}};var Kt={};B(Kt,{Element:()=>Vt,get:()=>pa});function pa(t){function e(a){let i=new AudioBuffer({sampleRate:a.sampleRate,numberOfChannels:a.numberOfChannels,length:a.length});for(let o=0;o<a.numberOfChannels;o++){let s=new Float32Array(a.length);a.copyFromChannel(s,o,0);let l=new Float32Array(a.length),f=s.length-1;for(let c of s)l[f]=c,f--;i.copyToChannel(l,o,0)}return i}let n=new Vt(t);return{data:t,element:n,fn:{activate:()=>{n.setSelectedControl(t.controlIndex)},deactivate:()=>{n.setSelectedControl(null)},navUp:()=>{t.controlIndex!=0&&(t.controlIndex--,n.setSelectedControl(t.controlIndex))},navDown:()=>{t.controlIndex!=n.controlCount-1&&(t.controlIndex++,n.setSelectedControl(t.controlIndex))},navLeft:()=>{},navRight:()=>{},action:()=>{if(t.buffer)switch(n.getSelectedControl(t.controlIndex)){case"reverse":t.buffer=e(t.buffer),n.drawBuffer(t.buffer)}}}}}var Vt=class extends A{_name="";_markup=`
    <div id="container">
      <canvas></canvas>
      <div id="controls">
        <div class="region">
          <button type="button" class="control reverse">Reverse</button>
          <button type="button" class="control second">Second</button>
          <button type="button" class="control third">Third</button>
        </div>
        <div class="region"></div>
        <div class="region"></div>
        <div class="region"></div>
      </div>
    </div>
  `;_cssVars={};_css(e){return`
      #container {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      canvas {
        flex-shrink: 1;
      }
      #controls {
        display: flex;
      }
      .region {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      button {
        width: 100px;
        // border: ${e.def.borderThickness} solid ${e.def.borderColor};
        border: none;
        color: ${e.def.color};
        background-color: ${e.palette.mid};
        font-family: ${e.def.appFontFamily};
        font-size: ${e.def.fontSize};
      }
      button.selected {
        background-color: ${e.palette.highest};
      }
    `}constructor(e){super(e)}_canvas;_ctx;_fillBackground;_fillWaveform;controlCount;connectedCallback(){this._applyMarkup();let e=this._data;if(!e.buffer){this.shadow.innerHTML="no buffer";return}this._canvas=this.element("canvas"),this._ctx=this._canvas.getContext("2d"),this._fillBackground=e.theme.palette.high,this._fillWaveform="black",this.initCanvas(),this.drawBuffer(e.buffer),this.controlCount=this.elements(".control").length}initCanvas(){let e=this._canvas.getBoundingClientRect();this._canvas.width=e.width*window.devicePixelRatio,this._canvas.height=e.height*window.devicePixelRatio,this._canvas.style.width=`${e.width}px`,this._canvas.style.height=`${e.height}px`}drawBuffer(e){this._ctx.fillStyle=this._fillBackground,this._ctx.fillRect(0,0,this._canvas.width,this._canvas.height),this._ctx.strokeStyle=this._fillWaveform;let n=Math.ceil(e.getChannelData(0).length/this._ctx.canvas.width),r=e.numberOfChannels>1?this._ctx.canvas.height/4:this._ctx.canvas.height/2,a=r;for(let i=0;i<e.numberOfChannels;i++){this._ctx.beginPath();let o=e.getChannelData(i),s=0;for(let l=0;l<o.length;l+=n){let f=r+o[l]*a;this._ctx.lineTo(s,f),s++}this._ctx.stroke(),r+=r*2}}setSelectedControl(e){let n=this.element(".selected");n&&n.classList.remove("selected"),e!=null&&this.elements(".control")[e].classList.add("selected")}getSelectedControl(e){return this.element(".selected").classList.item(1)||null}};var zt={};B(zt,{Element:()=>Ht,get:()=>ha});function ha(t){let e=new Ht(t);return{data:t,element:e,fn:{update:r=>{e.update(r)}}}}var Ht=class extends A{_name="status-bar";_markup=`
    <div>&nbsp;</div>
  `;_cssVars={};_css(e){return`
      :host {
        border: ${e.def.borderThickness} dotted ${e.palette.high};
        padding: 3px;
        background-color: ${e.palette.low};
      }
    `}_divStatus;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this._divStatus=this.element("div")}update(e){e.length?this._divStatus.innerText=e:this._divStatus.innerHTML="&nbsp;"}};var V={};B(V,{Element:()=>Ut,get:()=>fa});function fa(t){let e=new Ut(t);return{data:t,element:e,fn:{}}}var Ut=class extends A{_name="window";_markup=`
    <div id="container">
      <div id="header"></div>
      <div id="content"></div>
      <div id="toast">
        <div id="toast-item"></div>
      </div>
      <div id="actions"></div>
    </div>
  `;_cssVars={};_css(e){return`
      :host {
        max-width: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
      }
      #container {
        position: relative; /* required for z-index to work */
        width: ${this._typedData.size.w}px;
        max-width: 100%; /* required to shrink along horizontal axis in a flex container */
        ${this._typedData.size.h?`height: ${this._typedData.size.h}px`:""};
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-sizing: border-box;
        border: ${e.def.borderThickness} solid ${e.def.borderColor};
        border-radius: ${e.def.borderRadius};
        background-color: ${e.window.bColBody};
      }
      #container > * {
        padding: 6px;
      }
      #header {
        border-bottom: 1px solid ${e.def.borderColor};
        border-radius: ${e.def.borderRadius};
        background-color: ${e.window.bColHead};
        color: ${e.window.colHead};
        font-family: ${e.def.headerFontFamily};
        font-size: 1.3em;
        // font-style: italic;
        letter-spacing: 0.3rem;
      }
      #content {
        position: relative;
        flex-grow: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 6px;
      }
      #content > * {
        overflow: hidden;
      }
      #toast {
        display: none;
        flex-direction: column;
      }
      #toast > div {
        width: fit-content;
        background-color: ${e.window.bColToast};
        color: ${e.window.colToast};
        padding: 0 2px;
      }
      #actions {
        display: none;
        flex-direction: column;
        gap: 2px;
        border-top: 1px solid ${e.def.borderColor};
        color: ${e.def.color};
      }
    `}_typedData;constructor(e){super(e),this._typedData=this._data}connectedCallback(){this._applyMarkup(),this.element("#header").innerText=this._typedData.header;for(let e of this._typedData.content)this.element("#content").appendChild(e);if(this._typedData.actions.length){let e=this.element("#actions");e.style.display="flex";for(let n of this._typedData.actions){let r=document.createElement("div");r.innerText=`[${n.keycode}] -> ${n.text}`,e.appendChild(r)}}}addToast(e){this.element("#toast-item").innerText=e,this.element("#toast").style.display="flex"}};var et=()=>{let t={},e={modkeys:[],map:{}},n="",r=[];function a(s){if(r.length>3){r=[];return}let l=s.code,f=parseInt(s.key);Number.isNaN(f)||(l="Digit"),r.push(l);let c=r.join(" "),u=e.map[c];u&&(u(f)&&s.preventDefault(),r=r.filter(b=>b.includes("*"))),e.modkeys.includes(l)&&(r=[`*${l}`])}function i(s){let l;e.modkeys.includes(s.code)?(l=`-*${s.code}`,r=r.filter(c=>c!=`*${s.code}`)):(l=`-${s.code}`,r=r.filter(c=>c!=s.code));let f=e.map[l];f&&(s.preventDefault(),f()),r=r.filter(c=>c.includes("*"))}function o(){r=[]}return document.addEventListener("keydown",a),document.addEventListener("keyup",i),document.addEventListener("blur",o),{add:(s,l)=>{let f=new Array;for(let[c]of Object.entries(l)){let u=c.match(/(?<=\*)(.*?)(?=\ )/gm);u&&u.length&&!f.includes(u[0])&&f.push(u[0])}t[s]={modkeys:f,map:l}},remove:s=>{t[s]&&delete t[s]},set:(s,l=!1)=>{if(s=="")return e={modkeys:new Array,map:{}},n="",l&&(r=[]),!0;let f=t[s];return f?(e=f,n=s,l&&(r=[]),!0):!1},get:s=>t[s].map||null,close:()=>{document.removeEventListener("keydown",a),document.removeEventListener("keyup",i),document.removeEventListener("blur",o)},get activeRegion(){return n}}};var Pn=class extends A{_markup=`
    <h1>\u25D6 Soft Elixir \u25E1</h1>
    <div id="slot-window"></div>
  `;_css(e){return`
      :host {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        // justify-content: center;
      }
      h1 {
        margin: 0;
        border-bottom: 1px dotted;
        padding: 4px;
        font-size: 1.3em;
        font-family: ${e.def.headerFontFamily};
        font-weight: 400;
        letter-spacing: .281em;
        white-space: nowrap;
      }
      #slot-window {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
    `}_typedData;_controlRouter;_demoTracks;_userTracks;constructor(e){super(e)}async connectedCallback(){this._applyMarkup(),this._typedData=this._data;let e=Ce.get({theme:this._typedData.theme,items:["Demo tracks","User tracks"],selectedIndex:0,showIndex:!1});this._userTracks=await this._typedData.db.tracks_getAllUser();let n=Ce.get({theme:this._typedData.theme,items:this._userTracks.map(f=>f.id),selectedIndex:0,showIndex:!0});this._demoTracks=await this._typedData.db.tracks_getAllDemo();let r=Ce.get({theme:this._typedData.theme,items:this._demoTracks.map(f=>f.id),selectedIndex:0,showIndex:!0}),a={w:340,h:230},i={theme:this._typedData.theme,size:a,header:"Select track",content:[e.element],actions:[]},o={theme:this._typedData.theme,size:a,header:"User Tracks",content:[n.element],actions:[{keycode:"C",text:"Create new empty track"},{keycode:"D",text:"Delete track"}]},s={theme:this._typedData.theme,size:a,header:"Demo Tracks",content:[r.element],actions:[{keycode:"V",text:"Create new track with samples from selected track"}]},l=this.element("#slot-window");l.appendChild(V.get(i).element),this._controlRouter=et(),this._controlRouter.add("region",{ArrowUp:e.fn.navUp,ArrowDown:e.fn.navDown,Enter:()=>{switch(l.innerHTML="",e.data.selectedIndex){case 0:{l.appendChild(V.get(s).element),this._controlRouter.set("demo-tracks");break}case 1:{l.appendChild(V.get(o).element),this._controlRouter.set("user-tracks");break}}}}),this._controlRouter.add("user-tracks",{ArrowUp:n.fn.navUp,ArrowDown:n.fn.navDown,Enter:()=>{this._userTracks[n.data.selectedIndex]&&this.dispatchEvent(new CustomEvent("track-selected",{detail:{type:"user",data:this._userTracks[n.data.selectedIndex]}}))},KeyC:async()=>{let f=await this._createEmptyTrack();l.innerHTML="",l.appendChild(V.get(o).element),f==""?n.fn.setSelectedItem(0):(n.fn.pushItem(f),n.fn.setSelectedItem(n.data.items.length-1))},KeyV:()=>!0,KeyD:async()=>{if(!n.data.items.length)return;let f=this._userTracks[n.data.selectedIndex].id;this._deleteTrack(f).then(c=>{c&&(n.fn.removeItem(n.data.selectedIndex),this._userTracks.splice(n.data.selectedIndex,1),n.fn.setSelectedItem(0)),l.innerHTML="",l.appendChild(V.get(o).element)})},Escape:()=>{l.innerHTML="",l.appendChild(V.get(i).element),this._controlRouter.set("region")}}),this._controlRouter.add("demo-tracks",{ArrowUp:r.fn.navUp,ArrowDown:r.fn.navDown,Enter:()=>{this.dispatchEvent(new CustomEvent("track-selected",{detail:{type:"demo",data:this._demoTracks[r.data.selectedIndex]}}))},KeyV:()=>!0,Escape:()=>{l.innerHTML="",l.appendChild(V.get(i).element),this._controlRouter.set("region")}}),this._controlRouter.set("region")}disconnectedCallback(){this._controlRouter.close()}async _createEmptyTrack(){let e=await Re.get({header:"Create empty track",theme:this._typedData.theme,placeholder:"Track name",value:"",maxLength:20,controlRouter:this._controlRouter,confirm:"Create track",cancel:"Cancel",validation:[{func:n=>!!n.length,message:"Track name cannot be empty"},{func:n=>!this._userTracks.filter(r=>r.id==n).length,message:"Track name must be unique"}]}).fn.prompt();return e==""?"":(await ye.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Creating song...",message:`<div>Creating song <br />&lt<b>${e}</b>&gt</div>`,fnLoad:async()=>{let n=await this._typedData.db.tracks_getEmpty(e);this._userTracks.push(n)},fnProgress:n=>0}).fn.load().catch(async n=>(await ke.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Error",message:"Can't create song data",error:n}).fn.alert(),"")),e)}async _deleteTrack(e){if(!await J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Confirm delete",message:`<div>Are you sure you want to delete '<b>${e}</b>'?</div>`,confirm:"Delete track",cancel:"Cancel"}).fn.confirm())return!1;let r=!1;return await ye.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Deleting song...",message:`<div>Deleting song <br />&lt<b>${e}</b>&gt</div>`,fnLoad:async()=>{r=await this._typedData.db.tracks_delete(e)},fnProgress:a=>0}).fn.load().catch(async a=>(await ke.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Error",message:"Can't create song data",error:a}).fn.alert(),"")),r}};var en={};B(en,{Element:()=>Tn});var ct=class{get head(){return this._head}get tail(){return this._tail}get count(){let e=0;return this.forEach(()=>{e++}),e}forEach(e){if(!this._head)return;let n=this._head;for(;n;)e(n.data),n=n.next}forEachConditional(e){if(!this._head)return;let n=this._head;for(;n&&!e(n);)n=n.next}getDataByIndex(e){if(!this._head)return null;let n=this._head,r=0;for(;n;){if(r==e)return n;n=n.next,r++}return null}find(...e){if(!this._head)return;let n=this._head,r=a=>{for(let i of e)if(a[i.key]!=i.value)return!1;return!0};for(;n;){if(r(n.data))return n;n=n.next}return null}push(e){if(!this._head)this._head={data:e},this._tail=this._head;else{let n=this._tail;this._tail={data:e,previous:n},n.next=this._tail}}insertBefore(e,n){let r={data:e,previous:n.previous?n.previous:null,next:n};return n.previous&&(n.previous.next=r),n.previous=r,n==this._head&&(this._head=r),r}insertAtIndex(e,n){let r=this.getDataByIndex(n);r&&this.insertBefore(e,r)}insertUniqueBefore(e,n,...r){if(!this._head)return this._head={data:e},this._tail=this._head,this._head;let a=this._head;for(;;){if(this.dataMatch(a.data,e,...r))return a.data=e,a;if(n(a.data))return this.insertBefore(e,a);if(!a.next)return a.next={data:e,previous:a},this._tail=a.next,this._tail;a=a.next}}remove(...e){let n=this.find(...e);n!=null&&(n.previous&&(n.previous.next=n.next),n.next&&(n.next.previous=n.previous),n==this._head&&(this._head=n.next||null),n==this._tail&&(this._tail=n.previous||null),n=null)}dataMatch(e,n,...r){if(r.length==0)return e==n;for(let a of r)if(e[a]!=n[a])return!1;return!0}};var Yt=class{constructor(e,n,r,a){this._ac=e;this._tickCallback=n;this._bpm=r;this._tpqn=a;this._running=!1;this._runInterval=.05;this._runIntervalId=null;this._lookaheadInterval=.1}get tickInterval(){return this._tickInterval}get scheduledTickTimes(){return this._scheduledTickTimes}getTickIntervalInSeconds(e){return 1/(e/60*this._tpqn)}run(){for(;this._nextTickTime<this._ac.currentTime+this._lookaheadInterval;)this._tickCallback(this._nextTickTime),this._scheduledTickTimes.push(this._nextTickTime),this._scheduledTickTimes.length>20&&this._scheduledTickTimes.shift(),this._nextTickTime+=this._tickInterval}start(){if(this._running)return;this._tickInterval=this.getTickIntervalInSeconds(this._bpm),this._nextTickTime=this._ac.currentTime+.05,this._scheduledTickTimes=new Array;let e=this;this._runIntervalId=setInterval(()=>{e.run()},this._runInterval*1e3),this._running=!0}stop(){clearInterval(this._runIntervalId),this._running=!1}setBpm(e){this._bpm=e,this._tickInterval=this.getTickIntervalInSeconds(e)}get running(){return this._running}};var jt=(t,e,n)=>{let a=120,i=new Array,o=new Array,s,l,f=new Array,c=new Array,u=1,b=1,S=!1,g=new Yt(t,h=>{Ke.tick(l,h)},a,4),q="[Seqs] ERROR ->",C={itemDoesNotExist:(h,v)=>`${q} ${h} id {${v}} does not exist.`,itemAlreadyExists:(h,v)=>`${q} ${h} id {${v}} already exists.`};function X(h,v){return h.find(x=>x.id==v)||null}function P(h,v,y){let x=X(h,v);if(!x)throw new Error(C.itemDoesNotExist(y,v));return x}function Y(h,v,y){if(X(h,v))throw new Error(C.itemAlreadyExists(y,v))}function $(h,v){return h*4+(v||0)}function ce(h,v){return(h-1)*4+(v||1)}function Ge(h){return[Math.ceil(h/4),h%4||4]}let k={loadSongData:h=>{s=h,I.load(h.patterns),O.load(h.sequences)},getTrackData:()=>{let h=new Array;for(let y of i){let x=new Array;y.events.forEach(D=>{x.push({time:Ge(D.tick),data:D.data})}),h.push({id:y.id,dur:y.ticks,events:x,data:y.data})}let v=new Array;for(let y of o)v.push({id:y.id,steps:y.steps.map(x=>({ticks:x.ticks,patterns:x.patterns.map(D=>D.data==null?Number.NaN:D.data.id)}))});return{patterns:h,sequences:v}}},m={play:function(h=!0){g.running||(b=l.step,u=l.stepTick,c=[],f=[],S=h,g.start())},resume:()=>{!g||g.running||g.start()},pause:()=>{g?.running&&g.stop()},get running(){return g?.running||!1},get tick(){return u},get step(){return b},doTick:()=>{fe.tick()},get bpm(){return a},setBpm:h=>{a=h,g.setBpm(a)}},I={get all(){return i},load:h=>{for(let v of h){let y=new Array;for(let D of v.events)y.push({tick:Array.isArray(D.time)?ce(D.time[0],D.time[1]):D.time,data:D.data});let x=Array.isArray(v.dur)?$(v.dur[0],v.dur[1]):v.dur;I.create(v.id,x,y,v.data)}},log:h=>{let v=P(i,h,"pattern");return st.log(v)},create:(h,v,y,x)=>{Y(i,h,"pattern"),i.push(st.create(h,v,y,x))},insertEvent:(h,v)=>{let y=P(i,h,"pattern"),x=st.insertEvent(y,v);Ke.insertEvent(l,h,x)},removeEvent:(h,v)=>{let y=P(i,h,"pattern");st.removeEvent(y,v),Ke.removeEvent(l,h,v)},getEvent:(h,v)=>{let y=P(i,h,"pattern");return st.getEvent(y,v)},getNextEmpty:()=>{for(let h of i)if(!h.events.count&&!l.steps.filter(v=>v.patterns.filter(y=>y.data?.id==h.id).length).length)return h.id;return Number.NaN},setLength:(h,v)=>{let y=P(i,h,"pattern");y.ticks=v,y.events.forEachConditional(x=>x.data.tick>v?(x.previous.next=null,!0):!1)},copy:(h,v)=>{let y=P(i,h,"pattern"),x=P(i,v,"pattern");x.ticks=y.ticks,x.events=new ct,x.data={...y.data};let D=0;y.events.forEach(G=>{x.events.push({tick:G.tick,data:[...G.data]}),D++})}},O={get sequence(){return l},getStep:(h,v)=>P(o,h,"sequence").steps[v-1],getPatterns:(h,v)=>{let y=new Array;for(let x of o[h].steps[v-1].patterns)y.push(x.data||null);return y},getLoopLength:h=>{let v=P(o,h,"sequence"),y=0,x=v.steps[v.loopStart-1];v.loopStart==v.loopEnd?y=x.loopEnd-x.loopStart+1:y=x.ticks-x.loopStart+1;for(let D=v.loopStart+1;D<=v.loopEnd;D++)D==v.loopEnd?y+=v.steps[D-1].loopEnd:y+=v.steps[D-1].ticks;return y*g.tickInterval},load:function(h){for(let v of h)o.push(Ke.create(v))},insertPattern:(h,v,y,x)=>{let D=P(o,h,"sequence"),G=P(i,x,"pattern");Ke.insertPattern(D,G,v,y)},removePattern:(h,v,y)=>{let x=P(o,h,"sequence");Ke.removePattern(x,v,y)},set:h=>{l=P(o,h,"sequence")},setStepLength:(h,v,y)=>{let x=P(o,h,"sequence");x.steps[v-1].ticks=y},setLoop:(h,v,y,x,D,G,de)=>{let j=P(o,h,"sequence");j.loopStart=v,m.running||(j.step=G),Number.isNaN(x)?j.loopEnd=j.steps.length:j.loopEnd=j.loopStart+x>j.steps.length?j.steps.length:j.loopStart+x,m.running||(j.stepTick=Number.isNaN(de)?y:de);let ge=j.steps[j.step-1];if(ge.loopStart=y,Number.isNaN(D)?ge.loopEnd=ge.ticks:ge.loopEnd=ge.loopStart+D>ge.ticks?ge.ticks:ge.loopStart+D,!m.running){for(let ve of l.steps)for(let Ee of ve.patterns)Ee&&(Ee.tick=1,Ee.data&&(Ee.event=Ee.data.events.head));Number.isNaN(de)&&(de=y);for(let ve of ge.patterns)ve&&(ve.tick=de,ve.data&&(ve.tick==1?ve.event=ve.data.events.head:ve.data.events.forEachConditional(Ee=>Ee.data.tick>=ve.tick?(ve.event=Ee,!0):!1)))}},organisePatterns:h=>{let v=P(o,h,"sequence"),y=new Array,x=0,D=1e3;for(let G of v.steps)for(let de of G.patterns){if(!de||!de.data||y.includes(de.data.id))continue;let j=i.find(ge=>ge.id==x);j&&(j.id=D,D++),de.data.id=x,y.push(x),x++}for(let G of i)y.includes(G.id)||(G.id=x,x++);i.sort((G,de)=>G.id-de.id)}},fe={tick:()=>{for(;g.scheduledTickTimes[0]<=t.currentTime;)g.scheduledTickTimes.shift(),u=f[0],f.shift(),!(u<l.steps[b-1].ticks)&&(b=b<l.loopEnd?b+1:l.loopStart)}},st={log:h=>{let v=`= PATTERN ${h.id} ================`;for(let y=1;y<=h.ticks;y++){let x=h.events.find({key:"tick",value:y});v+=`
${y} -${x?"*":"-"}-`}return v},create:(h,v,y,x)=>{let D=new ct;for(let G of y)D.push(G);return{id:h,ticks:v,events:D,data:x}},insertEvent:(h,v)=>h.events.insertUniqueBefore(v,y=>y.tick>v.tick,"tick"),removeEvent:(h,v)=>{h.events.remove({key:"tick",value:v})},getEvent:(h,v)=>h.events.find({key:"tick",value:v})},Ke={create:h=>{let v=h.steps.map(y=>({ticks:y.ticks,patterns:y.patterns.map(x=>{let D=X(i,x);return{data:D,tick:1,event:D?.events.head||null}}),loopStart:1,loopEnd:y.ticks}));return{id:h.id,steps:v,step:1,stepTick:1,loopStart:1,loopEnd:v.length}},tick:(h,v)=>{f.length>=20&&f.shift(),f.push(h.stepTick);let y=h.steps[h.step-1];for(let x=0;x<y.patterns.length;x++){let D=y.patterns[x];D?.data&&(D.event?.data.tick==D.tick&&(e(v,{event:D.event.data?.data,trackId:x}),D.event=D.event.next),h.stepTick==y.loopEnd?(D.tick=y.loopStart,D.data.events.forEachConditional(G=>G.data.tick>=D.tick?(D.event=G,!0):!1)):D.tick==y.loopEnd?(D.tick=y.loopStart,D.data.events.forEachConditional(G=>G.data.tick>=D.tick?(D.event=G,!0):!1)):D.tick==D.data.ticks?(D.tick=1,D.event=D.data.events.head):D.tick++)}if(h.stepTick==y.loopEnd?h.stepTick=y.loopStart:h.stepTick==y.ticks?h.stepTick=1:h.stepTick++,h.stepTick==1){h.step<h.loopEnd?h.step++:(h.step=h.loopStart,S||g.stop());for(let x of h.steps[h.step].patterns)x.tick=1,x.data&&(x.event=x.data.events.head)}},insertPattern:(h,v,y,x)=>{let D=1;h.step==y&&(D=h.stepTick-h.steps[y-1].ticks%v.ticks);let G;v.events.forEachConditional(j=>j.data.tick<D?!1:(G=j,!0)),G||(G=v.events.head);let de=h.steps[y-1];de.patterns[x]={data:v,tick:D,event:G}},removePattern:(h,v,y)=>{let x=h.steps[v-1],D=x.patterns[y];D&&(D.data=null,D.event=null,x.patterns.every(G=>!G.data)&&(x.ticks=n.defaultPatternLength))},insertEvent:(h,v,y)=>{let x=h.steps[h.step-1].patterns.filter(D=>D?.data?.id==v);if(x.length)for(let D of x){if(!D.event){D.event=y;continue}D.tick<y.data.tick&&(D.event?.data.tick>y.data.tick||D.tick>D.event?.data.tick)&&(D.event=y)}},removeEvent:(h,v,y)=>{let x=h.steps[h.step-1].patterns.filter(D=>D?.data?.id==v);if(x.length)for(let D of x)D.event?.data.tick==y&&(D.event=D.event.next)}};return{ac:t,ec:e,Data:k,Transport:m,Patterns:I,Sequences:O,close:()=>{m.pause(),t.close()}}};var va={gain:.5,pan:0,freq:440},ba=(t,e,n)=>{let r=t.createOscillator();return r.frequency.value=n.freq,r.start(e),r.stop(e+.05),r},ya={buffer:void 0,semitone:0,gain:.5,pan:0,transpose:0,start:0,end:0},wa=Math.pow(2,1/12),Da=48,xa=(t,e,n)=>{let r=new AudioBufferSourceNode(t,{buffer:n.buffer,playbackRate:Math.pow(wa,n.transpose+n.semitone-Da)}),a=n.start>r.buffer.duration?0:n.start,i=n.end||r.buffer.duration;return i=a+i-a>r.buffer.duration?r.buffer.duration-a:i,r.start(e,a,i),r},ut={test:{fn:ba,args:va},sample:{fn:xa,args:ya}};function Qt(t){function e(n){let r=new Array(t.columns.length);for(let a=0;a<t.columns.length;a++){let i=t.gridData[n][a];Number.isNaN(i)&&(i=t.columns[a].default),r[a]=i}return r}return{fill:(n,r,a)=>{if(!Number.isNaN(t.gridData[r][n]))return Number.NaN;let i=t.columns[n].default;return t.gridData[r][n]=i,a&&!Number.isNaN(t.gridData[r][0])&&t.eventPreview(e(r)),i},add:(n,r,a,i)=>{let o=t.columns[n],s=t.gridData[r][n],l=Number.isNaN(s)?0:s+a;return l>o.max?l=o.max:l<o.min&&(l=o.min),t.gridData[r][n]=l,o.default=l,i&&!Number.isNaN(t.gridData[r][0])&&t.eventPreview(e(r)),l},addStep:(n,r,a,i)=>{let o=t.columns[n],s=t.gridData[r][n],l=Number.isNaN(s)?0:s+o.step*a;return l>o.max?l=o.max:l<o.min&&(l=o.min),t.gridData[r][n]=l,o.default=l,i&&!Number.isNaN(t.gridData[r][0])&&t.eventPreview(e(r)),l}}}var vr=50,Sa=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],F=[{id:"buffer",displayName:"sample",digits:2,min:0,max:vr-1,step:10,default:0,chars:2,displayMask:t=>t.toString().padStart(2,"0")},{id:"semitone",displayName:"note",digits:2,min:0,max:99,step:12,default:48,chars:3,displayMask:t=>`${Sa[t%12].padEnd(2,"-")}${Math.floor(t/12)}`},{id:"gain",displayName:"gain",digits:2,min:0,max:99,step:10,default:10,chars:2,displayMask:t=>t.toString().padStart(2,"0")},{id:"pan",displayName:"pan",digits:2,min:0,max:99,step:10,default:0,chars:2,displayMask:t=>t.toString().padStart(2,"0")}],In=ut.sample,ae,te,he,We,mt,Zt,H,En,qn,tt,qe,$e,De,Me={follow:0,followFromHere:1,static:2,staticFromHere:3},me={default:0,textEntry:1},we=me.default,Tn=class extends A{_controlRouter;_markup=`
    <div id="container">
      <div id="col-1">
        <div class="row-1 control track_config">
          <div style="flex-grow: 1"></div>
        </div>
        <div class="control sample_nav"></div>
      </div>
      <div id="col-2">
        <div id="scope" class="row-1 control"></div>
        <div class="control main"></div>
      </div>
      <div id="slot-modal"></div>
    </div>
    <div id="actions"></div>
    <input
      type="file"
      id="input-sample"
      accept="audio/*"
      style="display:none" />
    <input 
      type="text"
      id="input-text" />
  `;_cssVars={flexGap:"10px"};_css(e){return`
      :host {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: ${this._cssVars.flexGap};
      }
      #container {
        flex-grow: 1;
        display: flex;
        flex-direction: row;
        gap: ${this._cssVars.flexGap};
        overflow-y: hidden;
      }
      #actions {
        border: ${e.def.borderThickness} solid ${e.def.borderColor};
        padding: 6px;
        color: ${e.palette.mid};
        background-color: ${e.palette.textHighlight};
      }
      #col-1 {
        display: flex;
        flex-direction: column;
        width: 225px;
        flex-shrink: 0;
        gap: ${this._cssVars.flexGap};
      }
      #col-2 {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: ${this._cssVars.flexGap};
      }
      .row-1 {
        height: 170px;
        flex-shrink: 0;
      }
      .sample_nav {
        flex-grow: 1;
        overflow-y: hidden;
      }
      .main {
        flex-grow: 1;
      }
      .control {
        box-sizing: border-box;
        display: flex;
      }
      .control > * {
        flex-grow: 1;
        border: ${e.def.borderThickness} solid ${e.def.borderColor};
        padding: 6px;
        background-color: ${e.window.bColBody};
        box-sizing: border-box;
      }
      .selected > * {
        border: ${e.def.borderThickness} solid ${e.def.color};
      }
      #input-text {
        position: absolute;
        display: none;
        font-family: inherit;
        font-size: inherit;
        border: none;
        border-bottom: 1px solid black;
        padding-top: 0;
        padding-bottom: 0;
      }
      #input-text:focus {
        outline: none;
      }
      #slot-modal {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    `}constructor(e){super(e)}async connectedCallback(){let e=this._data;this._applyMarkup(),ae=new AudioContext({sampleRate:44100}),te=jt(ae,Ra),te.Data.load(e.songData),te.Transport.setLoop();let n=te.Data.getDataModel();he=new Array(vr).fill({id:"",data:[666,666,666,666],buffer:null});for(let k=0;k<e.songData.samples.length;k++)he[k]={...e.songData.samples[k],buffer:null};if(e.songType=="demo")for(let k of he)k.id!=""&&(k.buffer=await Ia(ae,`demo/samples/${k.id}`));else for(let k of he);mt=ae.createGain(),mt.gain.value=1,mt.connect(ae.destination),We=new Array;for(let k of e.songData.tracks){let m=ae.createGain();m.gain.value=1,m.connect(mt),We.push({gain:m,sourceNode:null,muted:!1})}Zt=Ie.get({theme:e.theme,ac:ae,source:mt}),this.element("#scope").appendChild(Zt.element);let r=Pa(e.theme,he.map(k=>k.data),Nn),a,i;this.element(".sample_nav").appendChild(r.element),a=this.element("#input-sample"),a.addEventListener("change",async()=>{try{let k=a.files[0],m={id:k.name,data:[r.data.selectedRowIndex,666,666,666],buffer:await ae.decodeAudioData(await k.arrayBuffer())};r.data.selectedRowIndex<e.songData.samples.length?he[r.data.selectedRowIndex]=m:(he.push(m),r.fn.addItem([666,666,666,666]),F[H.buffer].max++),r.fn.updateValue(r.data.selectedRowIndex,0,r.data.selectedRowIndex)}catch(k){throw new Error(k)}});let o=r.element.lastSelectedItem.children[1].children[0].getBoundingClientRect();i=this.element("#input-text"),i.style.width=`${o.width}px`,i.style.height=`${o.height}px`,En=Aa(n,0);let s=Ca(e.theme,te,he,En,Nn);H={};for(let k=0;k<F.length;k++)H[F[k].id]=k;let l=Kt.get({theme:e.theme,ac:ae,buffer:he[r.data.selectedColumnIndex].buffer,controlIndex:0}),f=[{keycode:";",text:"See available actions for current region"}],c=bt.get({theme:e.theme,actions:f});this.element("#actions").appendChild(c.element);let u=!1,b={sample_nav:[{keycode:"C",text:"Create new sample"},{keycode:"E",text:"Erase sample"},{keycode:";",text:"...hide available actions"}],main:[]},S=et();this._controlRouter=S;let g={"*KeyQ ArrowUp":()=>{let k=[$[0],$[1]-1];k[1]<0||($=k,ce(this))},"*KeyQ ArrowDown":()=>{let k=[$[0],$[1]+1];k[1]>P.length-1||($=k,ce(this))},"*KeyQ ArrowLeft":()=>{let k=[$[0]-1,$[1]];k[0]<0||($=k,ce(this))},"*KeyQ ArrowRight":()=>{let k=[$[0]+1,$[1]];k[0]>P[$[1]].length-1||($=k,ce(this))},Semicolon:()=>{let k=u?f:b[Y];c.fn.update(k),u=!u},Space:()=>{if(we!=me.default)return!1;te.Transport.running&&(te.Transport.pause(),window.cancelAnimationFrame(qn),s.fn.setState(p.default),Zt.element.clear())},"*Space ArrowDown":()=>{Jt(Me.follow,e.songData.bpm,s)},"*Space ArrowUp":()=>{Jt(Me.static,e.songData.bpm,s)},"*Space ArrowRight":()=>{Jt(Me.followFromHere,e.songData.bpm,s)},"*Space ArrowLeft":()=>{Jt(Me.staticFromHere,e.songData.bpm,s)}};S.add("track_config",{...g}),S.add("sample_nav",{...g,ArrowUp:()=>{we==me.default&&(r.fn.navUp(),F[H.buffer].default=r.data.selectedRowIndex)},ArrowDown:()=>{we==me.default&&(r.fn.navDown(),F[H.buffer].default=r.data.selectedRowIndex)},"*KeyA ArrowUp":()=>{we==me.default&&(r.fn.navTop(),F[H.buffer].default=r.data.selectedRowIndex)},"*KeyA ArrowDown":()=>{we==me.default&&(r.fn.navBottom(),F[H.buffer].default=r.data.selectedRowIndex)},Digit:k=>{we==me.default&&(r.fn.navRow(k),F[H.buffer].default=r.data.selectedRowIndex)},ArrowLeft:()=>{we==me.default&&r.fn.navLeft()},ArrowRight:()=>{we==me.default&&r.fn.navRight()},KeyF:()=>{if(we==me.default&&r.data.selectedRowIndex!=r.data.items.length-1){if(r.data.selectedColumnIndex==0)return we=me.textEntry,i.style.display="block",i.style.top=`${o.top}px`,i.style.left=`${o.left}px`,i.value=r.data.columns[0].displayMask(r.data.items[r.data.selectedRowIndex][0]),i.select(),i.focus(),!0;r.fn.inputFill()}},"*KeyF ArrowRight":r.fn.inputInc,"*KeyF ArrowLeft":r.fn.inputDec,"*KeyF ArrowUp":r.fn.inputIncStep,"*KeyF ArrowDown":r.fn.inputDecStep,KeyE:()=>{r.data.selectedColumnIndex==0&&(he[r.data.selectedRowIndex].buffer=null),r.fn.editDelete()},KeyC:()=>{let k=this.element("#slot-modal");k.innerHTML="",k.appendChild(J.get({theme:e.theme,header:"Create new instrument",message:"THIS WILL BE A SELECTOR",confirm:"Create",cancel:"Cancel"}).element),S.set("modal_inst")},Escape:()=>{we=me.default,this.element("#input-text").style.display="none"}}),S.add("modal_inst",{Enter:()=>{this.element("#slot-modal").innerHTML="",S.set("main")},Escape:()=>{this.element("#slot-modal").innerHTML="",S.set("sample_nav")}}),S.add("main_grid",{...g,ArrowUp:s.fn.navUp,ArrowDown:s.fn.navDown,ArrowLeft:s.fn.navLeft,ArrowRight:s.fn.navRight,"*KeyA ArrowUp":s.fn.navUpEnd,"*KeyA ArrowDown":s.fn.navDownEnd,"*KeyA ArrowLeft":s.fn.navLeftEnd,"*KeyA ArrowRight":s.fn.navRightEnd,"*KeyS ArrowLeft":s.fn.navLeftTrack,"*KeyS ArrowRight":s.fn.navRightTrack,"*KeyS ArrowUp":s.fn.navUpEvent,"*KeyS ArrowDown":s.fn.navDownEvent,KeyG:s.fn.selectToggle,"*KeyG ArrowLeft":s.fn.selectPatternLeft,"*KeyG ArrowRight":s.fn.selectPatternRight,KeyF:s.fn.inputFill,Digit:k=>{s.fn.inputDigit(k),s.data.cellCoords.x%F.length==H.buffer&&r.element.setSelectedItem(F[H.buffer].default)},"*KeyF ArrowRight":()=>{s.fn.inputInc(),s.data.cellCoords.x%F.length==H.buffer&&r.element.setSelectedItem(F[H.buffer].default)},"*KeyF ArrowLeft":()=>{s.fn.inputDec(),s.data.cellCoords.x%F.length==H.buffer&&r.element.setSelectedItem(F[H.buffer].default)},"*KeyF ArrowUp":()=>{s.fn.inputIncStep(),s.data.cellCoords.x%F.length==H.buffer&&r.element.setSelectedItem(F[H.buffer].default)},"*KeyF ArrowDown":()=>{s.fn.inputDecStep(),s.data.cellCoords.x%F.length==H.buffer&&r.element.setSelectedItem(F[H.buffer].default)},KeyK:s.fn.inputKill,KeyI:s.fn.inputInterpolate,KeyX:s.fn.editCut,KeyC:s.fn.editCopy,KeyV:s.fn.editPaste,KeyB:s.fn.editMerge,KeyE:s.fn.editDelete,"*KeyE ArrowRight":s.fn.editDeleteMore,"-*KeyE":s.fn.editDeleteFix,KeyZ:s.fn.editUndo,KeyY:s.fn.editRedo,"*KeyM Digit":k=>{let m=k-1,I=!We[m].muted;s.fn.miscMuteTrack(k-1,I),We[m].muted=I,We[m].gain.gain.value=I?0:1},KeyR:()=>{Rn(s.data.cellCoords.y+1)},"*KeyR ArrowUp":()=>{Rn(s.data.cellCoords.y+1),s.fn.navUp()},"*KeyR ArrowDown":()=>{Rn(s.data.cellCoords.y+2),s.fn.navDown()}}),S.add("main_sampler",{...g,ArrowUp:l.fn.navUp,ArrowDown:l.fn.navDown,ArrowLeft:l.fn.navLeft,ArrowRight:l.fn.navRight,Enter:()=>{l.fn.action()}});let q={seq:0,sampler:1},C=q.sampler,X=["track_config","sample_nav","main"],P=[[0,0],[1,2]],Y=X.findIndex(k=>k=="main"),$=[0,1];function ce(k){let m=X[Y];switch(m){case"sample_nav":{r.data.selectedRowIndex<r.data.items.length-1?r.element.clearSelectedColumn():(r.element.setSelectedItem(0),r.element.clearSelectedColumn(),r.data.selectedRowIndex=0,F[H.buffer].default=r.data.selectedRowIndex);break}case"main":{C==q.sampler&&l.fn.deactivate();break}}switch(k.element(`.${m}`).classList.remove("selected"),Y=P[$[1]][$[0]],m=X[Y],k.element(`.${m}`).classList.add("selected"),m=="main"&&(m=C==q.seq?"main_grid":"main_sampler"),S.set(m),m){case"sample_nav":{r.element.setSelectedColumn(r.data.selectedColumnIndex);break}case"main_sampler":l.fn.activate()}}function Ge(k,m){let I=k.element(".main");I.innerHTML="";let O=X[Y]=="main";switch(m){case q.seq:{I.appendChild(s.element),O&&S.set("main_grid");break}case q.sampler:{I.appendChild(l.element),O&&S.set("main_sampler");break}}C=m}ce(this),Ge(this,q.sampler)}disconnectedCallback(){this._controlRouter.close()}};function Ca(t,e,n,r,a){let i=e.Data.getDataModel(),o=ka(i,0),s=GridEditorPatterns({seqs:e,gridData:o,columns:F,defaults:n.map(l=>l.data),patternColMap:r,trackCount:o.length/F.length,eventPreview:a});return _e.get({theme:t,gridSize:{w:o.length,h:o[0].length},gridFontSize:11,gridCellPadding:{v:3,h:4},gridDividerWidth:1,gridCols:F,gridData:o,gridSelection:{x:0,y:0,w:0,h:0},state:me.default,cellCoords:{x:0,y:0},currentPlayRow:0,loop:{start:Number.NaN,end:Number.NaN},gridEditor:s})}function ka(t,e){tt=t[0].patterns[0].ticks;let n=new Array;for(let a=0;a<t.length*F.length;a++){let i=new Array;for(let o=0;o<tt;o++)i.push({v:Number.NaN,s:""});n.push(i)}let r=0;for(let a of t){let i=a.patterns[e];for(let o of i.events)for(let s=0;s<F.length;s++)n[r+s][o.tick-1].v=o.data[s];r+=F.length}return n}function Aa(t,e){let n=new Array,r=0;for(let a of t){let i=a.patterns[e];n.push({id:i.id,startCol:r,ticks:i.ticks}),r+=F.length}return n}function Pa(t,e,n){let r={theme:t,columns:F,items:e,selectedRowIndex:0,selectedColumnIndex:0,editor:Qt({columns:F,gridData:e,eventPreview:n})};return Te.get(r)}async function Ia(t,e){try{let r=await(await fetch(e)).arrayBuffer();return await t.decodeAudioData(r)}catch(n){throw new Error(n)}}function br(t){let e=0;for(;te.Transport.scheduledTickTimes[0]<=ae.currentTime;)e++,te.Transport.scheduledTickTimes.shift();let n=De+e;n-$e+1<=qe?De=n:De=n-qe,t(De-1),Zt.element.draw(),te.Transport.running&&(qn=window.requestAnimationFrame(()=>{br(t)}))}function Jt(t,e,n){if(!te||te.Transport.running)return;let r;switch(t){case Me.follow:{gr(n),De=1,$e=1,qe=tt,n.fn.navUpEnd(),n.fn.setState(p.playFollow),r=n.fn.navMoveRow;break}case Me.followFromHere:{if(n.data.gridSelection.h){let a=hr(n.data.gridSelection);n.data.loop={start:a.start-1,end:a.end-1},n.fn.miscDrawLoopMarker()}else n.data.loop.end-n.data.loop.start>0?(fr(n.data.loop),n.fn.miscDrawLoopMarker()):(De=n.data.cellCoords.y+1,$e=1,qe=tt);n.fn.setState(p.playFollow),r=n.fn.navMoveRow;break}case Me.static:{gr(n),De=1,$e=1,qe=tt,n.fn.setState(p.playStatic),r=n.fn.miscDrawPlayhead;break}case Me.staticFromHere:{if(n.data.gridSelection.h){let a=hr(n.data.gridSelection);n.data.loop={start:a.start-1,end:a.end-1},n.fn.miscDrawLoopMarker()}else n.data.loop.end-n.data.loop.start>0?(fr(n.data.loop),n.fn.miscDrawLoopMarker()):(De=n.data.cellCoords.y+1,$e=1,qe=tt);n.fn.setState(p.playStatic),r=n.fn.miscDrawPlayhead;break}}te.Transport.play(e,De),qn=window.requestAnimationFrame(()=>{br(r)})}function hr(t){let e={start:Number.NaN,end:Number.NaN};return t.h>0?(e.start=t.y+1,e.end=t.y+t.h+1):(e.start=t.y+t.h+1,e.end=t.y+1),$e=e.start,De=e.start,qe=e.end-e.start+1,te.Transport.setLoop(e.start,e.end),e}function fr(t){$e=t.start+1,De=t.start+1,qe=t.end-t.start+1,te.Transport.setLoop(t.start+1,t.end+1)}function gr(t){te.Transport.setLoop(),t.data.loop={start:Number.NaN,end:Number.NaN},t.fn.miscDrawLoopMarker()}function Nn(t,e){let n=ut.sample,r={...n.args};for(let s in n.args){let l=e[H[s]];l!=null&&(r[s]=l)}let a=he[e[H.buffer]].buffer;if(a==null)return;r.buffer=a;let i=We[t];i.sourceNode&&i.sourceNode.stop(ae.currentTime),i.sourceNode=n.fn(ae,ae.currentTime,r),i.sourceNode.stop(ae.currentTime+1);let o=yr(i.sourceNode,r.gain);r.pan!=0&&(o=wr(o,r.pan)),o.connect(i.gain)}function Rn(t){let e=1;for(let n of En){let r=te.Patterns.getEvent(n.id,t);r&&(Nn(e,r.data.data),e++)}}var Ra=(t,e,n)=>{let r=We[n.trackId];if(r.sourceNode&&r.sourceNode.stop(e),n.event[0]==666)return;let a={...In.args};for(let s in In.args){let l=n.event[H[s]];l!=null&&(a[s]=l)}let i=he[n.event[H.buffer]].buffer;if(i==null)return;a.buffer=i,r.sourceNode=In.fn(t,e,a);let o=yr(r.sourceNode,a.gain);a.pan!=0&&(o=wr(o,a.pan)),o.connect(r.gain)};function yr(t,e){let n=ae.createGain();return n.gain.value=e/10,t.connect(n),n}function wr(t,e){let n=ae.createStereoPanner();return n.pan.value=e/10,t.connect(n),n}var mn={};B(mn,{Element:()=>un,get:()=>di});var W={insert:0,destroy:1,length:2};var tn=t=>{let e=new Array(t),n=-1;return{push:function(r){n<t-1?e=e.slice(0,n+1):(e.shift(),n--),e.push(r),n++},stepBack:function(){if(n==-1)return;let r=e[n];return n--,r},stepForwards:function(){if(n!=e.length-1)return n++,e[n]},get last(){if(!(n<0))return e[n]},get length(){return e.length},get index(){return n}}};var R,pe=tn(30),pt;function _r(t){return R=t,{length:function(e,n){return[]},kill:function(e,n){return[]},fill:function(e,n,r){if(!Number.isNaN(R.gridData[e][n]))return[];let a=R.columns[e==0?0:1].default,i=ht(e,n,a);return pe.push(i),i.newData},fillRange:function(e){return[]},amend:function(e,n,r,a){if(r==R.gridData[e][n])return[];if(r>R.columns[e==0?0:1].max||r<R.columns[e==0?0:1].min)return[];let i=ht(e,n,r);return pe.push(i),R.columns[e==0?0:1].default=r,i.newData},amendRange:function(e,n){return[]},add:function(e,n,r,a){if(e==0&&R.seqs.Transport.running)return[];let i=R.gridData[e][n],o=Number.isNaN(i)?0:i+r;o>R.columns[e==0?0:1].max?o=R.columns[e==0?0:1].max:o<R.columns[e==0?0:1].min&&(o=R.columns[e==0?0:1].min);let s=ht(e,n,o);return pe.push(s),R.columns[e==0?0:1].default=o,s.newData},addRange:function(e,n){return[]},addStep:function(e,n,r,a){if(e==0&&R.seqs.Transport.running)return[];let i=R.gridData[e][n],o=Number.isNaN(i)?0:i+R.columns[e==0?0:1].step*r;o>R.columns[e==0?0:1].max?o=R.columns[e==0?0:1].max:o<R.columns[e==0?0:1].min&&(o=R.columns[e==0?0:1].min);let s=ht(e,n,o);return pe.push(s),R.columns[e==0?0:1].default=o,s.newData},addStepRange:function(e,n){return[]},interpolateRange:function(e){return[]},destroy:function(e,n,r){if(e==0)return[];switch(r){case 0:{if(Number.isNaN(R.gridData[e][n]))return[];let a=nn(e,n);return a.fixed=!1,pe.push(a),a.newData}case 1:{let a={type:W.destroy,log:!0,fixed:!0,returnX:e,oldData:new Array,newData:new Array};a.fixed=!1;for(let o=1;o<R.gridData.length;o++)a.oldData.push({x:o,y:n,d:[R.gridData[o][n]]}),a.newData.push(nn(o,n).newData[0]);if(a.oldData.every(o=>Number.isNaN(o.d[0])))return[];let i=pe.last;return i&&!i.fixed&&(a.oldData[e-1].d[0]=i.oldData[0].d[0],pe.stepBack()),pe.push(a),a.newData}}return[]},destroyEnd:function(){let e=pe.last;e&&e.type==W.destroy&&(e.fixed=!0)},destroyRange:function(e){let n={type:W.destroy,log:!0,fixed:!0,returnX:e.x,oldData:new Array,newData:new Array},r=xr(e);for(let a=r.xStart;a<=r.xEnd;a++)for(let i=r.yStart;i<=r.yEnd;i++)n.oldData.push({x:a,y:i,d:[R.gridData[a][i]]}),n.newData.push(nn(a,i).newData[0]);return pe.push(n),n.newData},copyRange:function(e){let n=xr(e);pt={coords:n,data:new Array};for(let r=n.xStart;r<=n.xEnd;r++)for(let a=n.yStart;a<=n.yEnd;a++)pt.data.push({x:r,y:a,d:[R.gridData[r][a]]})},cutRange:function(e){return this.copyRange(e),this.destroyRange(e)},paste:function(e,n,r=!1){let a={type:W.insert,log:!0,fixed:!0,returnX:e,oldData:new Array,newData:new Array};for(let i of pt.data){let o=e+(i.x-pt.coords.xStart);if(o>=R.gridData.length)continue;let s=n+(i.y-pt.coords.yStart);s>=R.gridData[0].length||(a.oldData.push({x:o,y:s,d:[R.gridData[o][s]]}),Number.isNaN(i.d[0])?a.newData.push(nn(o,s).newData[0]):a.newData.push(ht(o,s,i.d[0]).newData[0]))}return pe.push(a),a.newData},undo:function(){let e=pe.stepBack();return e?(Dr(e.oldData),{data:e.oldData,returnX:e.returnX,returnY:e.oldData[0].y,length:!1}):{data:[],returnX:Number.NaN,returnY:Number.NaN,length:!1}},redo:function(){let e=pe.stepForwards();return e?(Dr(e.newData),{data:e.newData,returnX:e.returnX,returnY:e.newData[0].y,length:!1}):{data:[],returnX:Number.NaN,returnY:Number.NaN,length:!1}}}}function ht(t,e,n){let r={type:W.insert,log:!0,fixed:!0,returnX:t,oldData:[{x:t,y:e,d:[R.gridData[t][e]]}],newData:[{x:t,y:e,d:[n]}]};return R.gridData[t][e]=n,t>0?R.seqs.Sequences.insertPattern(R.seqId,e+1,t-1,n):(r.type==W.length,R.seqs.Sequences.setStepLength(0,e+1,n)),r}function nn(t,e){let n={type:W.destroy,log:!0,fixed:!0,returnX:t,oldData:[{x:t,y:e,d:[R.gridData[t][e]]}],newData:[{x:t,y:e,d:[Number.NaN]}]};return R.gridData[t][e]=Number.NaN,R.seqs.Sequences.removePattern(R.seqId,e+1,t-1),n}function Dr(t){for(let e of t)R.gridData[e.x][e.y]=e.d[0],e.x>0?Number.isNaN(e.d[0])?R.seqs.Sequences.removePattern(R.seqId,e.y+1,e.x-1):R.seqs.Sequences.insertPattern(R.seqId,e.y+1,e.x-1,e.d[0]):R.seqs.Sequences.setStepLength(0,e.y+1,e.d[0])}function xr(t){let e,n;t.w>0?(e=t.x,n=e+t.w):(e=t.x+t.w,n=e+t.w*-1);let r,a;return t.h>0?(r=t.y,a=r+t.h):(r=t.y+t.h,a=r+t.h*-1),{xStart:e,xEnd:n,yStart:r,yEnd:a}}var rn,Ta=new Uint8Array(16);function Mn(){if(!rn&&(rn=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!rn))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return rn(Ta)}var ne=[];for(let t=0;t<256;++t)ne.push((t+256).toString(16).slice(1));function Sr(t,e=0){return ne[t[e+0]]+ne[t[e+1]]+ne[t[e+2]]+ne[t[e+3]]+"-"+ne[t[e+4]]+ne[t[e+5]]+"-"+ne[t[e+6]]+ne[t[e+7]]+"-"+ne[t[e+8]]+ne[t[e+9]]+"-"+ne[t[e+10]]+ne[t[e+11]]+ne[t[e+12]]+ne[t[e+13]]+ne[t[e+14]]+ne[t[e+15]]}var Na=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ln={randomUUID:Na};function qa(t,e,n){if(Ln.randomUUID&&!e&&!t)return Ln.randomUUID();t=t||{};let r=t.random||(t.rng||Mn)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){n=n||0;for(let a=0;a<16;++a)e[n+a]=r[a];return e}return Sr(r)}var Gn=qa;var at={};B(at,{Element:()=>an,get:()=>ri,playTypes:()=>Le});var Cr=(t,e,n)=>{t.unshift("");let r=n,a="";i(0,0);function i(o,s){let l={x:r.x+o,y:r.y+s};if(l.x<0||l.x>e[0].length-1||l.y<0||l.y>e.length-1)return null;let f=t[e[l.y][l.x]];return!f||a==f?null:(r=l,a=f,f)}return{get currentRegion(){return a},get currentPosition(){return r},nav:i}};var w,E,ft,nt,Bn,ie={},z=tn(30),Ae;function Ar(t){return w=t,{setData:(e,n,r,a)=>{E=e,ft=n,nt=r,Bn=a},editor:()=>{for(let e=0;e<w.columns.length;e++)ie[w.columns[e].id]=e;return{length:La,kill:Ga,fill:Ba,fillRange:Ka,amend:Fa,amendRange:Ha,add:Wa,addRange:za,addStep:$a,addStepRange:Ua,interpolateRange:Xa,destroy:Va,destroyEnd:Oa,destroyRange:Pr,copyRange:Ir,cutRange:Ya,paste:ja,undo:Qa,redo:Ja}}}}function La(t,e){let n=le(t);if(Number.isNaN(n.id))return[];let r=nt.find(o=>o.x==n.startCol),a=r?.y;r?(r.y=e+1,r.h=Bn-r.y):(r={x:n.startCol,y:e+1,w:w.columns.length,h:Bn-(e+1)},nt.push(r));let i={type:W.length,log:!0,fixed:!0,returnX:n.startCol,oldLength:n.ticks,newLength:32-r.h,oldData:[],newData:[],readOnly:[]};n.ticks=e+1;for(let o=e+1;o<E[t].length;o++){i.oldData.push(re(n.startCol,o));let s=re(n.startCol,o-n.ticks);for(let l=n.startCol;l<n.startCol+w.columns.length;l++)E[l][o].v=s.d[l-n.startCol];s.y+=n.ticks,i.newData.push(s)}if(a)for(let o=a;o<r.y;o++){let s=re(n.startCol,o);s.d.every(l=>Number.isNaN(l))||w.seqs.Patterns.insertEvent(n.id,{tick:o+1,data:[...s.d]})}return w.seqs.Patterns.setLength(n.id,e+1),z.push(i),i.newData}function Ga(t,e){if(se(t,e))return[];if(E[t][e].v==666)return[];let n=le(t),r={type:W.insert,log:!0,fixed:!0,returnX:n.startCol,oldData:[re(n.startCol,e)],newData:[{x:n.startCol,y:e,d:new Array(w.columns.length).fill(666)}],readOnly:[!1]};for(let a=n.startCol;a<n.startCol+w.columns.length;a++)E[a][e].v=666;return oe(t,e,r),w.seqs.Patterns.insertEvent(n.id,{tick:e+1,data:r.newData[0].d}),z.push(r),r.newData}function Ba(t,e,n){if(se(t,e))return[];if(!Number.isNaN(E[t][e].v))return[];let r=Ve(E[le(t).startCol][e].v,t%w.columns.length),a=Pe(t,e,r);oe(t,e,a),z.push(a);let i=Oe(a.newData[0]);return n&&i.data.length&&w.eventPreview(Math.floor(t/w.columns.length),i.data),a.newData}function Fa(t,e,n,r){if(se(t,e))return[];let a=w.columns[t%w.columns.length];if(n==E[t][e].v)return[];if(n>a.max||n<a.min)return[];let i=Pe(t,e,n);oe(t,e,i),z.push(i),a.default=n;let o=Oe(i.newData[0]);return r&&o.data.length&&w.eventPreview(Math.floor(t/w.columns.length),o.data),i.newData}function Wa(t,e,n,r){if(se(t,e))return[];let a=w.columns[t%w.columns.length],i=E[t][e].v,o=Number.isNaN(i)?0:i+n;o>a.max?o=a.max:o<a.min&&(o=a.min);let s=Pe(t,e,o);oe(t,e,s),z.push(s),a.default=o;let l=Oe(s.newData[0]);return r&&l.data.length&&w.eventPreview(Math.floor(t/w.columns.length),l.data),s.newData}function $a(t,e,n,r){if(se(t,e))return[];let a=w.columns[t%w.columns.length],i=E[t][e].v,o=Number.isNaN(i)?0:i+a.step*n;o>a.max?o=a.max:o<a.min&&(o=a.min);let s=Pe(t,e,o);oe(t,e,s),z.push(s),a.default=o;let l=Oe(s.newData[0]);return r&&l.data.length&&w.eventPreview(Math.floor(t/w.columns.length),l.data),s.newData}function Oa(){let t=z.last;t&&t.type==W.destroy&&(t.fixed=!0)}function Va(t,e,n){if(se(t,e))return[];switch(n){case 0:{let r=le(t),a=re(r.startCol,e);if(Number.isNaN(a.d[t-r.startCol]))return[];if(a.d.every(o=>Number.isNaN(o)))return[];let i=ei(t,e);return i.fixed=!1,oe(t,e,i),i.log?(z.push(i),i.newData):[]}case 1:{let r=le(t);if(re(r.startCol,e).d.every(s=>Number.isNaN(s)))return[];let i=Fn({x:r.startCol,y:e,w:w.columns.length-1,h:0});i.fixed=!1;let o=z.last;if(o&&!o.fixed){let s=t%w.columns.length;i.oldData[0].d[s]=o.oldData[0].d[s],z.stepBack()}return oe(t,e,i),z.push(i),i.newData}case 2:{let r={type:W.destroy,log:!0,fixed:!0,returnX:t,oldData:[],newData:[],readOnly:new Array},a=z.last;a&&!a.fixed&&(r.oldData.push(a.oldData[0]),r.newData.push(a.newData[0]),z.stepBack());for(let i of ft){if(re(i.startCol,e).d.every(l=>Number.isNaN(l))||a&&i.startCol==a.returnX)continue;let s=Fn({x:i.startCol,y:e,w:w.columns.length-1,h:1});r.oldData.push(s.oldData[0]),r.newData.push(s.newData[0])}return r.oldData.length?(oe(t,e,r),z.push(r),r.newData):[]}}return[]}function Ka(t){if(t.w!=0)return[];let e={type:W.insert,log:!0,fixed:!0,returnX:t.x,oldData:new Array,newData:new Array,readOnly:new Array},n=le(t.x),r=Ve(E[n.startCol][t.y].v,t.x%w.columns.length);for(let a=t.y;a<=t.y+t.h&&!se(t.x,a);a++){if(!Number.isNaN(E[t.x][a].v))continue;let i=Pe(t.x,a,r);oe(t.x,a,i),e.oldData=e.oldData.concat(i.oldData),e.newData=e.newData.concat(i.newData),e.readOnly=e.readOnly.concat(i.readOnly)}return z.push(e),e.newData}function Ha(t,e){if(t.w!=0)return[];let n={type:W.insert,log:!0,fixed:!0,returnX:t.x,oldData:new Array,newData:new Array,readOnly:new Array},r=rt(t),a=w.columns[t.x%w.columns.length];for(let i=r.yStart;i<=r.yEnd;i++){let o=E[t.x][i].v;if(se(t.x,i))break;if(Number.isNaN(o)||o==666||e>a.max||e<a.min)continue;let s=Pe(t.x,i,e);oe(t.x,i,s),n.oldData=n.oldData.concat(s.oldData),n.newData=n.newData.concat(s.newData),n.readOnly=n.readOnly.concat(s.readOnly)}return z.push(n),n.newData}function za(t,e){if(t.w!=0)return[];let n={type:W.insert,log:!0,fixed:!0,returnX:t.x,oldData:new Array,newData:new Array,readOnly:new Array},r=rt(t),a=w.columns[t.x%w.columns.length];for(let i=r.yStart;i<=r.yEnd&&!se(t.x,i);i++){let o=E[t.x][i].v;if(Number.isNaN(o)||o==666)continue;let s=o+e;s>a.max?s=a.max:s<a.min&&(s=a.min);let l=Pe(t.x,i,s);oe(t.x,i,l),n.oldData=n.oldData.concat(l.oldData),n.newData=n.newData.concat(l.newData),n.readOnly=n.readOnly.concat(l.readOnly)}return z.push(n),n.newData}function Ua(t,e){if(t.w!=0)return[];let n={type:W.insert,log:!0,fixed:!0,returnX:t.x,oldData:new Array,newData:new Array,readOnly:new Array},r=rt(t),a=w.columns[t.x%w.columns.length];for(let i=r.yStart;i<=r.yEnd&&!se(t.x,i);i++){let o=E[t.x][i].v;if(Number.isNaN(o)||o==666)continue;let s=o+a.step*e;s>a.max?s=a.max:s<a.min&&(s=a.min);let l=Pe(t.x,i,s);oe(t.x,i,l),n.oldData=n.oldData.concat(l.oldData),n.newData=n.newData.concat(l.newData),n.readOnly=n.readOnly.concat(n.readOnly)}return z.push(n),n.newData}function Xa(t){let e={type:W.insert,log:!0,fixed:!0,returnX:t.x,oldData:new Array,newData:new Array,readOnly:new Array},n=rt(t),r=w.columns[t.x%w.columns.length];if(se(t.x,n.yStart))return[];if(se(t.x,n.yEnd))return[];let a=E[t.x][n.yStart].v;Number.isNaN(a)&&(a=r.min);let i=E[t.x][n.yEnd].v;Number.isNaN(i)&&(i=r.min);let o=(i-a)/(n.yEnd-n.yStart),s=a;for(let l=n.yStart;l<=n.yEnd;l++){if(E[t.x][l].v==666)continue;let f=Pe(t.x,l,Math.round(s));oe(t.x,l,f),e.oldData=e.oldData.concat(f.oldData),e.newData=e.newData.concat(f.newData),e.readOnly=e.readOnly.concat(f.readOnly),s+=o}return z.push(e),e.newData}function Pr(t){let e=Fn(t),n=e.oldData.length;for(let r=0;r<n;r++){let a={type:0,log:!1,fixed:!1,returnX:0,readOnly:[],oldData:[e.oldData[r]],newData:[e.newData[r]]};oe(a.oldData[0].x,a.oldData[0].y,a),e.oldData=e.oldData.concat(a.oldData),e.newData=e.newData.concat(a.newData),e.readOnly=e.readOnly.concat(a.readOnly)}return e.oldData.length&&z.push(e),e.newData}function Ir(t){let e=rt(t);Ae={coords:e,data:new Array};for(let n=e.xStart;n<=e.xEnd;n++){let r=le(n).startCol,a=w.columns.length-(n-r)-1;for(let i=e.yStart;i<=e.yEnd;i++){if(se(t.x,i))continue;let o=re(r,i);Ae.data.push(o)}n+=a}}function Ya(t){return Ir(t),Pr(t)}function ja(t,e,n=!1){if(kr(t).id!=kr(Ae.coords.xStart).id)return[];let r={type:W.insert,log:!0,fixed:!0,returnX:t,oldData:new Array,newData:new Array,readOnly:new Array},a=w.columns.length*ft.length;for(let i of Ae.data){if(n&&i.d.every(c=>Number.isNaN(c)))continue;let o=t+(i.x-Ae.coords.xStart);if(o>=a)continue;let s=e+(i.y-Ae.coords.yStart);if(s>=ft[o/w.columns.length].ticks||se(o,s))continue;let l,f;if(i.x<Ae.coords.xStart){l=re(o,s),f={x:Number.NaN,y:Number.NaN,d:[]};let c=Ae.coords.xStart-i.x,u=Ae.coords.xEnd>i.x+w.columns.length?w.columns.length-1:Ae.coords.xEnd-i.x;for(let b=c;b<=u;b++)f=Pe(o+b,s,i.d[b]).newData[0]}else{let c=Za(o,s,[...i.d]);l=c.oldData[0],f=c.newData[0]}r.oldData.push(l),r.newData.push(f)}return oe(t,e,r),z.push(r),r.newData}function Qa(){let t=z.stepBack();if(!t)return{data:[],returnX:Number.NaN,returnY:Number.NaN,length:!1};let e=t.oldData[0].y;if(t.type==W.length){let n=t.oldLength,r=le(t.oldData[0].x);r.ticks=n,w.seqs.Patterns.setLength(r.id,n);let a=nt.find(i=>i.x==t.oldData[0].x);a.h=32-n,a.y=n,e--}return Rr(t.oldData,t.readOnly),{data:t.oldData,returnX:t.returnX,returnY:e,length:t.type==W.length}}function Ja(){let t=z.stepForwards();if(!t)return{data:[],returnX:Number.NaN,returnY:Number.NaN,length:!1};let e=t.oldData[0].y;if(t.type==W.length){let n=t.newLength,r=le(t.oldData[0].x);r.ticks=n,w.seqs.Patterns.setLength(r.id,n);let a=nt.find(i=>i.x==t.oldData[0].x);a.h=32-n,a.y=n,e--}return Rr(t.newData,t.readOnly),{data:t.newData,returnX:t.returnX,returnY:e,length:t.type==W.length}}function Pe(t,e,n){let r={type:W.insert,log:!0,fixed:!0,returnX:t,oldData:new Array,newData:new Array,readOnly:new Array},a=le(t);r.oldData.push(re(a.startCol,e));let i=w.seqs.Patterns.getEvent(a.id,e+1)?.data;if(i&&i.data[0]==666){w.seqs.Patterns.removeEvent(a.id,e+1);for(let o=a.startCol;o<a.startCol+w.columns.length;o++)E[o][e].v=Number.NaN;i=void 0}if(i)E[t][e].v=n,r.newData.push(re(a.startCol,e)),i.data[t%w.columns.length]=n,(Number.isNaN(i.data[ie.buffer])||Number.isNaN(i.data[ie.semitone]))&&w.seqs.Patterns.removeEvent(a.id,e+1);else{E[t][e].v=n;let o=!0;if(!Number.isNaN(n)&&[ie.buffer,ie.semitone].includes(t%w.columns.length)){let s=E[a.startCol][e].v;for(let l=0;l<w.columns.length;l++)Number.isNaN(E[a.startCol+l][e].v)&&(E[a.startCol+l][e].v=Ve(s,l));r.newData.push(re(a.startCol,e))}else{let s=re(a.startCol,e);r.newData.push(s);for(let l of s.d)if(Number.isNaN(l)){o=!1;break}}o&&w.seqs.Patterns.insertEvent(a.id,Oe(r.newData[0]))}return r}function Za(t,e,n){let r={type:W.insert,log:!0,fixed:!0,returnX:t,oldData:new Array,newData:new Array,readOnly:new Array};r.oldData.push(re(t,e));let a=le(t),i=w.seqs.Patterns.getEvent(a.id,e+1)?.data;if(i){for(let o=0;o<w.columns.length;o++)i.data[o]=n[o],E[t+o][e].v=i.data[o];(Number.isNaN(n[ie.buffer])||Number.isNaN(n[ie.semitone]))&&w.seqs.Patterns.removeEvent(a.id,e+1),r.newData.push({x:t,y:e,d:i.data})}else if(!Number.isNaN(n[ie.buffer])&&!Number.isNaN(n[ie.semitone])){let o=E[a.startCol][e].v;for(let l=0;l<w.columns.length;l++)Number.isNaN(n[l])&&(n[l]=Ve(o,l)),E[t+l][e].v=n[l];r.newData.push({x:t,y:e,d:n});let s=Oe({x:t,y:e,d:n});w.seqs.Patterns.insertEvent(a.id,s)}else{for(let o=0;o<w.columns.length;o++)E[t+o][e].v=n[o];r.newData.push({x:t,y:e,d:n})}return r}function ei(t,e){let n={type:W.destroy,log:!0,fixed:!0,returnX:t,oldData:new Array,newData:new Array,readOnly:new Array},r=le(t),a=w.seqs.Patterns.getEvent(r.id,e+1)?.data;if(a)if(n.oldData.push(ti(a,r.startCol)),a.data[0]==666)for(let i=r.startCol;i<r.startCol+w.columns.length;i++)E[i][e].v=Number.NaN,w.seqs.Patterns.removeEvent(r.id,e+1);else if([ie.buffer,ie.semitone].includes(t%w.columns.length))E[t][e].v=Number.NaN,w.seqs.Patterns.removeEvent(r.id,e+1);else{let i=Ve(E[r.startCol][e].v,t%w.columns.length);if(E[t][e].v==i)return n.log=!1,n;E[t][e].v=i,a.data[t%w.columns.length]=i}else n.oldData.push(re(r.startCol,e)),E[t][e].v=Number.NaN;return n.newData.push(re(r.startCol,e)),n}function Fn(t){let e={type:W.destroy,log:!0,fixed:!0,returnX:t.x,oldData:new Array,newData:new Array,readOnly:new Array},n=rt(t);for(let r=n.yStart;r<=n.yEnd;r++)for(let a=n.xStart;a<=n.xEnd&&!se(t.x,r);a++){let i=le(a),o=w.columns.length-(a-i.startCol)-1,s=re(i.startCol,r);if(s.d.every((c,u)=>a+u>n.xStart&&Number.isNaN(c))){a+=o;continue}let l=!0,f={x:i.startCol,y:r,d:new Array(w.columns.length).fill(Number.NaN)};if(E[a][r].v==666)for(let c=i.startCol;c<i.startCol+w.columns.length;c++)E[c][r].v=Number.NaN,w.seqs.Patterns.removeEvent(i.id,r+1);else if([ie.buffer,ie.semitone].includes(a%w.columns.length)){for(let c=0;c<w.columns.length;c++){let u=i.startCol+c;u<n.xStart||u>n.xEnd?f.d[c]=s.d[c]:E[i.startCol+c][r].v=Number.NaN}w.seqs.Patterns.removeEvent(i.id,r+1)}else{let c=w.seqs.Patterns.getEvent(i.id,r+1)?.data;for(let u=0;u<w.columns.length;u++){let b=i.startCol+u;if(b<n.xStart||b>n.xEnd)f.d[u]=s.d[u];else if(c){let S=Ve(E[i.startCol][r].v,u);f.d[u]=S,E[i.startCol+u][r].v=S,c.data[u]=S}}s.d.every((u,b)=>u==f.d[b])&&(l=!1)}l&&(e.oldData.push(s),e.newData.push(f)),a+=o}return e}function Rr(t,e){for(let n=0;n<t.length;n++){let r=t[n];for(let o=0;o<r.d.length;o++)E[r.x+o][r.y].v=r.d[o];if(e[n])continue;let a=Oe(r),i=le(r.x).id;a.data.length?w.seqs.Patterns.insertEvent(i,a):w.seqs.Patterns.removeEvent(i,a.tick)}}function se(t,e){return!!nt.filter(n=>t>=n.x&&t<n.x+n.w&&e>=n.y&&e<n.y+n.h).length}function oe(t,e,n){let r=le(t);if(r.ticks+e>=E[0].length)return;let a=n.oldData.length;for(let i=0;i<a;i++){n.readOnly.push(!1);let o=n.oldData[i],s=n.newData[i],l=r.ticks;for(;l+e<E[0].length;){n.readOnly.push(!0),n.oldData.push({x:r.startCol,y:l+e,d:o.d}),n.newData.push({x:r.startCol,y:l+e,d:s.d});for(let f=0;f<s.d.length;f++)E[r.startCol+f][l+e].v=s.d[f];l+=r.ticks}}}function le(t){return ft[Math.floor(t/w.columns.length)]}function kr(t){return w.columns[t%w.columns.length]}function re(t,e){let n={x:t,y:e,d:new Array};for(let r=t;r<t+w.columns.length;r++)n.d.push(E[r][e].v);return n}function ti(t,e){let n={x:e,y:t.tick-1,d:new Array};for(let r of t.data)n.d.push(r);return n}function Oe(t){let e={tick:t.y+1,data:new Array};if(Number.isNaN(t.d[ie.buffer])||Number.isNaN(t.d[ie.semitone]))return e;for(let n=ie.gain;n<w.columns.length;n++)Number.isNaN(t.d[n])&&(t.d[n]=Ve(t.d[0],n));return e.data=t.d,e}function rt(t){let e,n;t.w>0?(e=t.x,n=e+t.w):(e=t.x+t.w,n=e+t.w*-1);let r,a;return t.h>0?(r=t.y,a=r+t.h):(r=t.y+t.h,a=r+t.h*-1),{xStart:e,xEnd:n,yStart:r,yEnd:a}}function Ve(t,e){let n=w.columns[e].default;if(Number.isNaN(t))return n;let r=w.defaults[t][e];return Number.isNaN(r)?n:r}var Le={static:0,follow:1};function ri(t){let e=new an(t);return{data:t,element:e,fn:{activate:()=>{t.controlRouter.set(e.regionNav.currentRegion)},loadSongStep:function(r){e.loadSongStep(r)},getPlayAnimation:()=>e.getPlayAnimation(Le.follow),muteTrack:(r,a)=>{e.muteTrack(r,a)},clearMeters:()=>{e.clearMeters()},transportPause:()=>{e.transportPause()}}}}var an=class extends A{_name="pattern-seq";_markup=`
    <div id="col-1" class="col">
      <div id="masterInfo" class="region"></div>
      <div id="sampleSelector" class="region">
        <h2>Samples</h2>
      </div>
      <div id="songSequencer" class="region">
        <h2>Track</h2>
      </div>
    </div>
    <div id="col-2" class="col">
      <div id="patternInfo" class="region"></div>
      <div id="patternSequencer" class="region"></div>
    </div>
  `;_cssVars={};_css(e){return`
      :host {
        flex-grow: 1;
        min-height: 0;
        display: flex;
        gap: 12px;
      }
      .col {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 204px;
      }
      #col-2 {
        flex-grow: 1;
      }
      .region {
        border: ${e.def.borderThickness} solid ${e.region.bColBorderInActive};
        border-radius: ${e.def.borderRadius};
        background-color: ${e.window.bColBody};
        /* use "flex: 1" to split vertical space evenly */
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow-y: hidden;
      }
      .region > * {
        padding: 6px;
      }
      .region > h2 {
        margin: 0;
        padding: 4px 6px;
        border-bottom: 1px solid ${e.region.bColBorderInActive};
        border-radius: ${e.def.borderRadius};
        font-family: ${e.def.headerFontFamily};
        font-size: 1.2em;
        font-weight: 400;
        // font-style: italic;
        letter-spacing: 0.3rem;
        background-color: ${e.window.bColHead};
        color: ${e.window.colHead};
      }
      .region.active {
        border: ${e.def.borderThickness} solid ${e.region.bColBorderActive};
        // opacity: 1;
      }
      .region.active > h2 {
        border-color: ${e.region.bColBorderActive};
      }
      #masterInfo {
        max-height: 80px;
      }
      #patternInfo {
        max-height: 80px;
        border: ${e.def.borderThickness} solid ${e.def.backgroundColor};
      }
      // #patternInfo > * {
      //   padding: 0;
      // }
      // #sampleSelector:not(.active), #songSequencer:not(.active) {
      //   visibility: collapse;
      // }
    `}_typedData;_patternSequencer;_patternGridEditor;_patternInfo;_masterInfo;_seqStepPatterns;_sectionColMap;_gridPatternData;_readOnlyRegions;regionNav;_regions;constructor(e){super(e)}connectedCallback(){let e={x:0,y:1},n={x:0,y:0};this._applyMarkup(),this._typedData=this._data;let r=this._typedData.audio,a=this._typedData.seqs;a.Sequences.set(0);let i=this._typedData.eventDataColumns;this._regions={};let o=this._typedData.sampleSelector;this._regions.sampleSelector=o,this.element("#sampleSelector").appendChild(o.element);let s=this._typedData.songSequencer;this._regions.songSequencer=s,this.element("#songSequencer").appendChild(s.element),this._masterInfo=Je.get({theme:this._typedData.theme,ac:this._typedData.ac,seqs:this._typedData.seqs,masterGain:this._typedData.audio.masterGain,selectedControlIndex:0,bpm:this._typedData.bpm,gain:this._typedData.audio.masterGain.gain.value*100}),this._regions.masterInfo=this._masterInfo,this.element("#masterInfo").appendChild(this._masterInfo.element);let l={...this._typedData.controlRouter.get("meta"),"*KeyQ ArrowUp":()=>{this.navRegion(0,-1)},"*KeyQ ArrowDown":()=>{this.navRegion(0,1)},"*KeyQ ArrowLeft":()=>{this.navRegion(-1,0)},"*KeyQ ArrowRight":()=>{this.navRegion(1,0)}},f={...l,Space:()=>{a.Transport.running&&this.transportPause()},ArrowUp:this._masterInfo.fn.navUp,ArrowDown:this._masterInfo.fn.navDown,"*KeyF ArrowRight":this._masterInfo.fn.inputInc,"*KeyF ArrowLeft":this._masterInfo.fn.inputDec,"*KeyF ArrowUp":this._masterInfo.fn.inputIncStep,"*KeyF ArrowDown":this._masterInfo.fn.inputDecStep};this._typedData.controlRouter.add("masterInfo",f);let c=this._typedData.controlRouter.get("sampleSelector");c={...c,...l,Space:()=>{a.Transport.running&&this.transportPause()}},this._typedData.controlRouter.add("sampleSelector",c);let u=this._typedData.controlRouter.get("songSequencer");u={...u,...l},this._typedData.controlRouter.add("songSequencer",u),this._loadSongStepData(this._typedData.songStep),this._patternGridEditor=Ar({seqs:a,columns:i,defaults:this._typedData.sampleSelector.data.items,trackCount:0,eventPreview:function(C,X){let P=b._typedData.samples[X[0]].buffer;P&&r.eventPreview_sample(C,X,P)}}),this._patternGridEditor.setData(this._gridPatternData,this._sectionColMap,this._readOnlyRegions,a.Sequences.getStep(0,this._typedData.songStep).ticks),this._patternSequencer=_e.get({theme:this._typedData.theme,gridSize:{w:this._typedData.systemConfig.maxTracks*i.length,h:a.Sequences.getStep(0,this._typedData.songStep).ticks},gridFontSize:this._typedData.theme.def.fontSize,gridCellPadding:{v:3,h:4},gridDividerWidth:2,gridCols:i,gridSelection:{x:0,y:0,w:0,h:0},state:0,cellCoords:n,currentPlayRow:0,loop:{start:Number.NaN,end:Number.NaN},gridEditor:this._patternGridEditor.editor(),setStatus:()=>{},initialData:this._gridPatternData,initialReadOnlyRegions:this._readOnlyRegions,seqs:this._typedData.seqs}),this._regions.patternSequencer=this._patternSequencer,this.element("#patternSequencer").appendChild(this._patternSequencer.element);let b=this;function S(){for(let C=0;C<b._sectionColMap.length;C++){let X=b._sectionColMap[C];if(Number.isNaN(X.id))continue;let P=a.Patterns.getEvent(X.id,b._patternSequencer.data.cellCoords.y+1);if(!P)continue;let Y=b._typedData.samples[P.data.data[0]]?.buffer;Y&&r.eventPreview_sample(C,P.data.data,Y)}}let g={};for(let C=0;C<i.length;C++)g[i[C].id]=C;this._typedData.controlRouter.add("patternSequencer",{...l,Space:()=>{if(a.Transport.running)r.tracks_killAll(),a.Transport.pause(),this._stopPlayAnimation();else{if(this._patternSequencer.data.state==p.select){let C=this._patternSequencer.data.gridSelection;C.h<0?(a.Sequences.setLoop(0,this._typedData.songStep,C.y+C.h+1,0,-C.h,this._typedData.songStep,C.y+C.h+1),this._patternSequencer.data.loop={start:C.y+C.h,end:C.y}):(a.Sequences.setLoop(0,this._typedData.songStep,C.y+1,0,C.h,this._typedData.songStep,C.y+1),this._patternSequencer.data.loop={start:C.y,end:C.y+C.h}),this._patternSequencer.fn.miscDrawLoopMarker(),this._patternSequencer.fn.setState(p.playStatic)}else Number.isNaN(this._patternSequencer.data.loop.start)?a.Sequences.setLoop(0,this._typedData.songStep,1,0,Number.NaN,this._typedData.songStep,1):a.Sequences.setLoop(0,this._typedData.songStep,this._patternSequencer.data.loop.start+1,0,this._patternSequencer.data.loop.end-this._patternSequencer.data.loop.start,this._typedData.songStep,this._patternSequencer.data.loop.start+1);a.Transport.play(),this._startPlayAnimation(Le.static)}},ArrowUp:this._patternSequencer.fn.navUp,ArrowDown:this._patternSequencer.fn.navDown,ArrowLeft:this._patternSequencer.fn.navLeft,ArrowRight:this._patternSequencer.fn.navRight,"*KeyA ArrowUp":this._patternSequencer.fn.navUpEnd,"*KeyA ArrowDown":this._patternSequencer.fn.navDownEnd,"*KeyA ArrowLeft":this._patternSequencer.fn.navLeftEnd,"*KeyA ArrowRight":this._patternSequencer.fn.navRightEnd,"*KeyS ArrowLeft":this._patternSequencer.fn.navLeftTrack,"*KeyS ArrowRight":this._patternSequencer.fn.navRightTrack,"*KeyS ArrowUp":this._patternSequencer.fn.navUpEvent,"*KeyS ArrowDown":this._patternSequencer.fn.navDownEvent,KeyG:this._patternSequencer.fn.selectToggle,"*KeyG ArrowLeft":this._patternSequencer.fn.selectSectionLeft,"*KeyG ArrowRight":this._patternSequencer.fn.selectSectionRight,"*KeyG KeyE":()=>{a.Transport.pause(),a.Sequences.setLoop(0,this._typedData.songStep,1,0,Number.NaN,this._typedData.songStep,1),this._patternSequencer.fn.miscClearLoop(),this._patternSequencer.fn.setState(a.Transport.running?p.playStatic:p.default)},KeyF:this._patternSequencer.fn.inputFill,"*KeyF ArrowUp":()=>{this._patternSequencer.fn.inputIncStep(),this._patternSequencer.data.cellCoords.x%i.length==g.buffer&&o.fn.navRow(i[g.buffer].default)},"*KeyF ArrowDown":()=>{this._patternSequencer.fn.inputDecStep(),this._patternSequencer.data.cellCoords.x%i.length==g.buffer&&o.fn.navRow(i[g.buffer].default)},"*KeyF ArrowLeft":()=>{this._patternSequencer.fn.inputDec(),this._patternSequencer.data.cellCoords.x%i.length==g.buffer&&o.fn.navRow(i[g.buffer].default)},"*KeyF ArrowRight":()=>{this._patternSequencer.fn.inputInc(),this._patternSequencer.data.cellCoords.x%i.length==g.buffer&&o.fn.navRow(i[g.buffer].default)},"-*KeyF":()=>{this._patternSequencer.data.state==p.default&&r.eventPreview_kill()},Digit:C=>{this._patternSequencer.fn.inputDigit(C),this._patternSequencer.data.cellCoords.x%i.length==g.buffer&&o.element.setSelectedItem(i[g.buffer].default)},KeyK:this._patternSequencer.fn.inputKill,KeyI:this._patternSequencer.fn.inputInterpolate,KeyL:this._patternSequencer.fn.inputLength,KeyX:this._patternSequencer.fn.editCut,KeyC:this._patternSequencer.fn.editCopy,KeyV:this._patternSequencer.fn.editPaste,KeyB:this._patternSequencer.fn.editMerge,KeyE:this._patternSequencer.fn.editDelete,"*KeyE ArrowRight":this._patternSequencer.fn.editDeleteMore,"-*KeyE":this._patternSequencer.fn.editDeleteFix,KeyZ:this._patternSequencer.fn.editUndo,KeyY:this._patternSequencer.fn.editRedo,"*KeyM Digit":C=>{this.muteTrack(C-1,r.track_muteToggle(C-1))},"*KeyN Digit":C=>{let X=!0;for(let P=0;P<this._typedData.systemConfig.maxTracks;P++)if(P!=C-1&&!r.tracks[P].muted){X=!1;break}if(X)for(let P=0;P<this._typedData.systemConfig.maxTracks;P++)r.track_mute(P,!1),this.muteTrack(P,!1);else for(let P=0;P<this._typedData.systemConfig.maxTracks;P++)P==C-1?(r.track_mute(P,!1),this.muteTrack(P,!1)):(r.track_mute(P,!0),this.muteTrack(P,!0))},KeyR:()=>{S()},"-*KeyR":()=>{r.eventPreview_kill()},"*KeyR ArrowUp":()=>{this._patternSequencer.fn.navUp(),S()},"*KeyR ArrowDown":()=>{this._patternSequencer.fn.navDown(),S()}}),this._patternInfo=Ze.get({theme:this._typedData.theme,ac:this._typedData.ac,gainNodes:this._typedData.audio.tracks.map(C=>C.gainNode),patternCount:this._typedData.systemConfig.maxTracks,initalPatternData:this._seqStepPatterns.map(C=>C?{id:C.id,name:"",length:C.ticks}:null),setStatus:()=>{}}),this._regions.patternInfo=this._patternInfo,this.element("#patternInfo").appendChild(this._patternInfo.element),this.regionNav=Cr(["masterInfo","sampleSelector","songSequencer","patternInfo","patternSequencer"],[[1,5],[2,5],[3,5]],e),this.navRegion(0,0);let q=this.regionNav.currentRegion;this._regions[q].element.parentElement.classList.add("active"),this._regions[q].fn.activate(),this._typedData.controlRouter.set(q)}navRegion(e,n){let r=this.regionNav.currentRegion,a=this.regionNav.nav(e,n)||"",i=this._regions[r],o=this._regions[a];if(o)switch(i.element.parentElement.classList.remove("active"),i.fn.deactivate(),o.element.parentElement.classList.add("active"),o.fn.activate(),this._typedData.controlRouter.set(o.element.parentElement.id),a){case"patternSequencer":{this._typedData.songSequencer.fn.miscClearLoop(),this._stopPlayAnimation(),this._typedData.seqs.Transport.running?(this._typedData.seqs.Sequences.setLoop(0,this._typedData.songStep,1,0,Number.NaN,Number.NaN,Number.NaN),this._startPlayAnimation(Le.static)):this._typedData.seqs.Sequences.setLoop(0,this._typedData.songStep,1,Number.NaN,Number.NaN,this._typedData.songStep,1);break}case"songSequencer":{this._patternSequencer.fn.miscClearLoop(),this._stopPlayAnimation(),this._typedData.seqs.Transport.running?(this._typedData.seqs.Sequences.setLoop(0,1,1,Number.NaN,Number.NaN,Number.NaN,Number.NaN),this._startPlayAnimation(Le.follow),this._typedData.songSequencer.fn.setState(p.playFollow)):(this._typedData.seqs.Sequences.setLoop(0,1,1,Number.NaN,Number.NaN,this._typedData.songStep,1),this._typedData.songSequencer.fn.setState(p.default));break}}}disconnectedCallback(){}_loadSongStepData(e){if(this._gridPatternData=new Array,this._sectionColMap=new Array,!this._typedData.seqs.Sequences.sequence.steps[e-1])return;let n=this._typedData.seqs.Sequences.getStep(0,e);this._seqStepPatterns=n.patterns.map(a=>a.data);let r=this._typedData.systemConfig.maxTracks*this._typedData.eventDataColumns.length;for(let a=0;a<r;a++){let i=new Array(n.ticks);for(let o=0;o<i.length;o++)i[o]={v:Number.NaN,s:""};this._gridPatternData[a]=i}for(let a=0;a<r;a+=this._typedData.eventDataColumns.length){let i=this._seqStepPatterns[a/this._typedData.eventDataColumns.length];if(i){this._sectionColMap.push({id:i.id,startCol:a,ticks:i.ticks});let o=0;for(;o<n.ticks;)i.events.forEachConditional(s=>{let l=o+s.data.tick;if(l>n.ticks)return!0;for(let f=0;f<s.data.data.length;f++)this._gridPatternData[a+f][l-1]={v:s.data.data[f],s:""};return!1}),o+=i.ticks}else this._sectionColMap.push({id:Number.NaN,startCol:a,ticks:n.ticks})}this._readOnlyRegions=new Array;for(let a of this._sectionColMap)Number.isNaN(a.id)?this._readOnlyRegions.push({x:a.startCol,y:0,w:this._typedData.eventDataColumns.length,h:a.ticks}):a.ticks<n.ticks&&this._readOnlyRegions.push({x:a.startCol,y:a.ticks,w:this._typedData.eventDataColumns.length,h:n.ticks-a.ticks})}_startPlayAnimation(e){let n=this._typedData.songSequencer.fn.getPlayAnimation(Le.follow),r=this._patternSequencer.fn.getPlayAnimation(e),a=()=>{this._typedData.seqs.Transport.doTick(),this._typedData.seqs.Transport.step!=this._typedData.songStep&&(n(this._typedData.seqs.Transport.step-1),this._typedData.songStep=this._typedData.seqs.Transport.step,this.loadSongStep(this._typedData.seqs.Transport.step)),r(this._typedData.seqs.Transport.tick-1),this._patternInfo.fn.drawMeters(),this._masterInfo.fn.drawMeter(),this._typedData.seqs.Transport.running&&(this._typedData.animFrameRequest[0]=window.requestAnimationFrame(a))};this._typedData.animFrameRequest[0]=window.requestAnimationFrame(a)}_stopPlayAnimation(){window.cancelAnimationFrame(this._typedData.animFrameRequest[0]),this._patternSequencer.fn.setState(p.default),this._typedData.songSequencer.fn.setState(p.default),this._patternInfo.fn.clearMeters(),this._masterInfo.fn.clearMeter()}loadSongStep(e){this._loadSongStepData(e),this._patternSequencer.fn.setData(this._gridPatternData,this._readOnlyRegions),this._patternGridEditor.setData(this._gridPatternData,this._sectionColMap,this._readOnlyRegions,this._typedData.seqs.Sequences.getStep(0,e).ticks),this._typedData.seqs.Transport.running||this._patternSequencer.fn.navUpEnd(),this._typedData.songStep=e}getPlayAnimation(e){let n;switch(e){case Le.static:{this._patternSequencer.fn.setState(p.playStatic),n=this._patternSequencer.fn.miscDrawPlayhead;break}case Le.follow:{this._patternSequencer.fn.navUpEnd(),this._patternSequencer.fn.setState(p.playFollow),n=this._patternSequencer.fn.navMoveRow;break}default:{n=this._patternSequencer.fn.miscDrawPlayhead;break}}return(r,a)=>{r!=this._typedData.songStep&&(this._typedData.songStep=r,this.loadSongStep(r)),n(a-1),this._patternInfo.fn.drawMeters(),this._masterInfo.fn.drawMeter()}}muteTrack(e,n){this._patternSequencer.fn.miscMuteTrack(e,n)}clearMeters(){this._patternInfo.fn.clearMeters()}transportPause(){this._typedData.audio.tracks_killAll(),this._typedData.seqs.Transport.pause(),this._stopPlayAnimation(),this._patternSequencer.fn.setState(p.default)}};var it={};B(it,{Element:()=>on,get:()=>ai});function ai(t){let e=new on(t);return{data:t,element:e,fn:{}}}var on=class extends A{_name="sample-editor";_markup=`
    sample editor
  `;_cssVars={};_css(e){return`
      :host {
        width: 100%;
        height: 100%;
        display: flex;
      }
    `}_typedData;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this._typedData=this._data;let e=this._typedData.controlRouter.get("meta");this._typedData.controlRouter.add("sample",{...e}),this._typedData.controlRouter.set("sample")}disconnectedCallback(){this._typedData.controlRouter.remove("sample")}};var ot={};B(ot,{Element:()=>sn,get:()=>ii});function ii(t){let e=new sn(t);return{data:t,element:e,fn:{}}}var sn=class extends A{_name="track-seq";_markup=`
    seq
  `;_cssVars={};_css(e){return`
      :host {
        width: 100%;
        height: 100%;
        display: flex;
      }
    `}_typedData;constructor(e){super(e)}connectedCallback(){this._applyMarkup(),this._typedData=this._data;let e=this._typedData.controlRouter.get("meta");this._typedData.controlRouter.add("seq",{...e}),this._typedData.controlRouter.set("seq")}disconnectedCallback(){this._typedData.controlRouter.remove("seq")}};var Tr=ut.sample,Nr=(t,e)=>{let n=t.createGain();n.connect(t.destination);let r=new Array;for(let o=0;o<e;o++){let s=t.createGain();s.connect(n),r.push({gainNode:s,sourceNode:null,muted:!1})}function a(o,s,l,f){let c={...Tr.args};c.buffer=f,c.semitone=l[1],c.gain=l[2],c.pan=l[3],s.sourceNode&&s.sourceNode.gain.setTargetAtTime(0,o-.01,.03);let u=s.sourceNode=oi(t,Tr.fn(t,o,c),c.gain,c.buffer.numberOfChannels>1);c.pan!=5&&(u=si(t,s.sourceNode,c.pan)),u.connect(s.gainNode)}function i(o,s){s.sourceNode&&s.sourceNode.gain.setTargetAtTime(0,o-.01,.03)}return{masterGain:n,tracks:r,event_sample:(o,s,l,f)=>{a(o,r[s],l,f)},event_kill:o=>{i(t.currentTime,r[o])},eventPreview_sample:(o,s,l)=>{a(t.currentTime,r[o],s,l)},eventPreview_kill:()=>{for(let o of r)i(t.currentTime,o)},track_mute:(o,s)=>{let l=r[o];if(s){if(l.muted)return;l.gainNode.gain.value=0,l.muted=!0}else{if(!l.muted)return;l.gainNode.gain.value=1,l.muted=!1}},track_muteToggle:o=>{let s=r[o];return s.muted?(s.gainNode.gain.value=1,s.muted=!1):(s.gainNode.gain.value=0,s.muted=!0),s.muted},tracks_killAll:()=>{for(let o of r)o.sourceNode&&o.sourceNode.gain.setTargetAtTime(0,t.currentTime,.03)}}};function oi(t,e,n,r){let a=t.createGain();if(a.gain.setValueAtTime(n/100,t.currentTime),r)e.connect(a);else{let i=t.createChannelSplitter(),o=t.createChannelMerger();e.connect(i),i.connect(o,0,0),i.connect(o,0,1),o.connect(a)}return a}function si(t,e,n){let r=t.createStereoPanner();return r.pan.value=n/5-1,e.connect(r),r}var U={maxSamples:50,maxPatterns:100,maxTracks:6,maxSteps:100,defaultPatternLength:32,maxPatternLength:128},qr=["","track-props","track-seq","pattern-seq","sample-editor"],ln=[[0,4,4],[1,1,3]],Mr=["C-","C#","D-","D#","E-","F-","F#","G-","G#","A-","A#","B-"],dn=[{id:"buffer",displayName:"sample",digits:2,min:0,max:U.maxSamples-1,step:10,default:0,chars:2,displayMask:t=>t==666?"*":t.toString().padStart(2,"0")},{id:"semitone",displayName:"note",digits:2,min:0,max:99,step:12,default:48,chars:3,displayMask:t=>t==666?"*":`${Mr[t%12]}${Math.floor(t/12)}`},{id:"gain",displayName:"gain",digits:2,min:0,max:99,step:10,default:99,chars:2,displayMask:t=>t==666?"*":t.toString().padStart(2,"0")},{id:"pan",displayName:"pan",digits:1,min:1,max:9,step:4,default:5,chars:2,displayMask:t=>t==666?"*":t==5?"C0":t>5?`R${(t-5).toString()}`:`L${(5-t).toString()}`}],xe,T,cn;function di(t){let e=new un(t);return{data:t,element:e,fn:{}}}var un=class extends A{_name="track-meta";_markup=`
    <div id="container"></div>
  `;_cssVars={};_css(e){return`
      :host {
        flex-grow: 1;
        max-height: 100%;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      #container {
        flex-grow: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }
    `}_typedData;_audio;_container;_animFrameRequest=[];_currentMetaPos;_currentMetaPage;_metaPages={};_controlRouter;_sampleSelector;_songSequencer;_samples;constructor(e){super(e)}async connectedCallback(){this._typedData=this._data,this._applyMarkup(),cn=this._typedData.db,this._controlRouter=et(),xe=new AudioContext({sampleRate:44100});let e=this._audio=Nr(xe,U.maxTracks);T=jt(xe,(c,u)=>{if(u.event[0]==666)e.event_kill(u.trackId);else{let b=this._samples[u.event[0]]?.buffer;if(!b)return;e.event_sample(c,u.trackId,u.event,b)}},{defaultPatternLength:U.defaultPatternLength}),T.Transport.setBpm(this._typedData.trackData.bpm),this._typedData.trackData=JSON.parse(JSON.stringify(this._typedData.trackData),(c,u)=>u===null?Number.NaN:u);let n=[...this._typedData.trackData.patterns];for(let c=this._typedData.trackData.patterns.length;c<U.maxPatterns;c++)n.push({id:c,dur:U.defaultPatternLength,data:{},events:[]});this._typedData.trackData.patterns=n;let r=this._typedData.trackData.sequences[0];for(let c=r.steps.length;c<U.maxSteps;c++)r.steps.push({ticks:U.defaultPatternLength,patterns:[]});this._typedData.trackData.sequences=[r],T.Data.loadSongData(this._typedData.trackData);let a=Xe.get({theme:this._typedData.theme});await ye.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Loading...",message:`<div>Loading song <br />&lt<b>${this._typedData.trackId}</b>&gt</div>`,fnLoad:async()=>{await this._loadSamples(this._typedData.trackId,this._typedData.trackData.samples,this._typedData.trackType)},fnProgress:()=>0}).fn.load(),dn[0].max=this._samples.length-1;let i=this._samples.map(c=>c.data);this._sampleSelector=Te.get({theme:this._typedData.theme,columns:[dn[0]],columnDisplayMasks:[c=>this._samples[c].name.length?this._samples[c].name:"\u2025",c=>`${Mr[c%12]}${Math.floor(c/12)}`,c=>c.toString().padStart(2,"0"),c=>c.toString().padStart(2,"0")],columnEditable:[()=>!1,c=>!Number.isNaN(c[0]),c=>!Number.isNaN(c[0]),c=>!Number.isNaN(c[0])],items:i,selectedRowIndex:0,selectedColumnIndex:0,editor:Qt({columns:dn,gridData:i,eventPreview:function(c){}}),setStatus:function(){}});let o=new Array;for(let c=0;c<U.maxTracks;c++){let u=new Array;for(let b=0;b<U.maxSteps;b++)u.push({v:Number.NaN,s:""});o.push(u)}for(let c=0;c<r.steps.length;c++)for(let u=0;u<r.steps[c].patterns.length;u++){let b=r.steps[c].patterns[u];o[u][c]={v:b,s:b?b.toString():""}}let s=new Array;for(let c=0;c<U.maxSteps;c++)s.push({v:r.steps[c].ticks,s:""});o.unshift(s);let l=new Array(U.maxTracks).fill({digits:(U.maxPatterns-1).toString().length,chars:2,displayMask:c=>c.toString().padStart(2,"0")});l.unshift({digits:3,chars:3,displayMask:c=>c.toString().padStart(3,"0")}),this._songSequencer=_e.get({theme:this._typedData.theme,gridSize:{w:U.maxTracks+1,h:100},gridFontSize:this._typedData.theme.def.fontSize,gridCellPadding:{v:3,h:4},gridDividerWidth:0,gridCols:l,gridSelection:{x:0,y:0,w:0,h:0},state:0,cellCoords:{x:0,y:0},currentPlayRow:0,loop:{start:Number.NaN,end:Number.NaN},gridEditor:_r({columns:[{id:"",digits:3,min:1,max:U.maxPatternLength,step:8,default:U.defaultPatternLength},{id:"",digits:(U.maxPatterns-1).toString().length,min:0,max:U.maxPatterns-1,step:10,default:0}],gridData:o.map(c=>c.map(u=>u.v)),seqs:T,seqId:0}),setStatus:()=>{},initialData:o,initialReadOnlyRegions:[],seqs:T});let f={Escape:()=>{if(T.Transport.running){let u=this._metaPages["pattern-seq"];e.tracks_killAll(),T.Transport.pause(),u.fn.clearMeters(),this._currentMetaPage=="pattern-seq"&&(window.cancelAnimationFrame(this._animFrameRequest[0]),u.fn.transportPause())}let c=Ne.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Track menu",items:[{text:"Save",fn:async()=>{let u,b;if(this._typedData.trackData.demo){if(b=await Re.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Save demo track as",confirm:"Save track",cancel:"Cancel",validation:[{func:S=>!!S.length,message:"Track name cannot be empty"},{func:async S=>!(await this._typedData.db.tracks_getAllUser()).filter(q=>q.id==S).length,message:"Track name must be unique"}],placeholder:"Track name",value:"",maxLength:20}).fn.prompt(),!b.length)return;u=!0}else u=await J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Save track",message:`<div>Save track &lt<b>${this._typedData.trackId}</b>&gt to browser storage?</div><div style="margin-top: 6px; font-size: .9rem;"><i>Remember that browser storage is volatile... If you clear your browser data you will lose your tracks!</i></div>`,confirm:"Save track",cancel:"Cancel"}).fn.confirm(),b=this._typedData.trackId;u&&await this._saveTrackData(b)}},{text:"Organise track",fn:()=>{Ne.get({theme:this._typedData.theme,controlRouter:this._controlRouter,size:{w:250,h:150},header:"Organise track",items:[{text:"Organise patterns",fn:()=>{T.Sequences.organisePatterns(0);let u=T.Sequences.sequence;for(let b=0;b<u.steps.length;b++)for(let S=0;S<u.steps[b].patterns.length;S++){let g=Number.NaN,q=u.steps[b].patterns[S];q&&q.data!=null&&q.data.id!=null&&(g=q.data.id),o[S+1][b]={v:g,s:g?g.toString():""}}this._songSequencer.fn.setData(o,[]),this._songSequencer.fn.navUpEnd(),J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Done",message:"Patterns organised",confirm:"Continue",cancel:""}).fn.confirm()}},{text:"Organise samples",fn:()=>{let u=new Array,b=0;for(let S=0;S<this._samples.length;S++)if(this._samples[S].buffer){if(S!=b){let g=this._samples[S];this._samples[b]={id:g.id,name:g.name,data:[b,g.data[1],g.data[2],g.data[3]],buffer:g.buffer},this._samples[S]={id:"",name:"",data:[S,Number.NaN,Number.NaN,Number.NaN],buffer:null},u.push([S,b])}b++}for(let S=0;S<this._samples.length;S++)this._sampleSelector.fn.updateValue(S,0,S);for(let S of T.Patterns.all)S.events.forEach(g=>{let q=u.find(C=>C[0]==g.data[0]);q&&(g.data[0]=q[1])});this._patternSeq_updatePattern(),J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Done",message:"Samples organised",confirm:"Continue",cancel:""}).fn.confirm()}}]}).fn.activate()}},{text:"Export to wav",fn:async()=>{let u=Qe.get({theme:this._typedData.theme,controlRouter:this._controlRouter,startStep:0,endStep:0});await u.fn.confirm()&&await this._renderTrackAudio(u.data.startStep,u.data.endStep)}},{text:"Exit",fn:async()=>{await J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Exit",message:"Exit to main menu? Any unsaved changes will be lost.",confirm:"Exit",cancel:"Cancel"}).fn.confirm()&&(c.fn.deactivate(),T.Transport.pause(),this.dispatchEvent(new CustomEvent("exit")))}}]});c.fn.activate()}};this._controlRouter.add("meta",f),this._controlRouter.set("meta"),this._controlRouter.add("sampleSelector",{ArrowUp:()=>{this._sampleSelector.fn.navUp(),this._sampleSelector.data.columns[0].default=this._sampleSelector.data.selectedRowIndex},ArrowDown:()=>{this._sampleSelector.fn.navDown(),this._sampleSelector.data.columns[0].default=this._sampleSelector.data.selectedRowIndex},ArrowLeft:()=>{this._sampleSelector.fn.navLeft(),this._sampleSelector.data.columns[0].default=this._sampleSelector.data.selectedRowIndex},ArrowRight:()=>{this._sampleSelector.fn.navRight(),this._sampleSelector.data.columns[0].default=this._sampleSelector.data.selectedRowIndex},"*KeyA ArrowUp":()=>{this._sampleSelector.fn.navTop(),this._sampleSelector.data.columns[0].default=this._sampleSelector.data.selectedRowIndex},"*KeyA ArrowDown":()=>{this._sampleSelector.fn.navBottom(),this._sampleSelector.data.columns[0].default=this._sampleSelector.data.selectedRowIndex},KeyE:async()=>{let c=this._sampleSelector.data.items[this._sampleSelector.data.selectedRowIndex][this._sampleSelector.data.selectedColumnIndex];if(!Number.isNaN(c)&&this._sampleSelector.data.selectedColumnIndex==0){let u=this._samples[this._sampleSelector.data.selectedRowIndex];if(!await J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Delete sample",message:`<div>Are you sure you want to delete sample<br />&lt<b>${u.name}</b>&gt?</div>`,confirm:"Delete sample",cancel:"Cancel"}).fn.confirm())return;u.buffer=null,this._sampleSelector.fn.editDelete()}},KeyF:async()=>{let c=this._sampleSelector.data.items[this._sampleSelector.data.selectedRowIndex][0],u=await a.fn.input();if(!u)return;if(u.size>2e6){J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Sample too large",message:"Max sample size is 2MB!",confirm:"Confirm",cancel:""}).fn.confirm();return}let b=this._samples[this._sampleSelector.data.selectedRowIndex],S=await Re.get({controlRouter:this._controlRouter,header:c==666?"Add sample":`Replace sample <${b.name}>`,confirm:c==666?"Add sample":"Replace sample",cancel:"Cancel",theme:this._typedData.theme,placeholder:"Sample name",value:u.name,maxLength:20,validation:[{func:q=>!!q.length,message:"Sample name cannot be empty"},{func:q=>q==b.name||!this._samples.find(C=>C.name==q),message:"Sample name must be unique"}]}).fn.prompt();if(!S)return;let g=this._samples[this._sampleSelector.data.selectedRowIndex];g.name=S,g.buffer=await xe.decodeAudioData(await u.arrayBuffer()),b.id==""&&(g.id=Gn()),this._sampleSelector.fn.updateValue(this._sampleSelector.data.selectedRowIndex,0,this._sampleSelector.data.selectedRowIndex)}}),this._controlRouter.add("songSequencer",{Space:()=>{let c=this._metaPages["pattern-seq"];if(T.Transport.running)e.tracks_killAll(),T.Transport.pause(),c.fn.clearMeters(),this._currentMetaPage=="pattern-seq"&&(window.cancelAnimationFrame(this._animFrameRequest[0]),c.fn.transportPause());else if(this._currentMetaPage=="pattern-seq"){if(this._songSequencer.data.state==p.select){let g=this._songSequencer.data.gridSelection;g.h<0?(T.Sequences.setLoop(0,g.y+g.h+1,1,-g.h,Number.NaN,g.y+g.h+1,1),this._songSequencer.data.loop={start:g.y+g.h,end:-g.h},c.fn.loadSongStep(g.y+g.h+1)):(T.Sequences.setLoop(0,g.y+1,1,g.h,Number.NaN,g.y+1,1),this._songSequencer.data.loop={start:g.y,end:g.y+g.h},c.fn.loadSongStep(g.y+1)),this._songSequencer.fn.miscDrawLoopMarker()}else Number.isNaN(this._songSequencer.data.loop.start)?T.Sequences.setLoop(0,1,1,Number.NaN,Number.NaN,this._songSequencer.data.cellCoords.y+1,1):T.Sequences.setLoop(0,this._songSequencer.data.loop.start+1,1,this._songSequencer.data.loop.end-this._songSequencer.data.loop.start,Number.NaN,this._songSequencer.data.loop.start+1,1);let u=this._songSequencer.fn.getPlayAnimation(kt.follow),b=c.fn.getPlayAnimation(),S=()=>{T.Transport.doTick(),b(T.Transport.step,T.Transport.tick),u(T.Transport.step-1),T.Transport.running&&(this._animFrameRequest[0]=window.requestAnimationFrame(S))};this._animFrameRequest[0]=window.requestAnimationFrame(S),T.Transport.play()}},ArrowUp:()=>{T.Transport.running||(this._songSequencer.fn.navUp(),this._currentMetaPage=="pattern-seq"&&this._patternSeq_updatePattern())},ArrowDown:()=>{T.Transport.running||(this._songSequencer.fn.navDown(),this._currentMetaPage=="pattern-seq"&&this._patternSeq_updatePattern())},ArrowLeft:this._songSequencer.fn.navLeft,ArrowRight:this._songSequencer.fn.navRight,"*KeyA ArrowUp":()=>{this._songSequencer.fn.navUpEnd(),this._currentMetaPage=="pattern-seq"&&this._patternSeq_updatePattern()},"*KeyA ArrowDown":()=>{this._songSequencer.fn.navDownEnd(),this._currentMetaPage=="pattern-seq"&&this._patternSeq_updatePattern()},"*KeyA ArrowLeft":this._songSequencer.fn.navLeftEnd,"*KeyA ArrowRight":this._songSequencer.fn.navRightEnd,KeyF:()=>{this._songSequencer.fn.inputFill()&&this._patternSeq_updatePattern()},"*KeyF ArrowRight":()=>{this._songSequencer.fn.inputInc(),this._patternSeq_updatePattern()},"*KeyF ArrowLeft":()=>{this._songSequencer.fn.inputDec(),this._patternSeq_updatePattern()},"*KeyF ArrowUp":()=>{this._songSequencer.fn.inputIncStep(),this._patternSeq_updatePattern()},"*KeyF ArrowDown":()=>{this._songSequencer.fn.inputDecStep(),this._patternSeq_updatePattern()},"*KeyF KeyJ":()=>{this._songSequencer.fn.inputValue(T.Patterns.getNextEmpty()),this._patternSeq_updatePattern()},"*KeyF KeyK":()=>{let c=T.Patterns.getNextEmpty();T.Patterns.copy(this._songSequencer.fn.currentValue(),c),this._songSequencer.fn.inputValue(c),this._patternSeq_updatePattern()},KeyE:()=>{this._songSequencer.fn.editDelete(),this._patternSeq_updatePattern()},"*KeyE ArrowRight":()=>{this._songSequencer.fn.editDeleteMore(),this._patternSeq_updatePattern()},"-*KeyE":this._songSequencer.fn.editDeleteFix,KeyX:()=>{this._songSequencer.fn.editCut(),this._patternSeq_updatePattern()},KeyC:this._songSequencer.fn.editCopy,KeyV:()=>{this._songSequencer.fn.editPaste(),this._patternSeq_updatePattern()},KeyZ:()=>{this._songSequencer.fn.editUndo(),this._patternSeq_updatePattern()},KeyY:()=>{this._songSequencer.fn.editRedo(),this._patternSeq_updatePattern()},KeyG:this._songSequencer.fn.selectToggle,"*KeyG KeyE":()=>{this._songSequencer.fn.miscClearLoop(),T.Transport.pause(),T.Sequences.setLoop(0,1,1,Number.NaN,Number.NaN,1,1),this._songSequencer.fn.setState(T.Transport.running?p.playStatic:p.default)},"*KeyM Digit":c=>{this._metaPages["pattern-seq"].fn.muteTrack(c-1,e.track_muteToggle(c-1))},"*KeyN Digit":c=>{let u=!0;for(let b=0;b<U.maxTracks;b++)if(b!=c-1&&!e.tracks[b].muted){u=!1;break}if(u)for(let b=0;b<U.maxTracks;b++)e.track_mute(b,!1),this._metaPages["pattern-seq"].fn.muteTrack(b,!1);else for(let b=0;b<U.maxTracks;b++)b==c-1?(e.track_mute(b,!1),this._metaPages["pattern-seq"].fn.muteTrack(b,!1)):(e.track_mute(b,!0),this._metaPages["pattern-seq"].fn.muteTrack(b,!0))}}),this._container=this.element("#container"),this._patternSeq_load(),this._trackProps_load(),this._currentMetaPos={x:2,y:1},this._currentMetaPage="pattern-seq",this._metaPages["pattern-seq"].element.style.display="flex",window.addEventListener("beforeunload",async c=>{c.preventDefault()})}disconnectedCallback(){this._controlRouter.close()}_navMetaPage(e,n){let r={x:this._currentMetaPos.x+e,y:this._currentMetaPos.y+n};if(r.x<0||r.x>ln[0].length-1||r.y<0||r.y>ln.length-1)return;let a=qr[ln[r.y][r.x]];a&&a!=this._currentMetaPage&&(this._metaPages[this._currentMetaPage].element.style.display="none",this._currentMetaPos=r,this._currentMetaPage=qr[ln[this._currentMetaPos.y][this._currentMetaPos.x]],this._metaPages[this._currentMetaPage].element.style.display="flex",this._metaPages[this._currentMetaPage].fn.activate())}_trackProps_load(){}_trackSeq_load(){this._container.innerHTML="",this._container.appendChild(ot.get({theme:this._typedData.theme,controlRouter:this._controlRouter,songData:this._typedData.trackData}).element)}_patternSeq_load(){this._metaPages["pattern-seq"]=at.get({theme:this._typedData.theme,systemConfig:U,ac:xe,seqs:T,audio:this._audio,samples:this._samples,bpm:this._typedData.trackData.bpm,songStep:this._songSequencer.data.cellCoords.y+1,controlRouter:this._controlRouter,sampleSelector:this._sampleSelector,songSequencer:this._songSequencer,eventDataColumns:dn,animFrameRequest:this._animFrameRequest}),this._container.appendChild(this._metaPages["pattern-seq"].element),this._metaPages["pattern-seq"].element.style.display="none"}_patternSeq_updatePattern(){this._metaPages["pattern-seq"].fn.loadSongStep(this._songSequencer.data.cellCoords.y+1)}_sampleEditor_load(){this._container.innerHTML="",this._container.appendChild(it.get({theme:this._typedData.theme,controlRouter:this._controlRouter,buffer:new AudioBuffer({length:1,sampleRate:44100})}).element)}async _loadSamples(e,n,r){this._samples=new Array(n.length);for(let i=0;i<this._samples.length;i++)this._samples[i]={id:"",name:"",data:[Number.NaN,Number.NaN,Number.NaN,Number.NaN],buffer:null};for(let i=0;i<n.length;i++)this._samples[i]={...n[i],buffer:null};if(r=="demo")for(let i of this._samples){if(i.name=="")continue;let s=await(await fetch(`demo/samples/${e}/${i.name}.wav`)).arrayBuffer();i.buffer=await xe.decodeAudioData(s)}else{let i=await cn.samples_getByIds(n.filter(o=>o.id!="").map(o=>o.id));for(let o of this._samples){if(o.id=="")continue;let s=i.find(l=>l.id==o.id);s&&(o.buffer=xe.createBuffer(s.data.channels,s.data.pcm[0].length,s.data.sampleRate),o.buffer.copyToChannel(s.data.pcm[0],0),s.data.channels>1&&o.buffer.copyToChannel(s.data.pcm[1],1))}}let a=0;for(this._samples.length&&(a=this._samples[this._samples.length-1].data[0]+1);this._samples.length<U.maxSamples;)this._samples.push({id:"",name:"",data:[a++,Number.NaN,Number.NaN,Number.NaN],buffer:null})}async _saveTrackData(e){let n=this;async function r(){let a=[];for(let o of n._samples){if(!o.buffer){o.id&&await cn.samples_delete(o.id);continue}let s=[o.buffer.getChannelData(0)];o.buffer.numberOfChannels>1&&s.push(o.buffer.getChannelData(1)),a.push({id:o.id,data:{name:o.name,channels:o.buffer.numberOfChannels,sampleRate:o.buffer.sampleRate,pcm:s}})}let i={demo:!1,bpm:T.Transport.bpm,samples:n._samples.map(o=>({id:o.id,name:o.name,data:o.data})),instruments:n._typedData.trackData.instruments,...T.Data.getTrackData()};await cn.tracks_put(e,i,a,n._typedData.trackCreated),n._typedData.trackType="user",n._typedData.trackId=e,n._typedData.trackData=i}await ye.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Saving...",message:`<div>Saving track <br />&lt<b>${e}</b>&gt</div>`,fnLoad:async()=>{await r()},fnProgress:()=>0}).fn.load().then(()=>{J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Track saved",message:`<div>Track &lt<b>${e}</b>&gt saved successfully</div>`,confirm:"Continue",cancel:""}).fn.confirm()}).catch(async a=>{await ke.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Error",message:"Can't save track data",error:a}).fn.alert()})}async _renderTrackAudio(e,n){T.Sequences.setLoop(0,e,1,n-e,Number.NaN,e,Number.NaN);let r=T.Sequences.getStep(0,n).ticks,a=T.Sequences.getLoopLength(0)+.5,i,o=this;async function s(){return await xe.audioWorklet.addModule("./src/components/worklets/recorder.js"),i=new window.AudioWorkletNode(xe,"recorder-worklet",{processorOptions:{length:a}}),o._audio.masterGain.connect(i),new Promise((f,c)=>{i.port.onmessage=b=>{if(b.data.eventType=="data"){let S=b.data.audioBuffer;o._audio.masterGain.disconnect(i);let g=xe.createBuffer(2,S[0].length,xe.sampleRate);g.copyToChannel(S[0],0),g.copyToChannel(S[1],1);let q=ci(g,g.length),C=document.createElement("a");C.href=URL.createObjectURL(q),C.download=o._typedData.trackId,C.click(),f()}};let u=()=>{T.Transport.doTick(),(T.Transport.step<n||T.Transport.tick<r)&&(o._animFrameRequest[0]=window.requestAnimationFrame(u))};o._animFrameRequest[0]=window.requestAnimationFrame(u),T.Transport.play(!1),i.port.postMessage({message:"START"})}).catch(f=>{throw T.Transport.pause(),f})}let l=0;await ye.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Exporting...",message:`<div>Exporting track<br />&lt<b>${this._typedData.trackId}</b>&gt</div>`,fnLoad:async()=>{await s()},fnProgress:f=>(l+=f/1e3,Math.round(l/a*100)),cancel:!0}).fn.load().then(()=>{J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Track exported",message:`<div>Track &lt<b>${this._typedData.trackId}</b>&gt exported successfully</div>`,confirm:"Continue",cancel:""}).fn.confirm()}).catch(async f=>{f=="cancel"?(T.Transport.pause(),i.port.postMessage({message:"STOP"}),J.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Cancelled",message:"<div>Track export cancelled</div>",confirm:"Continue",cancel:""}).fn.confirm()):await ke.get({theme:this._typedData.theme,controlRouter:this._controlRouter,header:"Error",message:"Can't export track data",error:f}).fn.alert()})}};function ci(t,e){let n=e*t.numberOfChannels*2+44,r=new ArrayBuffer(n),a=new DataView(r),i=new Array,o=0;function s(c){a.setUint16(o,c,!0),o+=2}function l(c){a.setUint32(o,c,!0),o+=4}l(1179011410),l(n-8),l(1163280727),l(544501094),l(16),s(1),s(t.numberOfChannels),l(t.sampleRate),l(t.sampleRate*2*t.numberOfChannels),s(t.numberOfChannels*2),s(16),l(1635017060),l(n-4);for(let c=0;c<t.numberOfChannels;c++)i.push(t.getChannelData(c));let f=0;for(;o<n;){for(let c=0;c<t.numberOfChannels;c++){let u=Math.max(-1,Math.min(1,i[c][f]));u=(.5+u<0?u*32768:u*32767)|0,a.setInt16(o,u,!0),o+=2}f++}return new Blob([r],{type:"audio/wav"})}var mi="[SE] ERROR ->",Gr={"page-track-select":Xt.Element,"page-track-meta":mn.Element,"page-main":en.Element},pi={"comp-track-seq":ot.Element,"comp-track-pattern":at.Element,"comp-track-sample":it.Element,"comp-window":V.Element,"comp-prompt":je.Element,"comp-modal":Q.Element,"comp-modal-prompt":Re.Element,"comp-modal-confirm":J.Element,"comp-modal-loading":ye.Element,"comp-modal-error":ke.Element,"comp-modal-menu":Ne.Element,"comp-modal-render":Qe.Element,"comp-file-input":Xe.Element,"comp-list-selector":Ce.Element,"comp-grid-selector":Te.Element,"comp-canvas-grid":_e.Element,"comp-pattern-info":Ze.Element,"comp-master-info":Je.Element,"comp-status-bar":zt.Element,"comp-meter":Ye.Element,"comp-scope":Ie.Element,"comp-control-number":Se.Element},gt={},Wn="",hi="#app",pn,hn,fn;document.fonts.ready.then(fi);async function fi(){try{pn=document.querySelector(hi),fn=await Hn(),hn=Vn("dark",pn.style),Lr(Gr),Lr(pi),await $n("page-track-select",{db:fn,theme:hn})}catch(t){console.error(t),window.alert(`${mi} ${t.message}`)}}async function Br(t){let e=t.detail,n={theme:hn,trackType:e.type,trackId:e.data.id,trackData:e.data.data,trackCreated:e.data.created,db:fn};await $n("page-track-meta",n),gt["page-track-select"].removeEventListener("track-selected",Br),gt["page-track-meta"].addEventListener("exit",()=>{$n("page-track-select",{db:fn,theme:hn})})}function Lr(t){for(let[e,n]of Object.entries(t)){if(window.customElements.get(e))throw new Error(`Component [${e}] is already defined`);window.customElements.define(e,n)}}async function $n(t,e){Wn&&pn.removeChild(gt[Wn]);let n=new Gr[t](e);switch(await pn.appendChild(n),gt[t]=n,Wn=t,t){case"page-track-select":{gt["page-track-select"].addEventListener("track-selected",Br);break}}}})();
